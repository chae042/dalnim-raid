<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë‹¬ ê¸¸ë“œ ë ˆì´ë“œ ì¼ì •</title>
    <style>
        * {
            box-sizing: border-box;
            font-family: 'Malgun Gothic', sans-serif;
        }
        body {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            color: #fff;
        }
        .container {
            max-width: 500px;
            margin: 0 auto;
        }
        h1 {
            text-align: center;
            color: #ffd700;
            margin-bottom: 30px;
            font-size: 28px;
        }
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-radius: 10px;
            overflow: hidden;
        }
        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            background: #2a2a4a;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            transition: background 0.3s;
        }
        .tab:hover {
            background: #3a3a5a;
        }
        .tab.active {
            background: #4a4a7a;
            color: #ffd700;
        }
        .panel {
            display: none;
            background: #2a2a4a;
            padding: 25px;
            border-radius: 15px;
        }
        .panel.active {
            display: block;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-size: 16px;
            color: #ccc;
        }
        input[type="text"] {
            width: 100%;
            padding: 15px;
            font-size: 18px;
            border: none;
            border-radius: 8px;
            background: #1a1a2e;
            color: #fff;
        }
        select {
            width: 100%;
            padding: 15px;
            font-size: 18px;
            border: none;
            border-radius: 8px;
            background: #1a1a2e;
            color: #fff;
        }
        .day-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        .day-btn {
            padding: 12px 18px;
            font-size: 16px;
            border: 2px solid #4a4a7a;
            border-radius: 8px;
            background: transparent;
            color: #fff;
            cursor: pointer;
            transition: all 0.3s;
        }
        .day-btn:hover {
            border-color: #ffd700;
        }
        .day-btn.selected {
            background: #ff6b6b;
            border-color: #ff6b6b;
            color: #fff;
        }
        .submit-btn {
            width: 100%;
            padding: 18px;
            font-size: 20px;
            font-weight: bold;
            border: none;
            border-radius: 10px;
            background: linear-gradient(135deg, #ffd700 0%, #ffaa00 100%);
            color: #1a1a2e;
            cursor: pointer;
            margin-top: 20px;
            transition: transform 0.2s;
        }
        .submit-btn:hover {
            transform: scale(1.02);
        }
        .submit-btn:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
        }
        .search-box {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .search-box input {
            flex: 1;
        }
        .search-btn {
            padding: 15px 25px;
            font-size: 16px;
            border: none;
            border-radius: 8px;
            background: #4a4a7a;
            color: #fff;
            cursor: pointer;
        }
        .message {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
            font-size: 16px;
        }
        .message.success {
            background: #2ecc71;
        }
        .message.error {
            background: #e74c3c;
        }
        .message.info {
            background: #3498db;
        }
        /* ì¼ì • ë³´ê¸° í…Œì´ë¸” */
        .schedule-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        .schedule-table th, .schedule-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #3a3a5a;
        }
        .schedule-table th {
            background: #1a1a2e;
            color: #ffd700;
        }
        .job-chip {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: bold;
        }
        .job-ìˆ˜í˜¸ì„± { background: #60a5fa; color: #000; }
        .job-ê²€ì„± { background: #f87171; color: #000; }
        .job-ê¶ì„± { background: #fb923c; color: #000; }
        .job-ë§ˆë„ì„± { background: #c084fc; color: #000; }
        .job-ì¹˜ìœ ì„± { background: #4ade80; color: #000; }
        .job-í˜¸ë²•ì„± { background: #facc15; color: #000; }
        .job-ì‚´ì„± { background: #ec4899; color: #000; }
        .job-ì •ë ¹ì„± { background: #14b8a6; color: #000; }
        .named-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
            margin-left: 5px;
        }
        .named-1ë„´ { background: #3b82f6; }
        .named-2ë„´ { background: #8b5cf6; }
        .loading {
            text-align: center;
            padding: 40px;
            color: #888;
        }
        .player-card {
            background: #1a1a2e;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
        }
        .player-name {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 8px;
        }
        .player-info {
            font-size: 14px;
            color: #aaa;
        }
        .cant-days {
            color: #ff6b6b;
            font-size: 13px;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸŒ™ ë‹¬ ê¸¸ë“œ ë ˆì´ë“œ</h1>
        
        <div class="tabs">
            <div class="tab active" onclick="showTab('register')">ë“±ë¡/ìˆ˜ì •</div>
            <div class="tab" onclick="showTab('view')">ì¼ì • ë³´ê¸°</div>
        </div>

        <!-- ë“±ë¡/ìˆ˜ì • íŒ¨ë„ -->
        <div id="register-panel" class="panel active">
            <div id="register-message"></div>
            
            <div class="form-group">
                <label>ë‹‰ë„¤ì„ *</label>
                <div class="search-box">
                    <input type="text" id="nickname" placeholder="ìºë¦­í„° ì´ë¦„">
                    <button class="search-btn" onclick="loadMyInfo()">ë¶ˆëŸ¬ì˜¤ê¸°</button>
                </div>
            </div>

            <div class="form-group">
                <label>ì§ì—… *</label>
                <select id="job">
                    <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                    <option value="ìˆ˜í˜¸ì„±">ìˆ˜í˜¸ì„±</option>
                    <option value="ê²€ì„±">ê²€ì„±</option>
                    <option value="ê¶ì„±">ê¶ì„±</option>
                    <option value="ë§ˆë„ì„±">ë§ˆë„ì„±</option>
                    <option value="ì¹˜ìœ ì„±">ì¹˜ìœ ì„±</option>
                    <option value="í˜¸ë²•ì„±">í˜¸ë²•ì„±</option>
                    <option value="ì‚´ì„±">ì‚´ì„±</option>
                    <option value="ì •ë ¹ì„±">ì •ë ¹ì„±</option>
                </select>
            </div>

            <div class="form-group">
                <label>ë„¤ì„ë“œ</label>
                <select id="named">
                    <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                    <option value="1ë„´">1ë„´</option>
                    <option value="2ë„´">2ë„´</option>
                </select>
            </div>

            <div class="form-group">
                <label>ì‹œì‘ ê°€ëŠ¥ ì‹œê°„</label>
                <select id="startTime">
                    <option value="ìƒê´€ì—†ìŒ">ìƒê´€ì—†ìŒ</option>
                    <option value="PM 6">PM 6</option>
                    <option value="PM 7">PM 7</option>
                    <option value="PM 8">PM 8</option>
                    <option value="PM 9">PM 9</option>
                    <option value="PM 10">PM 10</option>
                    <option value="PM 11">PM 11</option>
                    <option value="AM 12">AM 12</option>
                    <option value="AM 1">AM 1</option>
                    <option value="AM 2">AM 2</option>
                </select>
            </div>

            <div class="form-group">
                <label>ì¢…ë£Œ ê°€ëŠ¥ ì‹œê°„</label>
                <select id="endTime">
                    <option value="ìƒê´€ì—†ìŒ">ìƒê´€ì—†ìŒ</option>
                    <option value="PM 6">PM 6</option>
                    <option value="PM 7">PM 7</option>
                    <option value="PM 8">PM 8</option>
                    <option value="PM 9">PM 9</option>
                    <option value="PM 10">PM 10</option>
                    <option value="PM 11">PM 11</option>
                    <option value="AM 12">AM 12</option>
                    <option value="AM 1">AM 1</option>
                    <option value="AM 2">AM 2</option>
                </select>
            </div>

            <div class="form-group">
                <label>ë ˆì´ë“œ ì¢…ë¥˜</label>
                <select id="raidType">
                    <option value="íŠ¸ë¼ì´íŒŸ">íŠ¸ë¼ì´íŒŸ</option>
                    <option value="í´ë¦¬ì–´íŒŸ">í´ë¦¬ì–´íŒŸ</option>
                </select>
            </div>

            <div class="form-group">
                <label>ëª»í•˜ëŠ” ìš”ì¼ (í´ë¦­í•´ì„œ ì„ íƒ)</label>
                <div class="day-buttons">
                    <button type="button" class="day-btn" data-day="ì›”">ì›”</button>
                    <button type="button" class="day-btn" data-day="í™”">í™”</button>
                    <button type="button" class="day-btn" data-day="ìˆ˜">ìˆ˜</button>
                    <button type="button" class="day-btn" data-day="ëª©">ëª©</button>
                    <button type="button" class="day-btn" data-day="ê¸ˆ">ê¸ˆ</button>
                    <button type="button" class="day-btn" data-day="í† ">í† </button>
                    <button type="button" class="day-btn" data-day="ì¼">ì¼</button>
                </div>
            </div>

            <div class="form-group">
                <label>ì°¸ê³ ì‚¬í•­</label>
                <input type="text" id="note" placeholder="ì˜ˆ: ê¸ˆí† ë§Œ ê°€ëŠ¥, 24ì‹œ ì´ì „ ì„ í˜¸">
            </div>

            <button class="submit-btn" onclick="submitForm()">ì €ì¥í•˜ê¸°</button>
        </div>

        <!-- ì¼ì • ë³´ê¸° íŒ¨ë„ -->
        <div id="view-panel" class="panel">
            <div id="view-message"></div>
            <div id="player-list" class="loading">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
        </div>
    </div>

    <script>
        const WEBHOOK_URL = 'https://n8n-production-f0a7.up.railway.app/webhook/raid';

        // íƒ­ ì „í™˜
        function showTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
            
            document.querySelector(`.tab:nth-child(${tabName === 'register' ? 1 : 2})`).classList.add('active');
            document.getElementById(`${tabName}-panel`).classList.add('active');
            
            if (tabName === 'view') {
                loadPlayerList();
            }
        }

        // ìš”ì¼ ë²„íŠ¼ í† ê¸€
        document.querySelectorAll('.day-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                btn.classList.toggle('selected');
            });
        });

        // ì„ íƒëœ ëª»í•˜ëŠ” ìš”ì¼ ê°€ì ¸ì˜¤ê¸°
        function getSelectedDays() {
            const days = [];
            document.querySelectorAll('.day-btn.selected').forEach(btn => {
                days.push(btn.dataset.day);
            });
            return days;
        }

        // ë©”ì‹œì§€ í‘œì‹œ
        function showMessage(elementId, type, text) {
            const el = document.getElementById(elementId);
            el.innerHTML = `<div class="message ${type}">${text}</div>`;
            setTimeout(() => { el.innerHTML = ''; }, 5000);
        }

        // ë‚´ ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸°
        async function loadMyInfo() {
            const nickname = document.getElementById('nickname').value.trim();
            if (!nickname) {
                showMessage('register-message', 'error', 'ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”');
                return;
            }

            try {
                const response = await fetch(WEBHOOK_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'get', data: { ë‹‰ë„¤ì„: nickname } })
                });
                const result = await response.json();
                
                if (result.success && result.data) {
                    const d = result.data;
                    document.getElementById('job').value = d.ì§ì—… || '';
                    document.getElementById('named').value = d.ë„¤ì„ë“œ || '';
                    document.getElementById('startTime').value = d.ì‹œì‘ì‹œê°„ || 'ìƒê´€ì—†ìŒ';
                    document.getElementById('endTime').value = d.ì¢…ë£Œì‹œê°„ || 'ìƒê´€ì—†ìŒ';
                    document.getElementById('raidType').value = d.ë ˆì´ë“œì¢…ë¥˜ || 'íŠ¸ë¼ì´íŒŸ';
                    document.getElementById('note').value = d.ì°¸ê³ ì‚¬í•­ || '';
                    
                    // ëª»í•˜ëŠ” ìš”ì¼ ì„¤ì •
                    document.querySelectorAll('.day-btn').forEach(btn => {
                        btn.classList.remove('selected');
                        if (d.ëª»í•˜ëŠ”ìš”ì¼ && d.ëª»í•˜ëŠ”ìš”ì¼.includes(btn.dataset.day)) {
                            btn.classList.add('selected');
                        }
                    });
                    
                    showMessage('register-message', 'success', 'ì •ë³´ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤');
                } else {
                    showMessage('register-message', 'info', 'ë“±ë¡ëœ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤. ìƒˆë¡œ ë“±ë¡í•´ì£¼ì„¸ìš”.');
                }
            } catch (error) {
                showMessage('register-message', 'error', 'ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ' + error.message);
            }
        }

        // í¼ ì œì¶œ
        async function submitForm() {
            const nickname = document.getElementById('nickname').value.trim();
            const job = document.getElementById('job').value;
            
            if (!nickname) {
                showMessage('register-message', 'error', 'ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”');
                return;
            }
            if (!job) {
                showMessage('register-message', 'error', 'ì§ì—…ì„ ì„ íƒí•˜ì„¸ìš”');
                return;
            }

            const data = {
                ë‹‰ë„¤ì„: nickname,
                ì§ì—…: job,
                ë„¤ì„ë“œ: document.getElementById('named').value || '',
                ì‹œì‘ì‹œê°„: document.getElementById('startTime').value,
                ì¢…ë£Œì‹œê°„: document.getElementById('endTime').value,
                ëª»í•˜ëŠ”ìš”ì¼: getSelectedDays(),
                ë ˆì´ë“œì¢…ë¥˜: document.getElementById('raidType').value,
                ì°¸ê³ ì‚¬í•­: document.getElementById('note').value || ''
            };

            const btn = document.querySelector('.submit-btn');
            btn.disabled = true;
            btn.textContent = 'ì €ì¥ ì¤‘...';

            try {
                const response = await fetch(WEBHOOK_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'register', data })
                });
                const result = await response.json();
                
                if (result.success) {
                    showMessage('register-message', 'success', 'ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
                } else {
                    showMessage('register-message', 'error', 'ì €ì¥ ì‹¤íŒ¨: ' + (result.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
                }
            } catch (error) {
                showMessage('register-message', 'error', 'ì €ì¥ ì‹¤íŒ¨: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.textContent = 'ì €ì¥í•˜ê¸°';
            }
        }

        // ì°¸ê°€ì ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
        async function loadPlayerList() {
            const container = document.getElementById('player-list');
            container.innerHTML = '<div class="loading">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';

            try {
                const response = await fetch(WEBHOOK_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'list' })
                });
                const result = await response.json();
                
                if (result.success && result.data && result.data.length > 0) {
                    container.innerHTML = result.data.map(player => {
                        const props = player.properties || player;
                        const nickname = props.ë‹‰ë„¤ì„?.title?.[0]?.text?.content || props.ë‹‰ë„¤ì„ || '???';
                        const job = props.ì§ì—…?.select?.name || props.ì§ì—… || '';
                        const named = props.ë„¤ì„ë“œ?.select?.name || props.ë„¤ì„ë“œ || '';
                        const startTime = props.ì‹œì‘ì‹œê°„?.select?.name || props.ì‹œì‘ì‹œê°„ || '';
                        const endTime = props.ì¢…ë£Œì‹œê°„?.select?.name || props.ì¢…ë£Œì‹œê°„ || '';
                        const raidType = props.ë ˆì´ë“œì¢…ë¥˜?.select?.name || props.ë ˆì´ë“œì¢…ë¥˜ || '';
                        const note = props.ì°¸ê³ ì‚¬í•­?.rich_text?.[0]?.text?.content || props.ì°¸ê³ ì‚¬í•­ || '';
                        const cantDays = props.ëª»í•˜ëŠ”ìš”ì¼?.multi_select?.map(m => m.name) || props.ëª»í•˜ëŠ”ìš”ì¼ || [];

                        return `
                            <div class="player-card">
                                <div class="player-name">
                                    ${nickname}
                                    <span class="job-chip job-${job}">${job}</span>
                                    ${named ? `<span class="named-badge named-${named}">${named}</span>` : ''}
                                </div>
                                <div class="player-info">
                                    ${startTime && startTime !== 'ìƒê´€ì—†ìŒ' ? `${startTime}` : ''}
                                    ${startTime && endTime && startTime !== 'ìƒê´€ì—†ìŒ' && endTime !== 'ìƒê´€ì—†ìŒ' ? ' ~ ' : ''}
                                    ${endTime && endTime !== 'ìƒê´€ì—†ìŒ' ? `${endTime}` : ''}
                                    ${!startTime || startTime === 'ìƒê´€ì—†ìŒ' ? 'ì‹œê°„ ìƒê´€ì—†ìŒ' : ''}
                                    | ${raidType}
                                </div>
                                ${cantDays.length > 0 ? `<div class="cant-days">âŒ ëª»í•˜ëŠ” ìš”ì¼: ${cantDays.join(', ')}</div>` : ''}
                                ${note ? `<div class="player-info" style="margin-top:5px;">ğŸ“ ${note}</div>` : ''}
                            </div>
                        `;
                    }).join('');
                } else {
                    container.innerHTML = '<div class="loading">ë“±ë¡ëœ ì°¸ê°€ìê°€ ì—†ìŠµë‹ˆë‹¤</div>';
                }
            } catch (error) {
                container.innerHTML = `<div class="message error">ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ${error.message}</div>`;
            }
        }
    </script>
</body>
</html>
