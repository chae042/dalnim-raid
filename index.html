<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ğŸŒ™ ë‹¬ë‹˜ì´ - íŒŒí‹° ì¼ì •</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700;900&display=swap');

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'Noto Sans KR', sans-serif;
    background: #1a1a2e;
    color: #e0e0e0;
    padding: 24px;
    min-height: 100vh;
  }

  .container {
    max-width: 1100px;
    margin: 0 auto;
  }

  .loading {
    text-align: center;
    padding: 60px;
    color: #888;
  }

  .loading .spinner {
    font-size: 40px;
    animation: spin 2s linear infinite;
    display: inline-block;
  }

  @keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
  }

  /* Header */
  .header {
    text-align: center;
    margin-bottom: 32px;
  }

  .header h1 {
    font-size: 14px;
    font-weight: 400;
    color: #ffd700;
    letter-spacing: 4px;
    text-transform: uppercase;
    margin-bottom: 8px;
    opacity: 0.7;
  }

  .header h2 {
    font-size: 36px;
    font-weight: 700;
    color: #fff;
    margin-bottom: 4px;
  }

  .header .subtitle {
    font-size: 13px;
    color: #888;
  }

  /* Main Tabs */
  .main-tabs {
    display: flex;
    gap: 4px;
    margin-bottom: 24px;
    justify-content: center;
  }

  .main-tab {
    padding: 14px 32px;
    border-radius: 8px;
    background: #16213e;
    border: 1px solid #2a2a4a;
    color: #888;
    cursor: pointer;
    font-size: 16px;
    font-weight: 500;
    transition: all 0.2s;
  }

  .main-tab:hover {
    background: #1f2f5a;
    color: #ccc;
  }

  .main-tab.active {
    background: #ffd700;
    color: #1a1a2e;
    border-color: #ffd700;
    font-weight: 700;
  }

  .panel {
    display: none;
  }

  .panel.active {
    display: block;
  }

  /* ë“±ë¡ í¼ */
  .register-panel {
    max-width: 500px;
    margin: 0 auto;
    background: #16213e;
    padding: 24px;
    border-radius: 12px;
  }

  .form-group {
    margin-bottom: 20px;
  }

  .form-group label {
    display: block;
    margin-bottom: 8px;
    font-size: 14px;
    color: #888;
    font-weight: 500;
  }

  .form-group input[type="text"],
  .form-group select {
    width: 100%;
    padding: 14px;
    font-size: 16px;
    border: 1px solid #2a2a4a;
    border-radius: 8px;
    background: #1a1a2e;
    color: #fff;
    font-family: inherit;
  }

  .form-group input:focus,
  .form-group select:focus {
    outline: none;
    border-color: #ffd700;
  }

  .search-box {
    display: flex;
    gap: 8px;
  }

  .search-box input {
    flex: 1;
  }

  .search-btn {
    padding: 14px 20px;
    background: #2a2a4a;
    border: 1px solid #3a3a5a;
    border-radius: 8px;
    color: #fff;
    cursor: pointer;
    font-size: 14px;
    white-space: nowrap;
  }

  .search-btn:hover {
    background: #3a3a5a;
  }

  .day-buttons {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
  }

  .day-btn {
    padding: 12px 16px;
    font-size: 14px;
    border: 2px solid #2a2a4a;
    border-radius: 8px;
    background: transparent;
    color: #888;
    cursor: pointer;
    transition: all 0.2s;
    font-weight: 500;
  }

  .day-btn:hover {
    border-color: #ffd700;
    color: #ffd700;
  }

  .day-btn.selected {
    background: #ff6b6b;
    border-color: #ff6b6b;
    color: #fff;
  }

  .submit-btn {
    width: 100%;
    padding: 16px;
    font-size: 18px;
    font-weight: 700;
    border: none;
    border-radius: 8px;
    background: #ffd700;
    color: #1a1a2e;
    cursor: pointer;
    margin-top: 12px;
    transition: all 0.2s;
  }

  .submit-btn:hover {
    background: #ffed4a;
    transform: translateY(-1px);
  }

  .submit-btn:disabled {
    background: #444;
    cursor: not-allowed;
    transform: none;
  }

  .message {
    padding: 12px 16px;
    border-radius: 8px;
    margin-bottom: 16px;
    text-align: center;
    font-size: 14px;
  }

  .message.success { background: rgba(46, 204, 113, 0.2); color: #2ecc71; border: 1px solid #2ecc71; }
  .message.error { background: rgba(231, 76, 60, 0.2); color: #e74c3c; border: 1px solid #e74c3c; }
  .message.info { background: rgba(52, 152, 219, 0.2); color: #3498db; border: 1px solid #3498db; }

  /* Raid Type Tabs */
  .raid-tabs {
    display: flex;
    gap: 8px;
    justify-content: center;
  }

  .raid-tab {
    padding: 10px 24px;
    border-radius: 20px;
    background: #16213e;
    border: 1px solid #2a2a4a;
    color: #888;
    cursor: grab;
    font-size: 14px;
    font-weight: 500;
    transition: all 0.2s;
    user-select: none;
  }

  .raid-tab:active {
    cursor: grabbing;
  }

  .raid-tab:hover {
    border-color: #ffd700;
    color: #ffd700;
  }

  .raid-tab.active {
    background: #ffd700;
    color: #1a1a2e;
    border-color: #ffd700;
    font-weight: 700;
  }

  .raid-tab.expired {
    opacity: 0.5;
    background: #333;
    color: #666;
    border-color: #444;
  }

  .raid-tab.expired:hover {
    border-color: #555;
    color: #888;
  }

  .raid-tab.expired.active {
    background: #555;
    color: #888;
    border-color: #666;
  }

  /* ë§Œë£Œëœ ë ˆì´ë“œ ì „ì²´ íšŒìƒ‰í™” */
  .view-expired #schedule-view,
  .view-expired #notes-section,
  .view-expired .day-tabs,
  .view-expired .mode-toggle,
  .view-expired .legend {
    filter: grayscale(1);
    opacity: 0.6;
  }

  .expired-notice {
    text-align: center;
    padding: 12px;
    background: rgba(255, 107, 107, 0.15);
    border: 1px solid rgba(255, 107, 107, 0.3);
    border-radius: 8px;
    color: #ff6b6b;
    margin-bottom: 16px;
    font-size: 14px;
  }

  /* Mode Toggle */
  .mode-toggle {
    display: flex;
    gap: 8px;
    margin-bottom: 20px;
    justify-content: center;
  }

  .mode-toggle-btn {
    padding: 10px 20px;
    border-radius: 6px;
    background: #16213e;
    border: 1px solid #2a2a4a;
    color: #888;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    transition: all 0.2s;
  }

  .mode-toggle-btn:hover {
    border-color: #60a5fa;
    color: #60a5fa;
  }

  .mode-toggle-btn.active {
    background: #60a5fa;
    color: #fff;
    border-color: #60a5fa;
  }

  /* í¸ì§‘ ëª¨ë“œ ë²„íŠ¼ */
  .edit-mode-bar {
    display: flex;
    justify-content: flex-end;
    margin-bottom: 16px;
  }

  .edit-mode-btn {
    padding: 8px 16px;
    background: #2a2a4a;
    border: 1px solid #3a3a5a;
    color: #aaa;
    border-radius: 8px;
    cursor: pointer;
    font-size: 14px;
    transition: all 0.2s;
  }

  .edit-mode-btn:hover {
    background: #3a3a5a;
    color: #fff;
  }

  .edit-mode-btn.active {
    background: #ffd700;
    color: #1a1a2e;
    border-color: #ffd700;
  }

  /* Day Tabs */
  .day-tabs {
    display: flex;
    gap: 4px;
    margin-bottom: 24px;
    overflow-x: auto;
    padding-bottom: 4px;
    justify-content: center;
  }

  .day-tab {
    padding: 14px 24px;
    border-radius: 8px;
    background: #16213e;
    border: 1px solid #2a2a4a;
    color: #888;
    cursor: pointer;
    font-size: 16px;
    font-weight: 500;
    transition: all 0.2s;
    white-space: nowrap;
    text-align: center;
    min-width: 85px;
  }

  .day-tab:hover {
    background: #1f2f5a;
    color: #ccc;
  }

  .day-tab.active {
    background: #ffd700;
    color: #1a1a2e;
    border-color: #ffd700;
    font-weight: 700;
  }

  .day-tab .count {
    display: block;
    font-size: 24px;
    font-weight: 900;
    margin-top: 2px;
  }

  .day-tab.active .count {
    color: #1a1a2e;
  }

  /* ëª¨ë°”ì¼ ê°€ë¡œ ìŠ¤í¬ë¡¤ ë˜í¼ */
  .table-scroll-wrapper {
    width: 100%;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
  }

  /* Schedule Table */
  .schedule-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
  }

  .schedule-table th {
    background: #16213e;
    padding: 16px 12px;
    font-size: 18px;
    font-weight: 700;
    border-bottom: 2px solid #2a2a4a;
  }

  .schedule-table th.nem1 { 
    color: #74b9ff; 
    background: rgba(116, 185, 255, 0.1);
  }
  .schedule-table th.nem2 { 
    color: #ff7675; 
    background: rgba(255, 118, 117, 0.1);
  }
  .schedule-table th.nem3 { 
    color: #a855f7; 
    background: rgba(168, 85, 247, 0.1);
  }
  .schedule-table th.nem4 { 
    color: #ec4899; 
    background: rgba(236, 72, 153, 0.1);
  }
  .schedule-table th.total { color: #ffd700; }

  .schedule-table td {
    padding: 10px 8px;
    border-bottom: 1px solid #2a2a4a;
    vertical-align: top;
  }

  .time-cell {
    font-size: 14px;
    font-weight: 700;
    color: #666;
    text-align: center;
    width: 60px;
  }

  .players-cell {
    min-width: 180px;
  }

  .players-wrap {
    display: flex;
    flex-wrap: wrap;
    gap: 4px;
  }

  .total-cell {
    text-align: center;
    font-weight: 700;
    font-size: 14px;
    color: #888;
    width: 50px;
  }

  .total-cell.highlight {
    color: #ffd700;
    background: rgba(255, 215, 0, 0.1);
  }

  /* íƒ€ì„ë¼ì¸ í…Œì´ë¸” (ë³´ê¸°ëª¨ë“œ) */
  .timeline-table {
    border-collapse: collapse;
  }

  .timeline-table .time-header {
    width: 60px;
  }

  .timeline-table .nem-block-cell {
    padding: 0;
    vertical-align: top;
    position: relative;
    overflow: hidden;
  }

  .timeline-table .nem1-block-cell,
  .timeline-table .nem2-block-cell {
    padding: 0;
    vertical-align: top;
    position: relative;
  }

  /* 1ë„´ 2ë„´ êµ¬ë¶„ */
  .timeline-table .nem1-block-cell {
    background: rgba(116, 185, 255, 0.05);
  }

  .timeline-table .nem2-block-cell {
    background: rgba(255, 118, 117, 0.05);
  }

  .blocks-container {
    position: relative;
    width: 100%;
    overflow: hidden;
    /* ì‹œê°„ëŒ€ë³„ ê°€ë¡œ ë¼ì¸ (44px ê°„ê²©) */
    background: repeating-linear-gradient(
      to bottom,
      transparent 0px,
      transparent 43px,
      #2a2a4a 43px,
      #2a2a4a 44px
    );
  }

  .timeline-block {
    position: absolute;
    border-radius: 4px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    font-size: 11px;
    font-weight: 600;
    gap: 1px;
    box-sizing: border-box;
    transition: filter 0.15s;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    padding: 2px;
  }

  .timeline-block:hover {
    filter: brightness(1.2);
  }

  .timeline-block .job-icon {
    font-size: 9px;
    opacity: 0.8;
  }

  /* íƒ€ì„ë¼ì¸ ë¸”ë¡ ì§ì—… ìƒ‰ìƒ */
  .timeline-block.job-tank { background: rgba(59, 130, 246, 0.3); color: #60a5fa; }
  .timeline-block.job-melee { background: rgba(239, 68, 68, 0.3); color: #f87171; }
  .timeline-block.job-ranged { background: rgba(249, 115, 22, 0.3); color: #fb923c; }
  .timeline-block.job-magic { background: rgba(168, 85, 247, 0.3); color: #c084fc; }
  .timeline-block.job-assassin { background: rgba(236, 72, 153, 0.3); color: #ec4899; }
  .timeline-block.job-summoner { background: rgba(20, 184, 166, 0.3); color: #14b8a6; }
  .timeline-block.job-healer { background: rgba(34, 197, 94, 0.3); color: #4ade80; }
  .timeline-block.job-support { background: rgba(234, 179, 8, 0.3); color: #facc15; }

  /* í¸ì§‘ ëª¨ë“œ í…Œì´ë¸” */
  .schedule-table.edit-table,
  .schedule-table.view-table {
    border-collapse: collapse;
    user-select: none;
    -webkit-user-select: none;
  }

  .schedule-table.edit-table .time-header,
  .schedule-table.view-table .time-header {
    width: 70px;
  }

  /* ë„¤ì„ë“œ êµ¬ë¶„ì„  - ê°€ëŠë‹¤ë€ ë…¸ë€ìƒ‰ */
  .schedule-table .divider-header,
  .schedule-table .divider-cell {
    width: 1px !important;
    min-width: 1px !important;
    max-width: 1px !important;
    background: rgba(255, 215, 0, 0.5);
    padding: 0;
    border: none;
  }

  .schedule-table.edit-table .player-lane-cell,
  .schedule-table.view-table .player-lane-cell {
    padding: 4px;
    text-align: center;
    vertical-align: middle;
    min-width: 85px;
  }

  .schedule-table.edit-table .player-lane-cell.empty,
  .schedule-table.view-table .player-lane-cell.empty {
    min-width: 85px;
  }

  /* ë°•ìŠ¤ ì„ íƒ */
  .selection-box {
    position: fixed;
    border: 2px dashed #ffd700;
    background: rgba(255, 215, 0, 0.1);
    pointer-events: none;
    z-index: 1000;
    display: none;
  }

  .player-chip.selected {
    outline: 3px solid #ffd700;
    outline-offset: 2px;
  }

  /* ì´ë™ ì»¨íŠ¸ë¡¤ */
  .move-controls {
    display: none;
    justify-content: center;
    align-items: center;
    gap: 12px;
    margin: 12px 0;
    padding: 12px;
    background: rgba(255, 215, 0, 0.1);
    border-radius: 8px;
    border: 1px solid rgba(255, 215, 0, 0.3);
  }

  .move-controls.active {
    display: flex;
  }

  .move-controls span {
    color: #ffd700;
    font-weight: 600;
  }

  .move-controls .hint-text {
    color: #888;
    font-weight: 400;
    font-size: 12px;
  }

  .move-btn {
    padding: 8px 16px;
    border: none;
    border-radius: 6px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
  }

  .move-btn.cancel {
    background: #666;
    color: white;
  }

  .move-btn:hover {
    transform: scale(1.05);
  }

  .edit-hint {
    text-align: center;
    color: #888;
    font-size: 12px;
    margin-top: 8px;
  }

  /* ë¹„í™œì„±í™”ëœ ì¹© */
  .player-chip.disabled {
    opacity: 0.3;
    filter: grayscale(100%);
  }

  /* ë“œë˜ê·¸ ê³ ìŠ¤íŠ¸ */
  .drag-ghost {
    position: fixed;
    padding: 8px 12px;
    background: rgba(255, 215, 0, 0.9);
    color: #1a1a2e;
    border-radius: 8px;
    font-weight: 600;
    pointer-events: none;
    z-index: 1001;
    display: none;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
  }

  /* ìš°í´ë¦­ ì»¨í…ìŠ¤íŠ¸ ë©”ë‰´ */
  .context-menu {
    position: fixed;
    background: #1a1a2e;
    border: 1px solid #3a3a5a;
    border-radius: 8px;
    padding: 4px 0;
    min-width: 150px;
    z-index: 2000;
    box-shadow: 0 4px 16px rgba(0,0,0,0.4);
  }

  .context-menu-item {
    padding: 10px 16px;
    cursor: pointer;
    font-size: 14px;
    color: #ccc;
    transition: all 0.15s;
  }

  .context-menu-item:hover {
    background: #2a2a4a;
    color: #fff;
  }

  .context-menu-item:first-child {
    border-radius: 8px 8px 0 0;
  }

  .context-menu-item:last-child {
    border-radius: 0 0 8px 8px;
  }

  /* ë“œë¡­ ì˜ì—­ í•˜ì´ë¼ì´íŠ¸ */
  .schedule-table.edit-table th.nem1.drop-hover,
  .schedule-table.edit-table th.nem2.drop-hover,
  .schedule-table.edit-table th.nem3.drop-hover,
  .schedule-table.edit-table th.nem4.drop-hover {
    background: rgba(255, 215, 0, 0.3);
    box-shadow: inset 0 0 10px rgba(255, 215, 0, 0.5);
  }

  .schedule-table.edit-table .player-lane-cell.drop-zone {
    position: relative;
  }

  .schedule-table.edit-table tr.drop-target-nem1 td:not(.time-cell):not(.divider-cell):not(.total-cell) {
    background: rgba(59, 130, 246, 0.2);
  }

  .schedule-table.edit-table tr.drop-target-nem2 td:not(.time-cell):not(.divider-cell):not(.total-cell) {
    background: rgba(139, 92, 246, 0.2);
  }

  /* Player Chip */
  .player-chip {
    display: inline-flex;
    align-items: center;
    gap: 3px;
    padding: 5px 10px;
    border-radius: 5px;
    font-size: 13px;
    font-weight: 500;
    white-space: nowrap;
    transition: all 0.15s;
    border: 1px solid transparent;
    cursor: default;
    min-width: 60px;
    justify-content: center;
  }

  .player-chip:hover {
    transform: translateY(-1px);
    filter: brightness(1.2);
  }

  .player-chip .job-icon {
    font-size: 10px;
    opacity: 0.8;
  }

  /* Player Block (ë³´ê¸°ëª¨ë“œ) */
  .player-block {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 8px 12px;
    border-radius: 6px;
    font-size: 13px;
    font-weight: 600;
    white-space: nowrap;
    margin: 2px;
    border: 1px solid transparent;
  }

  .player-block .time-range {
    font-size: 11px;
    opacity: 0.7;
    margin-left: 4px;
  }

  /* Job Colors */
  .job-tank {
    background: rgba(59, 130, 246, 0.2);
    border-color: rgba(59, 130, 246, 0.4);
    color: #60a5fa;
  }

  .job-melee {
    background: rgba(239, 68, 68, 0.2);
    border-color: rgba(239, 68, 68, 0.4);
    color: #f87171;
  }

  .job-ranged {
    background: rgba(249, 115, 22, 0.2);
    border-color: rgba(249, 115, 22, 0.4);
    color: #fb923c;
  }

  .job-magic {
    background: rgba(168, 85, 247, 0.2);
    border-color: rgba(168, 85, 247, 0.4);
    color: #c084fc;
  }

  .job-assassin {
    background: rgba(236, 72, 153, 0.2);
    border-color: rgba(236, 72, 153, 0.4);
    color: #ec4899;
  }

  .job-summoner {
    background: rgba(20, 184, 166, 0.2);
    border-color: rgba(20, 184, 166, 0.4);
    color: #14b8a6;
  }

  .job-healer {
    background: rgba(34, 197, 94, 0.2);
    border-color: rgba(34, 197, 94, 0.4);
    color: #4ade80;
  }

  .job-support {
    background: rgba(234, 179, 8, 0.2);
    border-color: rgba(234, 179, 8, 0.4);
    color: #facc15;
  }

  .empty-cell {
    color: #444;
    font-size: 12px;
  }

  /* Legend */
  .legend {
    display: flex;
    gap: 16px;
    margin-top: 24px;
    padding: 16px;
    background: #16213e;
    border-radius: 8px;
    flex-wrap: wrap;
    justify-content: center;
  }

  .legend-item {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 12px;
    color: #888;
  }

  .legend-chip {
    width: 14px;
    height: 14px;
    border-radius: 4px;
  }

  /* Notes */
  .notes {
    margin-top: 16px;
    padding: 16px;
    background: #16213e;
    border-radius: 8px;
    border-left: 3px solid #ffd700;
  }

  .notes h3 {
    font-size: 13px;
    color: #ffd700;
    margin-bottom: 8px;
    font-weight: 700;
  }

  .note-item {
    font-size: 13px;
    color: #888;
    line-height: 1.8;
  }

  .note-item .name {
    color: #ccc;
    font-weight: 500;
  }

  /* Footer */
  .footer {
    text-align: center;
    margin-top: 32px;
    font-size: 12px;
    color: #444;
  }

  /* í”Œë¡œíŒ… ë²„íŠ¼ */
  .floating-btn {
    position: fixed;
    bottom: 24px;
    right: 24px;
    width: 56px;
    height: 56px;
    border-radius: 50%;
    background: #ffd700;
    color: #1a1a2e;
    border: none;
    font-size: 24px;
    cursor: pointer;
    box-shadow: 0 4px 12px rgba(255, 215, 0, 0.4);
    transition: all 0.2s;
    z-index: 100;
  }

  .floating-btn:hover {
    transform: scale(1.1);
    box-shadow: 0 6px 16px rgba(255, 215, 0, 0.6);
  }

  /* ì£¼ì°¨ ì„ íƒ */
  .week-controls {
    display: flex;
    justify-content: center;
    margin-bottom: 12px;
  }

  #week-select {
    padding: 8px 16px;
    border-radius: 8px;
    background: #2a2a4a;
    border: 1px solid #3a3a5a;
    color: #e0e0e0;
    font-size: 14px;
    cursor: pointer;
  }

  #week-select:focus {
    outline: none;
    border-color: #ffd700;
  }

  /* ë ˆì´ë“œ íƒ­ ì»¨í…Œì´ë„ˆ */
  .raid-tabs-container {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 16px;
    justify-content: center;
  }

  .raid-control-btn {
    width: 32px;
    height: 32px;
    border-radius: 6px;
    background: #2a2a4a;
    border: 1px solid #3a3a5a;
    color: #888;
    cursor: pointer;
    font-size: 14px;
    transition: all 0.2s;
  }

  .raid-control-btn:hover {
    background: #3a3a5a;
    color: #fff;
    border-color: #ffd700;
  }

  /* ëª¨ë‹¬ */
  .modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.7);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 200;
    opacity: 0;
    visibility: hidden;
    transition: all 0.2s;
  }

  .modal-overlay.active {
    opacity: 1;
    visibility: visible;
  }

  .modal {
    background: #1a1a2e;
    border-radius: 12px;
    padding: 24px;
    width: 90%;
    max-width: 400px;
    max-height: 80vh;
    overflow-y: auto;
    border: 1px solid #3a3a5a;
    transform: scale(0.9);
    transition: all 0.2s;
  }

  .modal-overlay.active .modal {
    transform: scale(1);
  }

  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
  }

  .modal-title {
    font-size: 18px;
    font-weight: 600;
    color: #ffd700;
  }

  .modal-close {
    background: none;
    border: none;
    color: #888;
    font-size: 24px;
    cursor: pointer;
  }

  .modal-close:hover {
    color: #fff;
  }

  .modal-body .form-group {
    margin-bottom: 16px;
  }

  .modal-body label {
    display: block;
    margin-bottom: 6px;
    color: #aaa;
    font-size: 13px;
  }

  .modal-body input,
  .modal-body select {
    width: 100%;
    padding: 10px 12px;
    background: #16213e;
    border: 1px solid #2a2a4a;
    border-radius: 6px;
    color: #fff;
    font-size: 14px;
  }

  .modal-body input:focus,
  .modal-body select:focus {
    outline: none;
    border-color: #ffd700;
  }

  .modal-footer {
    display: flex;
    gap: 8px;
    margin-top: 20px;
  }

  .modal-btn {
    flex: 1;
    padding: 12px;
    border-radius: 6px;
    border: none;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    transition: all 0.2s;
  }

  .modal-btn.primary {
    background: #ffd700;
    color: #1a1a2e;
  }

  .modal-btn.primary:hover {
    background: #ffed4a;
  }

  .modal-btn.secondary {
    background: #2a2a4a;
    color: #aaa;
  }

  .modal-btn.secondary:hover {
    background: #3a3a5a;
    color: #fff;
  }

  .modal-btn.danger {
    background: #dc2626;
    color: #fff;
  }

  .modal-btn.danger:hover {
    background: #ef4444;
  }

  /* ìŠ¤ì¼€ì¤„ ë·° - ë…¸ì…˜ ìŠ¤íƒ€ì¼ ê°€ë¡œ ìŠ¤í¬ë¡¤ */
  #schedule-view {
    width: 100%;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
  }

  /* ëª¨ë°”ì¼ì—ì„œ í¸ì§‘ëª¨ë“œ ìˆ¨ê¹€ (JSë¡œ .is-mobile í´ë˜ìŠ¤ ì¶”ê°€) */
  .is-mobile .edit-mode-bar,
  .is-mobile .move-controls,
  .is-mobile .edit-hint {
    display: none !important;
  }

  /* ëª¨ë°”ì¼ ëª¨ë‹¬ - ì „ì²´í™”ë©´ ì•± ìŠ¤íƒ€ì¼ */
  .is-mobile .modal-overlay {
    align-items: flex-end;
    padding: 0;
  }

  .is-mobile .modal {
    width: 100%;
    max-width: 100%;
    max-height: 95vh;
    height: auto;
    border-radius: 20px 20px 0 0;
    padding: 0;
    margin: 0;
    display: flex;
    flex-direction: column;
  }

  .is-mobile .modal-header {
    padding: 20px 20px 16px;
    border-bottom: 1px solid #2a2a4a;
    margin-bottom: 0;
    flex-shrink: 0;
  }

  .is-mobile .modal-title {
    font-size: 20px;
  }

  .is-mobile .modal-close {
    font-size: 28px;
    padding: 4px;
  }

  .is-mobile .modal-body {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
    padding-bottom: 20px;
  }

  .is-mobile .modal-body label {
    font-size: 17px;
    font-weight: 600;
    margin-bottom: 10px;
    color: #ccc;
  }

  .is-mobile .modal-body input,
  .is-mobile .modal-body select {
    padding: 16px 14px;
    font-size: 18px;
    -webkit-appearance: none;
    border-radius: 12px;
    background: #16213e;
  }

  .is-mobile .modal-body .form-group {
    margin-bottom: 20px;
  }

  .is-mobile .day-buttons {
    display: flex;
    flex-wrap: nowrap;
    gap: 6px;
    width: 100%;
  }

  .is-mobile .day-btn {
    flex: 1;
    padding: 16px 0;
    font-size: 17px;
    border-radius: 10px;
    text-align: center;
  }

  .is-mobile .modal-footer {
    padding: 16px 20px;
    background: #1a1a2e;
    border-top: 1px solid #2a2a4a;
    margin-top: 0;
    gap: 10px;
    flex-shrink: 0;
  }

  .is-mobile .modal-btn {
    flex: 1;
    padding: 16px 12px;
    font-size: 17px;
    font-weight: 600;
    border-radius: 10px;
    min-width: 0;
  }
  
  .is-mobile .modal-btn.danger {
    background: #dc2626;
    flex: 0.8;
  }

  .is-mobile .search-btn,
  .is-mobile .submit-btn {
    padding: 16px;
    font-size: 17px;
    font-weight: 600;
    border-radius: 10px;
  }

  .is-mobile .form-row {
    flex-direction: column;
    gap: 20px;
  }

  .is-mobile .form-row .form-group {
    flex: none;
    width: 100%;
  }

  /* ëª¨ë°”ì¼ ì‹ ì²­ ë²„íŠ¼ í¬ê²Œ */
  .is-mobile .floating-btn {
    width: 100px;
    height: 100px;
    font-size: 44px;
    bottom: 24px;
    right: 16px;
    box-shadow: 0 6px 20px rgba(255, 215, 0, 0.5);
  }

  /* ëª¨ë°”ì¼ ëª¨ë‹¬ ì œëª©/ë ˆì´ë¸” ë” í¬ê²Œ */
  .is-mobile .modal-title {
    font-size: 20px;
  }

  .is-mobile .modal-body label {
    font-size: 16px;
    font-weight: 500;
    margin-bottom: 10px;
  }

  /* í† ìŠ¤íŠ¸ ì•Œë¦¼ */
  #toast-container {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    z-index: 10000;
    display: flex;
    flex-direction: column;
    gap: 10px;
    pointer-events: none;
  }

  .toast {
    background: rgba(26, 26, 46, 0.95);
    border: 1px solid #ffd700;
    border-radius: 12px;
    padding: 16px 24px;
    color: #fff;
    font-size: 15px;
    box-shadow: 0 4px 30px rgba(255, 215, 0, 0.3);
    animation: toastIn 0.3s ease, toastOut 0.3s ease 2.7s forwards;
    pointer-events: auto;
    max-width: 320px;
    text-align: center;
  }

  .toast.success {
    border-color: #4ade80;
    box-shadow: 0 4px 30px rgba(74, 222, 128, 0.3);
  }

  .toast.error {
    border-color: #f87171;
    box-shadow: 0 4px 30px rgba(248, 113, 113, 0.3);
  }

  @keyframes toastIn {
    from { opacity: 0; transform: scale(0.9); }
    to { opacity: 1; transform: scale(1); }
  }

  @keyframes toastOut {
    from { opacity: 1; transform: scale(1); }
    to { opacity: 0; transform: scale(0.9); }
  }

  /* ì»¤ìŠ¤í…€ í™•ì¸ ëª¨ë‹¬ */
  .confirm-modal-content {
    text-align: center;
    padding: 30px;
    max-width: 300px;
  }

  .confirm-icon {
    font-size: 48px;
    margin-bottom: 16px;
  }

  .confirm-modal-content p {
    color: #ccc;
    font-size: 15px;
    line-height: 1.6;
    margin-bottom: 24px;
  }

  .confirm-buttons {
    display: flex;
    gap: 12px;
    justify-content: center;
  }

  .confirm-btn {
    padding: 10px 24px;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
  }

  .confirm-btn.cancel {
    background: #2a2a4a;
    border: 1px solid #3a3a5a;
    color: #888;
  }

  .confirm-btn.cancel:hover {
    background: #3a3a5a;
    color: #fff;
  }

  .confirm-btn.ok {
    background: linear-gradient(135deg, #ffd700, #ffaa00);
    border: none;
    color: #1a1a2e;
  }

  .confirm-btn.ok:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(255, 215, 0, 0.3);
  }
</style>
</head>
<body>

<!-- í† ìŠ¤íŠ¸ ì»¨í…Œì´ë„ˆ -->
<div id="toast-container"></div>

<!-- ì»¤ìŠ¤í…€ í™•ì¸ ëª¨ë‹¬ -->
<div id="confirm-modal" class="modal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.8); z-index:9999; align-items:center; justify-content:center;">
  <div class="modal-content confirm-modal-content">
    <div class="confirm-icon">ğŸŒ™</div>
    <p id="confirm-message"></p>
    <div class="confirm-buttons">
      <button class="confirm-btn cancel" onclick="handleConfirm(false)">ì•„ë‹ˆìš”</button>
      <button class="confirm-btn ok" onclick="handleConfirm(true)">ë„¤</button>
    </div>
  </div>
</div>

<div class="container">
  <div class="header">
    <h1>ğŸŒ™ ë‹¬ ë ˆê¸°ì˜¨</h1>
    <h2>íŒŒí‹° ì¼ì •</h2>
    <div class="subtitle">ë“±ë¡ ë° ì‹œê°„ëŒ€ë³„ ì°¸ì—¬ ê°€ëŠ¥ ì¸ì›</div>
  </div>

  <!-- ë©”ì¸ íƒ­ (ì¼ì • ë³´ê¸°ë§Œ) -->
  <div class="main-tabs" style="display: none;">
    <div class="main-tab active" onclick="showMainTab('view')">ğŸ“‹ ì¼ì • ë³´ê¸°</div>
  </div>

  <!-- ì¼ì • ë³´ê¸° íŒ¨ë„ -->
  <div id="view-panel" class="panel active">
    <!-- ì£¼ì°¨ ì„ íƒ -->
    <div class="week-controls">
      <select id="week-select" onchange="onWeekSelect()"></select>
    </div>

    <!-- ë ˆì´ë“œ íƒ€ì… íƒ­ (ë™ì  ìƒì„±) -->
    <div class="raid-tabs-container">
      <div class="raid-tabs" id="raid-tabs"></div>
      <button class="raid-control-btn" onclick="openAddRaidModal()" title="ë ˆì´ë“œ ì¶”ê°€">â•</button>
      <button class="raid-control-btn" onclick="openRaidSettingsModal()" title="ë ˆì´ë“œ ì„¤ì •">âš™ï¸</button>
    </div>

    <!-- ë§Œë£Œ ë ˆì´ë“œ ì•ˆë‚´ - ë¹„í™œì„±í™” -->
    <div class="expired-notice" id="expired-notice" style="display:none !important;">
      âš ï¸ ê¸°ê°„ì´ ì¢…ë£Œëœ ë ˆì´ë“œì…ë‹ˆë‹¤ (7ì¼ í›„ ìë™ ìˆ¨ê¹€)
    </div>

    <!-- í¸ì§‘ ëª¨ë“œ ë²„íŠ¼ -->
    <div class="edit-mode-bar">
      <button class="edit-mode-btn" id="edit-mode-btn" onclick="toggleEditMode()">âœ… í¸ì§‘ ì™„ë£Œ</button>
    </div>

    <!-- ìš”ì¼ íƒ­ -->
    <div class="day-tabs" id="day-tabs"></div>

    <!-- ì¼ì • ë·° -->
    <div id="schedule-view">
      <div class="loading">
        <div class="spinner">ğŸŒ™</div>
        <p style="margin-top: 16px;">ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
      </div>
    </div>

    <!-- ì´ë™ ì»¨íŠ¸ë¡¤ (í¸ì§‘ëª¨ë“œ) -->
    <div class="move-controls" id="move-controls">
      <span id="selected-count">0ê°œ ì„ íƒë¨</span>
      <span class="hint-text">ë“œë˜ê·¸í•˜ì—¬ ì´ë™ | Delete: ë¹„í™œì„±í™” | ìš°í´ë¦­: ì‚­ì œ</span>
      <button class="move-btn cancel" onclick="clearSelection()">ì„ íƒ ì·¨ì†Œ</button>
    </div>
    <div class="edit-hint" id="edit-hint" style="display:none;">ğŸ’¡ í´ë¦­ìœ¼ë¡œ ì¹© ì„ íƒ, ë“œë˜ê·¸ë¡œ ì—¬ëŸ¬ ê°œ ì„ íƒ, ë¹ˆ ê³³ í´ë¦­ìœ¼ë¡œ í•´ì œ</div>

    <!-- ì„ íƒ ë°•ìŠ¤ ì˜¤ë²„ë ˆì´ -->
    <div class="selection-box" id="selection-box"></div>
    
    <!-- ë“œë˜ê·¸ ì¤‘ ê³ ìŠ¤íŠ¸ -->
    <div class="drag-ghost" id="drag-ghost"></div>

    <!-- ìš°í´ë¦­ ì»¨í…ìŠ¤íŠ¸ ë©”ë‰´ -->
    <div class="context-menu" id="context-menu" style="display:none;">
      <div class="context-menu-item" onclick="hideContextMenu(); deleteSelectedPlayers();">ğŸ—‘ï¸ ì°¸ê°€ì ì‚­ì œ</div>
      <div class="context-menu-item" onclick="hideContextMenu(); disableSelected();">ğŸ‘ï¸ ë¹„í™œì„±í™”</div>
    </div>

    <!-- ë²”ë¡€ -->
    <div class="legend">
      <div class="legend-item"><div class="legend-chip" style="background: rgba(59, 130, 246, 0.4);"></div> ìˆ˜í˜¸ì„±</div>
      <div class="legend-item"><div class="legend-chip" style="background: rgba(239, 68, 68, 0.4);"></div> ê²€ì„±</div>
      <div class="legend-item"><div class="legend-chip" style="background: rgba(249, 115, 22, 0.4);"></div> ê¶ì„±</div>
      <div class="legend-item"><div class="legend-chip" style="background: rgba(168, 85, 247, 0.4);"></div> ë§ˆë„ì„±</div>
      <div class="legend-item"><div class="legend-chip" style="background: rgba(34, 197, 94, 0.4);"></div> ì¹˜ìœ ì„±</div>
      <div class="legend-item"><div class="legend-chip" style="background: rgba(234, 179, 8, 0.4);"></div> í˜¸ë²•ì„±</div>
      <div class="legend-item"><div class="legend-chip" style="background: rgba(236, 72, 153, 0.4);"></div> ì‚´ì„±</div>
      <div class="legend-item"><div class="legend-chip" style="background: rgba(20, 184, 166, 0.4);"></div> ì •ë ¹ì„±</div>
    </div>

    <!-- ì°¸ê³ ì‚¬í•­ -->
    <div id="notes-section"></div>

    <div class="footer">
      ğŸŒ™ ë‹¬ë‹˜ì´ Â· <span id="update-time"></span>
    </div>
  </div>

  <!-- í”Œë¡œíŒ… ë²„íŠ¼ (ì°¸ê°€ì ë“±ë¡) -->
  <button class="floating-btn" onclick="openRegisterModal()" title="ì°¸ê°€ì ë“±ë¡">âœï¸</button>

  <!-- ì°¸ê°€ì ë“±ë¡ ëª¨ë‹¬ -->
  <div class="modal-overlay" id="register-modal">
    <div class="modal">
      <div class="modal-header">
        <span class="modal-title">âœï¸ ì°¸ê°€ ë“±ë¡/ìˆ˜ì •</span>
        <button class="modal-close" onclick="closeModal('register-modal')">&times;</button>
      </div>
      <div class="modal-body">
        <div id="register-message"></div>
        
        <div class="form-group">
          <label>ë ˆì´ë“œ ì¢…ë¥˜ *</label>
          <select id="raidType" onchange="updateNamedOptions()"></select>
        </div>

        <div class="form-group">
          <label>ë‹‰ë„¤ì„ *</label>
          <div class="search-box">
            <input type="text" id="nickname" placeholder="ìºë¦­í„° ì´ë¦„">
            <button class="search-btn" onclick="loadMyInfo()">ë¶ˆëŸ¬ì˜¤ê¸°</button>
          </div>
        </div>

        <div class="form-group">
          <label>ì§ì—… *</label>
          <select id="job">
            <option value="">ì„ íƒí•˜ì„¸ìš”</option>
            <option value="ìˆ˜í˜¸ì„±">ìˆ˜í˜¸ì„±</option>
            <option value="ê²€ì„±">ê²€ì„±</option>
            <option value="ê¶ì„±">ê¶ì„±</option>
            <option value="ë§ˆë„ì„±">ë§ˆë„ì„±</option>
            <option value="ì¹˜ìœ ì„±">ì¹˜ìœ ì„±</option>
            <option value="í˜¸ë²•ì„±">í˜¸ë²•ì„±</option>
            <option value="ì‚´ì„±">ì‚´ì„±</option>
            <option value="ì •ë ¹ì„±">ì •ë ¹ì„±</option>
          </select>
        </div>

        <div class="form-group">
          <label>ë„¤ì„ë“œ</label>
          <select id="named">
            <option value="">ì„ íƒí•˜ì„¸ìš”</option>
          </select>
        </div>

        <div class="form-group">
          <label>ì‹œì‘ ê°€ëŠ¥ ì‹œê°„</label>
          <select id="startTime">
            <option value="ìƒê´€ì—†ìŒ">ìƒê´€ì—†ìŒ</option>
            <option value="PM 6">PM 6 (18ì‹œ)</option>
            <option value="PM 7">PM 7 (19ì‹œ)</option>
            <option value="PM 8">PM 8 (20ì‹œ)</option>
            <option value="PM 9">PM 9 (21ì‹œ)</option>
            <option value="PM 10">PM 10 (22ì‹œ)</option>
            <option value="PM 11">PM 11 (23ì‹œ)</option>
            <option value="AM 12">AM 12 (24ì‹œ)</option>
            <option value="AM 1">AM 1 (01ì‹œ)</option>
            <option value="AM 2">AM 2 (02ì‹œ)</option>
          </select>
        </div>

        <div class="form-group">
          <label>ì¢…ë£Œ ê°€ëŠ¥ ì‹œê°„</label>
          <select id="endTime">
            <option value="ìƒê´€ì—†ìŒ">ìƒê´€ì—†ìŒ</option>
            <option value="PM 6">PM 6 (18ì‹œ)</option>
            <option value="PM 7">PM 7 (19ì‹œ)</option>
            <option value="PM 8">PM 8 (20ì‹œ)</option>
            <option value="PM 9">PM 9 (21ì‹œ)</option>
            <option value="PM 10">PM 10 (22ì‹œ)</option>
            <option value="PM 11">PM 11 (23ì‹œ)</option>
            <option value="AM 12">AM 12 (24ì‹œ)</option>
            <option value="AM 1">AM 1 (01ì‹œ)</option>
            <option value="AM 2">AM 2 (02ì‹œ)</option>
          </select>
        </div>

        <div class="form-group">
          <label>ëª»í•˜ëŠ” ìš”ì¼ (í´ë¦­í•´ì„œ ì„ íƒ)</label>
          <div class="day-buttons">
            <button type="button" class="day-btn" data-day="ìˆ˜">ìˆ˜</button>
            <button type="button" class="day-btn" data-day="ëª©">ëª©</button>
            <button type="button" class="day-btn" data-day="ê¸ˆ">ê¸ˆ</button>
            <button type="button" class="day-btn" data-day="í† ">í† </button>
            <button type="button" class="day-btn" data-day="ì¼">ì¼</button>
            <button type="button" class="day-btn" data-day="ì›”">ì›”</button>
            <button type="button" class="day-btn" data-day="í™”">í™”</button>
          </div>
        </div>

        <div class="form-group">
          <label>ì°¸ê³ ì‚¬í•­</label>
          <input type="text" id="note" placeholder="ì˜ˆ: ê¸ˆí† ë§Œ ê°€ëŠ¥, 24ì‹œ ì´ì „ ì„ í˜¸">
        </div>
      </div>
      <div class="modal-footer">
        <button class="modal-btn danger delete-btn" id="delete-registration-btn" onclick="deleteMyRegistration()" style="display:none;">ì‚­ì œ</button>
        <div style="flex:1;"></div>
        <button class="modal-btn secondary" onclick="closeModal('register-modal')">ì·¨ì†Œ</button>
        <button class="modal-btn primary submit-btn" onclick="submitForm()">ì €ì¥</button>
      </div>
    </div>
  </div>

  <!-- ë ˆì´ë“œ ì¶”ê°€ ëª¨ë‹¬ -->
  <div class="modal-overlay" id="add-raid-modal">
    <div class="modal">
      <div class="modal-header">
        <span class="modal-title">â• ìƒˆ ë ˆì´ë“œ ì¶”ê°€</span>
        <button class="modal-close" onclick="closeModal('add-raid-modal')">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>ë ˆì´ë“œ ì´ë¦„ *</label>
          <input type="text" id="new-raid-name" placeholder="ì˜ˆ: íŠ¸ë¼ì´íŒŸ, í´ë¦¬ì–´íŒŸ">
        </div>
        <div class="form-group">
          <label>ë„¤ì„ë“œ ìˆ˜</label>
          <select id="new-raid-named-count">
            <option value="1">1ë„´</option>
            <option value="2" selected>2ë„´ (1ë„´, 2ë„´)</option>
            <option value="3">3ë„´ (1ë„´, 2ë„´, 3ë„´)</option>
            <option value="4">4ë„´</option>
          </select>
        </div>
        <div class="form-group">
          <label>í•„ìš” ì¸ì› (í•˜ì´ë¼ì´íŠ¸ ê¸°ì¤€)</label>
          <input type="number" id="new-raid-required" value="8" min="1" max="40">
        </div>
        <!-- ê¸°ê°„ í•„ë“œ ì œê±°ë¨ (ì£¼ì°¨ ì‹œìŠ¤í…œìœ¼ë¡œ ëŒ€ì²´) -->
        <div class="form-group" id="new-raid-period-group" style="display:none;">
          <label>
            <input type="checkbox" id="new-raid-no-period" checked> ê¸°ê°„ ì—†ìŒ (ìƒì‹œ)
          </label>
        </div>
        <div class="form-group" id="new-raid-period-group2" style="display:none;">
          <input type="date" id="new-raid-start">
          <input type="date" id="new-raid-end">
        </div>
      </div>
      <div class="modal-footer">
        <button class="modal-btn secondary" onclick="closeModal('add-raid-modal')">ì·¨ì†Œ</button>
        <button class="modal-btn primary" onclick="addNewRaid()">ì¶”ê°€</button>
      </div>
    </div>
  </div>

  <!-- ë ˆì´ë“œ ì„¤ì • ëª¨ë‹¬ -->
  <div class="modal-overlay" id="raid-settings-modal">
    <div class="modal">
      <div class="modal-header">
        <span class="modal-title">âš™ï¸ ë ˆì´ë“œ ì„¤ì •</span>
        <button class="modal-close" onclick="closeModal('raid-settings-modal')">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>ë ˆì´ë“œ ì„ íƒ</label>
          <select id="settings-raid-select" onchange="loadRaidSettingsForEdit()"></select>
        </div>
        <div class="form-group">
          <label>ë ˆì´ë“œ ì´ë¦„</label>
          <input type="text" id="edit-raid-name">
        </div>
        <div class="form-group">
          <label>ë„¤ì„ë“œ ìˆ˜</label>
          <select id="edit-raid-named-count">
            <option value="1">1ë„´</option>
            <option value="2">2ë„´ (1ë„´, 2ë„´)</option>
            <option value="3">3ë„´ (1ë„´, 2ë„´, 3ë„´)</option>
            <option value="4">4ë„´</option>
          </select>
        </div>
        <div class="form-group">
          <label>í•„ìš” ì¸ì› (í•˜ì´ë¼ì´íŠ¸ ê¸°ì¤€)</label>
          <input type="number" id="edit-raid-required" value="8" min="1" max="40">
        </div>
        <!-- í™œì„±í™”/ê¸°ê°„ í•„ë“œ ì œê±°ë¨ (ì£¼ì°¨ ì‹œìŠ¤í…œìœ¼ë¡œ ëŒ€ì²´) -->
        <div class="form-group" style="display:none;">
          <select id="edit-raid-active">
            <option value="true" selected>í™œì„±í™”</option>
          </select>
        </div>
        <div class="form-group" style="display:none;">
          <input type="checkbox" id="edit-raid-no-period" checked>
          <input type="date" id="edit-raid-start">
          <input type="date" id="edit-raid-end">
        </div>
      </div>
      <div class="modal-footer">
        <button class="modal-btn danger" onclick="deleteRaid()">ì‚­ì œ</button>
        <button class="modal-btn secondary" onclick="closeModal('raid-settings-modal')">ì·¨ì†Œ</button>
        <button class="modal-btn primary" onclick="saveRaidSettings()">ì €ì¥</button>
      </div>
    </div>
  </div>
</div>

<script>
const WEBHOOK_URL = 'https://n8n-production-f0a7.up.railway.app/webhook/raid';
const DAYS = ['ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† ', 'ì¼', 'ì›”', 'í™”'];
const TIME_ORDER = ['PM 6', 'PM 7', 'PM 8', 'PM 9', 'PM 10', 'PM 11', 'AM 12', 'AM 1', 'AM 2'];
const TIME_LABELS = ['18ì‹œ', '19ì‹œ', '20ì‹œ', '21ì‹œ', '22ì‹œ', '23ì‹œ', '00ì‹œ', '01ì‹œ', '02ì‹œ'];

const JOB_MAP = {
  'ìˆ˜í˜¸ì„±': { class: 'job-tank', icon: 'ğŸ›¡' },
  'ê²€ì„±': { class: 'job-melee', icon: 'âš”ï¸' },
  'ê¶ì„±': { class: 'job-ranged', icon: 'ğŸ¹' },
  'ë§ˆë„ì„±': { class: 'job-magic', icon: 'â—†' },
  'ì¹˜ìœ ì„±': { class: 'job-healer', icon: 'âœš' },
  'í˜¸ë²•ì„±': { class: 'job-support', icon: 'â—ˆ' },
  'ì‚´ì„±': { class: 'job-assassin', icon: 'ğŸ—¡' },
  'ì •ë ¹ì„±': { class: 'job-summoner', icon: 'ğŸ”®' },
};

let allPlayers = [];
let raidSettings = [];
let raidIdToName = {};
let currentDay = 'ìˆ˜';
let currentRaidType = '';
let currentWeekStart = null;

// ============================================
// í† ìŠ¤íŠ¸ ì•Œë¦¼ + ì»¤ìŠ¤í…€ í™•ì¸ì°½
// ============================================
function showToast(message, type = 'default') {
  const container = document.getElementById('toast-container');
  const toast = document.createElement('div');
  toast.className = `toast ${type}`;
  toast.textContent = message;
  container.appendChild(toast);
  
  setTimeout(() => toast.remove(), 3000);
}

let confirmResolve = null;

function showConfirm(message) {
  return new Promise(resolve => {
    confirmResolve = resolve;
    document.getElementById('confirm-message').textContent = message;
    document.getElementById('confirm-modal').style.display = 'flex';
  });
}

function handleConfirm(result) {
  document.getElementById('confirm-modal').style.display = 'none';
  if (confirmResolve) {
    confirmResolve(result);
    confirmResolve = null;
  }
}

// í˜„ì¬ ì£¼ì°¨ ì‹œì‘ì¼(ìˆ˜ìš”ì¼) ê³„ì‚°
function getCurrentWeekStart() {
  const today = new Date();
  const day = today.getDay(); // 0=ì¼, 1=ì›”, ..., 3=ìˆ˜
  let diff = day - 3;
  if (diff < 0) diff += 7;
  const wed = new Date(today);
  wed.setDate(today.getDate() - diff);
  // UTC ë¬¸ì œ ë°©ì§€: ì§ì ‘ ë¬¸ìì—´ ìƒì„±
  const y = wed.getFullYear();
  const m = String(wed.getMonth() + 1).padStart(2, '0');
  const d = String(wed.getDate()).padStart(2, '0');
  return `${y}-${m}-${d}`;
}

// ì£¼ì°¨ ì¢…ë£Œì¼(í™”ìš”ì¼) ê³„ì‚° - ì‹œì‘ì¼ + 6ì¼
function getWeekEnd(weekStart) {
  const [y, m, d] = weekStart.split('-').map(Number);
  const end = new Date(y, m - 1, d + 6);
  const ey = end.getFullYear();
  const em = String(end.getMonth() + 1).padStart(2, '0');
  const ed = String(end.getDate()).padStart(2, '0');
  return `${ey}-${em}-${ed}`;
}

// ì£¼ì°¨ í‘œì‹œìš© í¬ë§·
function formatWeekLabel(weekStart) {
  // ISO ë¬¸ìì—´ì„ ë¡œì»¬ ë‚ ì§œë¡œ íŒŒì‹± (UTC ë¬¸ì œ ë°©ì§€)
  const [y, m, d] = weekStart.split('-').map(Number);
  const start = new Date(y, m-1, d);
  const end = new Date(y, m-1, d + 6);
  return `${start.getMonth()+1}/${start.getDate()}~${end.getMonth()+1}/${end.getDate()}`;
}

// ì§€ë‚œ ì£¼ì°¨ ëª©ë¡ ìƒì„± (ìµœê·¼ 4ì£¼)
function getWeekOptions() {
  const weeks = [];
  const current = getCurrentWeekStart();
  const [cy, cm, cd] = current.split('-').map(Number);
  
  for (let i = 0; i < 4; i++) {
    const d = new Date(cy, cm - 1, cd - (i * 7));
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2, '0');
    const day = String(d.getDate()).padStart(2, '0');
    weeks.push(`${y}-${m}-${day}`);
  }
  return weeks;
}

// ì£¼ì°¨ ë“œë¡­ë‹¤ìš´ ë Œë”ë§
function renderWeekSelect() {
  const select = document.getElementById('week-select');
  if (!select) return;
  
  const weeks = getWeekOptions();
  const current = getCurrentWeekStart();
  
  select.innerHTML = weeks.map((w, i) => {
    const label = formatWeekLabel(w);
    const isCurrent = w === current;
    const displayText = isCurrent ? `ğŸ“Œ ì´ë²ˆ ì£¼ ${label}` : label;
    return `<option value="${w}" ${w === (currentWeekStart || current) ? 'selected' : ''}>${displayText}</option>`;
  }).join('');
}

// ì£¼ì°¨ ì„ íƒ ì‹œ
function onWeekSelect() {
  const select = document.getElementById('week-select');
  currentWeekStart = select.value;
  
  // ì§€ë‚œ ì£¼ì°¨ ì„ íƒ ì‹œ í¸ì§‘ ëª¨ë“œ ì¢…ë£Œ
  if (!isCurrentWeek()) {
    if (currentMode === 'edit') {
      currentMode = 'view';
      const btn = document.getElementById('edit-mode-btn');
      btn.textContent = 'âœ… í¸ì§‘ ì™„ë£Œ';
      btn.classList.remove('active');
      document.getElementById('edit-hint').style.display = 'none';
      clearSelection();
    }
  }
  
  updateEditButtonState();
  loadPlayerList();
}

// í˜„ì¬ ì£¼ì°¨ì¸ì§€ í™•ì¸
function isCurrentWeek() {
  return currentWeekStart === getCurrentWeekStart();
}

// í¸ì§‘ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
function updateEditButtonState() {
  const btn = document.getElementById('edit-mode-btn');
  if (isCurrentWeek()) {
    btn.disabled = false;
    btn.title = '';
    btn.style.opacity = '1';
  } else {
    btn.disabled = true;
    btn.title = 'ì§€ë‚œ ì£¼ì°¨ëŠ” í¸ì§‘í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤';
    btn.style.opacity = '0.5';
  }
}

let currentMode = 'view';

// ë ˆì¸ ìˆœì„œ ê´€ë¦¬ (ë“œë˜ê·¸ ë“œë¡­ ë°°ì¹˜ìš©) - ë™ì 
let nemLaneOrders = {
  '1ë„´': [],
  '2ë„´': [],
  '3ë„´': [],
  '4ë„´': []
};

// í˜„ì¬ ë ˆì´ë“œì˜ í•„ìš”ì¸ì› ê°€ì ¸ì˜¤ê¸°
function getCurrentRaidRequired() {
  const raid = raidSettings.find(r => r.ë ˆì´ë“œëª… === currentRaidType);
  return raid?.í•„ìš”ì¸ì› || 8;
}

// í˜„ì¬ ë ˆì´ë“œ ë„¤ì„ë“œ ìˆ˜ ê°€ì ¸ì˜¤ê¸°
function getCurrentRaidNamedCount() {
  const raid = raidSettings.find(r => r.ë ˆì´ë“œëª… === currentRaidType);
  return raid?.ë„¤ì„ë“œìˆ˜ || 2;
}

// ë„¤ì„ë“œ ì„¤ì • (ìƒ‰ìƒ, ì´ë¦„)
const NEM_CONFIG = {
  1: { name: '1ë„´', class: 'nem1', icon: '1ï¸âƒ£', color: 'rgba(59, 130, 246, 0.3)' },
  2: { name: '2ë„´', class: 'nem2', icon: '2ï¸âƒ£', color: 'rgba(249, 115, 22, 0.3)' },
  3: { name: '3ë„´', class: 'nem3', icon: '3ï¸âƒ£', color: 'rgba(168, 85, 247, 0.3)' },
  4: { name: '4ë„´', class: 'nem4', icon: '4ï¸âƒ£', color: 'rgba(236, 72, 153, 0.3)' }
};

// ë©”ì¸ íƒ­ ì „í™˜
function showMainTab(tabName) {
  document.querySelectorAll('.main-tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
  
  const tabIndex = tabName === 'view' ? 0 : 1;
  document.querySelectorAll('.main-tab')[tabIndex].classList.add('active');
  document.getElementById(`${tabName}-panel`).classList.add('active');
  
  if (tabName === 'view') {
    initViewPanel();
  }
}

// ë³´ê¸° íŒ¨ë„ ì´ˆê¸°í™” (ë ˆì´ë“œ ì„¤ì • ë¨¼ì € ë¡œë“œ)
async function initViewPanel() {
  if (raidSettings.length === 0) {
    await loadRaidSettings();
  }
  renderWeekSelect();
  await loadPlayerList();
}

// ë ˆì´ë“œ íƒ€ì… ì„ íƒ
function selectRaidType(type) {
  currentRaidType = type;
  localStorage.setItem('dalnim_lastRaid', type);
  
  document.querySelectorAll('.raid-tab').forEach(t => {
    t.classList.toggle('active', t.dataset.raid === type);
  });
  
  // ë§Œë£Œ ì²´í¬ â†’ íšŒìƒ‰í™” í† ê¸€
  const raid = raidSettings.find(r => r.ë ˆì´ë“œëª… === type);
  const viewPanel = document.getElementById('view-panel');
  const expiredNotice = document.getElementById('expired-notice');
  
  if (raid && isRaidExpired(raid)) {
    viewPanel.classList.add('view-expired');
    if (expiredNotice) expiredNotice.style.display = 'block';
  } else {
    viewPanel.classList.remove('view-expired');
    if (expiredNotice) expiredNotice.style.display = 'none';
  }
  
  // ì €ì¥ëœ ìˆœì„œ ë¡œë“œ
  loadNemLaneOrders(raid);
  
  renderDayTabs();
  renderSchedule();
  renderNotes();
}

// ë ˆì´ë“œë³„ ë„¤ì„ë“œ ìˆœì„œ ë¡œë“œ
function loadNemLaneOrders(raid) {
  nemLaneOrders = { '1ë„´': [], '2ë„´': [], '3ë„´': [], '4ë„´': [] };
  if (!raid) return;
  
  for (let i = 1; i <= 4; i++) {
    const orderStr = raid[`${i}ë„´ìˆœì„œ`] || '';
    if (orderStr) {
      nemLaneOrders[`${i}ë„´`] = orderStr.split(',').map(s => s.trim()).filter(Boolean);
    }
  }
}

// ë„¤ì„ë“œ ìˆœì„œ ì €ì¥
async function saveNemLaneOrders() {
  const raid = raidSettings.find(r => r.ë ˆì´ë“œëª… === currentRaidType);
  if (!raid || !raid.id) return;
  
  const orderData = {};
  for (let i = 1; i <= 4; i++) {
    orderData[`${i}ë„´ìˆœì„œ`] = nemLaneOrders[`${i}ë„´`].join(',');
  }
  
  try {
    await fetch(WEBHOOK_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ 
        action: 'updateRaidOrder', 
        id: raid.id,
        data: orderData
      })
    });
    
    // ë¡œì»¬ raidSettingsë„ ì—…ë°ì´íŠ¸
    Object.assign(raid, orderData);
  } catch (error) {
    console.error('ìˆœì„œ ì €ì¥ ì‹¤íŒ¨:', error);
  }
}

// ìš”ì¼ ì„ íƒ
function selectDay(day) {
  currentDay = day;
  localStorage.setItem('dalnim_lastDay', day);
  
  document.querySelectorAll('.day-tab').forEach(t => {
    t.classList.toggle('active', t.dataset.day === day);
  });
  renderSchedule();
}

// ì§ì—… ì •ë³´
function getJobInfo(job) {
  return JOB_MAP[job] || { class: 'job-support', icon: 'â—' };
}

// ì‹œê°„ ì¸ë±ìŠ¤
function getTimeIndex(timeStr) {
  if (!timeStr || timeStr === 'ìƒê´€ì—†ìŒ') return -1;
  return TIME_ORDER.indexOf(timeStr);
}

// ì‹œê°„ ë²”ìœ„
function getTimeRange(startTime, endTime) {
  let startIdx = getTimeIndex(startTime);
  let endIdx = getTimeIndex(endTime);
  
  if (startIdx === -1) startIdx = 0;
  if (endIdx === -1) endIdx = TIME_ORDER.length - 1;
  if (endIdx < startIdx) endIdx = startIdx;
  
  return { startIdx, endIdx };
}

// ë ˆì´ë“œ ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸°
async function loadRaidSettings() {
  try {
    const response = await fetch(WEBHOOK_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ action: 'getRaidSettings' })
    });
    const result = await response.json();
    
    if (result.raidSettings && result.raidSettings.length > 0) {
      raidSettings = result.raidSettings.map(item => {
        const props = item.properties || item;
        return {
          id: item.id,
          ë ˆì´ë“œëª…: props.ë ˆì´ë“œëª…?.title?.[0]?.text?.content || '',
          ë ˆì´ë“œì¢…ë¥˜: props.ë ˆì´ë“œì¢…ë¥˜?.select?.name || '',
          ë„¤ì„ë“œìˆ˜: props.ë„¤ì„ë“œìˆ˜?.number || 2,
          í•„ìš”ì¸ì›: props.í•„ìš”ì¸ì›?.number || 8,
          í™œì„±í™”: props.í™œì„±í™”?.checkbox !== false,
          ê¸°ê°„: props.ê¸°ê°„?.date || null,
          ìˆœì„œ: props.ìˆœì„œ?.number || 999
        };
      });
      
      // ìˆœì„œë¡œ ì •ë ¬
      raidSettings.sort((a, b) => (a.ìˆœì„œ || 999) - (b.ìˆœì„œ || 999));
      
      // ID â†’ ì´ë¦„ ë§¤í•‘
      raidIdToName = {};
      raidSettings.forEach(r => {
        raidIdToName[r.id] = r.ë ˆì´ë“œëª…;
      });
      
      // ì €ì¥ëœ ë§ˆì§€ë§‰ íƒ­ ë³µì› ë˜ëŠ” ì²« ë²ˆì§¸ë¥¼ ê¸°ë³¸ê°’
      if (raidSettings.length > 0 && !currentRaidType) {
        const savedRaid = localStorage.getItem('dalnim_lastRaid');
        const savedDay = localStorage.getItem('dalnim_lastDay');
        
        if (savedRaid && raidSettings.find(r => r.ë ˆì´ë“œëª… === savedRaid)) {
          currentRaidType = savedRaid;
        } else {
          currentRaidType = raidSettings[0].ë ˆì´ë“œëª…;
        }
        
        if (savedDay && DAYS.includes(savedDay)) {
          currentDay = savedDay;
        }
      }
      
      renderRaidTabs();
    }
  } catch (error) {
    console.error('ë ˆì´ë“œ ì„¤ì • ë¡œë“œ ì‹¤íŒ¨:', error);
  }
}

// ë ˆì´ë“œ ë§Œë£Œ ì²´í¬ - ë¹„í™œì„±í™” (ì£¼ì°¨ ì‹œìŠ¤í…œìœ¼ë¡œ ëŒ€ì²´)
function isRaidExpired(raid) {
  return false;
}

// ë ˆì´ë“œ ìˆ¨ê¹€ ì²´í¬ - ë¹„í™œì„±í™” (ì£¼ì°¨ ì‹œìŠ¤í…œìœ¼ë¡œ ëŒ€ì²´)
function isRaidHidden(raid) {
  return false;
}

// ë ˆì´ë“œ íƒ­ ë Œë”ë§
function renderRaidTabs() {
  const container = document.getElementById('raid-tabs');
  
  // ìˆ¨ê¹€ ì²˜ë¦¬ ì•ˆ ëœ ê²ƒë§Œ í‘œì‹œ, ìˆœì„œë¡œ ì •ë ¬
  const visibleRaids = raidSettings
    .filter(r => !isRaidHidden(r))
    .sort((a, b) => (a.ìˆœì„œ || 999) - (b.ìˆœì„œ || 999));
  
  container.innerHTML = visibleRaids.map((r, idx) => {
    const expired = isRaidExpired(r);
    const expiredClass = expired ? 'expired' : '';
    const activeClass = r.ë ˆì´ë“œëª… === currentRaidType ? 'active' : '';
    
    return `<div class="raid-tab ${activeClass} ${expiredClass}" 
         data-raid="${r.ë ˆì´ë“œëª…}"
         data-id="${r.id}"
         data-expired="${expired}"
         draggable="true"
         ondragstart="onTabDragStart(event)"
         ondragover="onTabDragOver(event)"
         ondrop="onTabDrop(event)"
         ondragend="onTabDragEnd(event)"
         onclick="selectRaidType('${r.ë ˆì´ë“œëª…}')">${r.ë ˆì´ë“œëª…}</div>`;
  }).join('');
}

// í”Œë ˆì´ì–´ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
async function loadPlayerList() {
  const container = document.getElementById('schedule-view');
  container.innerHTML = `
    <div class="loading">
      <div class="spinner">ğŸŒ™</div>
      <p style="margin-top: 16px;">ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
    </div>
  `;

  // í˜„ì¬ ì£¼ì°¨ ì„¤ì •
  if (!currentWeekStart) {
    currentWeekStart = getCurrentWeekStart();
  }

  try {
    const response = await fetch(WEBHOOK_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ action: 'list', weekStart: currentWeekStart })
    });
    const result = await response.json();
    
    if (result.success && result.data) {
      allPlayers = result.data.map(player => {
        const props = player.properties || player;
        // ë ˆì´ë“œì¢…ë¥˜ê°€ relationì´ë©´ IDë¡œ ì´ë¦„ ì°¾ê¸°
        let raidType = '';
        if (props.ë ˆì´ë“œì¢…ë¥˜?.relation?.[0]?.id) {
          raidType = raidIdToName[props.ë ˆì´ë“œì¢…ë¥˜.relation[0].id] || '';
        } else {
          raidType = props.ë ˆì´ë“œì¢…ë¥˜?.select?.name || props.ë ˆì´ë“œì¢…ë¥˜ || '';
        }
        
        return {
          id: player.id, // ë…¸ì…˜ í˜ì´ì§€ ID
          ë‹‰ë„¤ì„: props.ë‹‰ë„¤ì„?.title?.[0]?.text?.content || props.ë‹‰ë„¤ì„ || '???',
          ì§ì—…: props.ì§ì—…?.select?.name || props.ì§ì—… || '',
          ë„¤ì„ë“œ: props.ë„¤ì„ë“œ?.select?.name || props.ë„¤ì„ë“œ || '',
          ì‹œì‘ì‹œê°„: props.ì‹œì‘ì‹œê°„?.select?.name || props.ì‹œì‘ì‹œê°„ || 'ìƒê´€ì—†ìŒ',
          ì¢…ë£Œì‹œê°„: props.ì¢…ë£Œì‹œê°„?.select?.name || props.ì¢…ë£Œì‹œê°„ || 'ìƒê´€ì—†ìŒ',
          ëª»í•˜ëŠ”ìš”ì¼: props.ëª»í•˜ëŠ”ìš”ì¼?.multi_select?.map(m => m.name) || props.ëª»í•˜ëŠ”ìš”ì¼ || [],
          ë ˆì´ë“œì¢…ë¥˜: raidType,
          ì°¸ê³ ì‚¬í•­: props.ì°¸ê³ ì‚¬í•­?.rich_text?.[0]?.text?.content || props.ì°¸ê³ ì‚¬í•­ || ''
        };
      });
      
      document.getElementById('update-time').textContent = new Date().toLocaleString('ko-KR');
      renderDayTabs();
      renderSchedule();
      renderNotes();
      updateEditButtonState();
    } else {
      container.innerHTML = '<div class="loading">ë“±ë¡ëœ ì°¸ê°€ìê°€ ì—†ìŠµë‹ˆë‹¤</div>';
      updateEditButtonState();
    }
  } catch (error) {
    container.innerHTML = `<div class="loading">âŒ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ${error.message}</div>`;
  }
}

// ìš”ì¼ íƒ­ ë Œë”ë§
function renderDayTabs() {
  const container = document.getElementById('day-tabs');
  
  container.innerHTML = DAYS.map(day => `
    <div class="day-tab ${day === currentDay ? 'active' : ''}" data-day="${day}" onclick="selectDay('${day}')">
      ${day}
    </div>
  `).join('');
}

// ì¼ì • ë Œë”ë§
function renderSchedule() {
  const container = document.getElementById('schedule-view');
  
  const filtered = allPlayers.filter(p => 
    p.ë ˆì´ë“œì¢…ë¥˜ === currentRaidType && 
    !p.ëª»í•˜ëŠ”ìš”ì¼.includes(currentDay)
  );
  
  if (currentMode === 'view') {
    renderViewMode(container, filtered);
  } else {
    renderEditMode(container, filtered);
  }
}

// ì‹œê°„ëŒ€ë³„ ë„¤ì„ë“œ í™•ì¸
function getPlayerNemAtTime(player, timeIdx) {
  if (player.timeNemMap && player.timeNemMap[timeIdx] !== undefined) {
    return player.timeNemMap[timeIdx];
  }
  return player.ë„¤ì„ë“œ; // ê¸°ë³¸ê°’
}

// ë³´ê¸° ëª¨ë“œ - íƒ€ì„ë¼ì¸ ë¸”ë¡ (ë ˆì¸ ë°°ì¹˜ëŠ” í¸ì§‘ ëª¨ë“œì™€ ë™ì¼)
function renderViewMode(container, players) {
  const ROW_HEIGHT = 44;
  const namedCount = getCurrentRaidNamedCount();
  const nemNames = Array.from({length: namedCount}, (_, i) => `${i+1}ë„´`);
  
  // í”Œë ˆì´ì–´ë³„ë¡œ ì—°ì†ëœ ë„¤ì„ë“œ êµ¬ê°„(ì„¸ê·¸ë¨¼íŠ¸)ìœ¼ë¡œ ë¶„ë¦¬
  const createSegments = (player) => {
    const { startIdx, endIdx } = getTimeRange(player.ì‹œì‘ì‹œê°„, player.ì¢…ë£Œì‹œê°„);
    const segments = [];
    let currentSeg = null;
    
    for (let t = startIdx; t <= endIdx; t++) {
      if (player.hiddenTimes && player.hiddenTimes.includes(t)) {
        if (currentSeg) {
          segments.push(currentSeg);
          currentSeg = null;
        }
        continue;
      }
      
      const nem = getPlayerNemAtTime(player, t);
      
      if (!currentSeg || currentSeg.nem !== nem) {
        if (currentSeg) segments.push(currentSeg);
        currentSeg = { ...player, nem, startIdx: t, endIdx: t };
      } else {
        currentSeg.endIdx = t;
      }
    }
    if (currentSeg) segments.push(currentSeg);
    
    return segments;
  };
  
  // ëª¨ë“  í”Œë ˆì´ì–´ì˜ ì„¸ê·¸ë¨¼íŠ¸ ìƒì„±
  const allSegments = players.flatMap(createSegments);
  
  // ë„¤ì„ë“œë³„ ì„¸ê·¸ë¨¼íŠ¸ ë¶„ë¥˜
  const nemSegsMap = {};
  nemNames.forEach(nem => {
    nemSegsMap[nem] = allSegments.filter(s => s.nem === nem);
  });
  
  // ë„¤ì„ë“œë³„ ê³ ìœ  í”Œë ˆì´ì–´ (í¸ì§‘ ëª¨ë“œì™€ ë™ì¼í•œ ë°©ì‹)
  const getUniquePlayersForNem = (nemType) => {
    const seen = new Set();
    const result = [];
    players.forEach(p => {
      if (seen.has(p.ë‹‰ë„¤ì„)) return;
      const { startIdx, endIdx } = getTimeRange(p.ì‹œì‘ì‹œê°„, p.ì¢…ë£Œì‹œê°„);
      for (let t = startIdx; t <= endIdx; t++) {
        if (getPlayerNemAtTime(p, t) === nemType) {
          seen.add(p.ë‹‰ë„¤ì„);
          result.push(p);
          break;
        }
      }
    });
    return result;
  };
  
  // ë„¤ì„ë“œë³„ ë ˆì¸ë§µ (nemLaneOrders ê¸°ë°˜ - í¸ì§‘ ëª¨ë“œì™€ ë™ì¼)
  const nemLaneMap = {};
  const nemLaneCount = {};
  nemNames.forEach(nem => {
    const uniquePlayers = getUniquePlayersForNem(nem);
    
    // nemLaneOrdersì— ì—†ëŠ” í”Œë ˆì´ì–´ ì¶”ê°€
    uniquePlayers.forEach(p => {
      if (!nemLaneOrders[nem].includes(p.ë‹‰ë„¤ì„)) {
        nemLaneOrders[nem].push(p.ë‹‰ë„¤ì„);
      }
    });
    
    // nemLaneOrders ìˆœì„œëŒ€ë¡œ ì •ë ¬ (ì €ì¥ëœ ìˆœì„œ ìœ ì§€)
    const sorted = nemLaneOrders[nem]
      .filter(name => uniquePlayers.some(p => p.ë‹‰ë„¤ì„ === name))
      .map(name => uniquePlayers.find(p => p.ë‹‰ë„¤ì„ === name));
    
    const laneMap = {};
    sorted.forEach((p, idx) => laneMap[p.ë‹‰ë„¤ì„] = idx);
    nemLaneMap[nem] = laneMap;
    nemLaneCount[nem] = sorted.length || 1;
  });
  
  // ì„¸ê·¸ë¨¼íŠ¸ì— ë ˆì¸ í• ë‹¹
  nemNames.forEach(nem => {
    nemSegsMap[nem].forEach(seg => {
      seg.lane = nemLaneMap[nem][seg.ë‹‰ë„¤ì„] ?? 0;
    });
  });
  
  // ì‹œê°„ë³„ í™œë™ ì¸ì› ìˆ˜
  const getActiveCount = (segs, timeIdx) => {
    return segs.filter(s => timeIdx >= s.startIdx && timeIdx <= s.endIdx).length;
  };
  
  // ë¸”ë¡ ë Œë”ë§
  const laneWidth = 85; // í¸ì§‘ ëª¨ë“œ ì…€ ë„ˆë¹„ì™€ ë§ì¶¤
  const renderBlocks = (segs, laneCount) => {
    if (segs.length === 0) return '';
    return segs.map(s => {
      const jobInfo = getJobInfo(s.ì§ì—…);
      const top = s.startIdx * ROW_HEIGHT;
      const height = (s.endIdx - s.startIdx + 1) * ROW_HEIGHT - 4;
      const left = s.lane * laneWidth + 2;
      const width = laneWidth - 4;
      const tooltip = s.ë‹‰ë„¤ì„ + (s.ì°¸ê³ ì‚¬í•­ ? ' - ' + s.ì°¸ê³ ì‚¬í•­ : '');
      return `<div class="timeline-block ${jobInfo.class}" style="top:${top}px; height:${height}px; left:${left}px; width:${width}px;" title="${tooltip}">
        <span class="job-icon">${jobInfo.icon}</span>${s.ë‹‰ë„¤ì„}
      </div>`;
    }).join('');
  };
  
  const totalHeight = TIME_ORDER.length * ROW_HEIGHT;
  
  // ë„¤ì„ë“œë³„ ë„ˆë¹„ ê³„ì‚°
  const nemWidths = {};
  nemNames.forEach(nem => {
    nemWidths[nem] = Math.max(nemLaneCount[nem], 1) * laneWidth;
  });
  
  // í…Œì´ë¸” ìµœì†Œ ë„ˆë¹„
  const dividerCount = nemNames.length - 1;
  let tableMinWidth = 70 + 50 + (dividerCount * 1);
  nemNames.forEach(nem => tableMinWidth += nemWidths[nem]);
  
  // í–‰ ìƒì„±
  const requiredCount = getCurrentRaidRequired();
  const rows = TIME_ORDER.map((_, idx) => {
    let total = 0;
    nemNames.forEach(nem => total += getActiveCount(nemSegsMap[nem], idx));
    const highlightClass = total >= requiredCount ? 'highlight' : '';
    
    const nemCells = nemNames.map((nem, i) => {
      const cell = `<td class="nem-block-cell" data-nem="${nem}"></td>`;
      const divider = i < nemNames.length - 1 ? '<td class="divider-cell"></td>' : '';
      return cell + divider;
    }).join('');
    
    return `<tr style="height:${ROW_HEIGHT}px;">
      <td class="time-cell">${TIME_LABELS[idx]}</td>
      ${nemCells}
      <td class="total-cell ${highlightClass}">${total}ëª…</td>
    </tr>`;
  }).join('');
  
  // í—¤ë” ìƒì„±
  const nemHeaders = nemNames.map((nem, i) => {
    const config = NEM_CONFIG[i + 1];
    const header = `<th class="${config.class}" style="width:${nemWidths[nem]}px;">${config.icon} ${nem}</th>`;
    const divider = i < nemNames.length - 1 ? '<th class="divider-header"></th>' : '';
    return header + divider;
  }).join('');
  
  container.innerHTML = `
    <div class="table-scroll-wrapper">
      <table class="schedule-table timeline-table" style="min-width:${tableMinWidth}px;">
        <thead>
          <tr>
            <th class="time-header">ì‹œê°„</th>
            ${nemHeaders}
            <th class="total">í•©ê³„</th>
          </tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>
    </div>
  `;
  
  // ì²« ë²ˆì§¸ í–‰ì— ë¸”ë¡ ì»¨í…Œì´ë„ˆ ì‚½ì…
  const firstRow = container.querySelector('tbody tr');
  nemNames.forEach(nem => {
    const cell = firstRow.querySelector(`.nem-block-cell[data-nem="${nem}"]`);
    if (cell) {
      cell.innerHTML = `<div class="blocks-container" style="height:${totalHeight}px;">${renderBlocks(nemSegsMap[nem], nemLaneCount[nem])}</div>`;
      cell.setAttribute('rowspan', TIME_ORDER.length);
    }
  });
  
  // divider-cellë„ rowspan ì„¤ì •
  firstRow.querySelectorAll('.divider-cell').forEach(cell => {
    cell.setAttribute('rowspan', TIME_ORDER.length);
  });
  
  // ë‚˜ë¨¸ì§€ í–‰ì˜ ë¸”ë¡ ì…€ + divider ì œê±°
  const allRows = container.querySelectorAll('tbody tr');
  for (let i = 1; i < allRows.length; i++) {
    allRows[i].querySelectorAll('.nem-block-cell, .divider-cell').forEach(cell => cell.remove());
  }
}

// í¸ì§‘ ëª¨ë“œ - ë™ì  ë„¤ì„ë“œ ìˆ˜ ì§€ì›
function renderEditMode(container, players) {
  const namedCount = getCurrentRaidNamedCount();
  const nemNames = Array.from({length: namedCount}, (_, i) => `${i+1}ë„´`);
  
  // í”Œë ˆì´ì–´ì— ì‹œê°„ ì •ë³´ ì¶”ê°€
  const processedPlayers = players.map(p => {
    const { startIdx, endIdx } = getTimeRange(p.ì‹œì‘ì‹œê°„, p.ì¢…ë£Œì‹œê°„);
    return { ...p, startIdx, endIdx };
  });
  
  // íŠ¹ì • ì‹œê°„ëŒ€ì— íŠ¹ì • ë„¤ì„ë“œë¡œ í™œë™ ì¤‘ì¸ í”Œë ˆì´ì–´ë“¤
  const getPlayersAtTimeForNem = (timeIdx, nemType) => {
    return processedPlayers.filter(p => {
      if (timeIdx < p.startIdx || timeIdx > p.endIdx) return false;
      return getPlayerNemAtTime(p, timeIdx) === nemType;
    });
  };
  
  // ë„¤ì„ë“œë³„ ê³ ìœ  í”Œë ˆì´ì–´ ëª©ë¡ (ë ˆì¸ ë°°ì¹˜ìš©)
  const getUniquePlayersForNem = (nemType) => {
    const seen = new Set();
    const result = [];
    processedPlayers.forEach(p => {
      if (seen.has(p.ë‹‰ë„¤ì„)) return;
      for (let t = p.startIdx; t <= p.endIdx; t++) {
        if (getPlayerNemAtTime(p, t) === nemType) {
          seen.add(p.ë‹‰ë„¤ì„);
          result.push(p);
          break;
        }
      }
    });
    return result;
  };
  
  // ë„¤ì„ë“œë³„ í”Œë ˆì´ì–´ ë° ë ˆì¸ ì •ë³´
  const nemData = {};
  nemNames.forEach(nem => {
    const players = getUniquePlayersForNem(nem);
    const names = players.map(p => p.ë‹‰ë„¤ì„);
    
    // nemLaneOrders ê¸°ë°˜ ì •ë ¬ (ì €ì¥ëœ ìˆœì„œ ìš°ì„ , ìƒˆ í”Œë ˆì´ì–´ëŠ” ëì—)
    names.forEach(n => {
      if (!nemLaneOrders[nem].includes(n)) nemLaneOrders[nem].push(n);
    });
    
    // ì €ì¥ëœ ìˆœì„œëŒ€ë¡œ ì •ë ¬
    const sorted = nemLaneOrders[nem]
      .filter(n => names.includes(n))
      .map(n => players.find(p => p.ë‹‰ë„¤ì„ === n))
      .filter(Boolean);
    
    const laneMap = {};
    sorted.forEach((p, idx) => laneMap[p.ë‹‰ë„¤ì„] = idx);
    
    nemData[nem] = {
      players,
      laneMap,
      laneCount: sorted.length || 1
    };
  });
  
  // ì…€ ë Œë”ë§
  const renderCells = (timeIdx, nemType) => {
    const { laneMap, laneCount } = nemData[nemType];
    if (laneCount === 0) return '<td class="players-cell"><span class="empty-cell">-</span></td>';
    
    const playersAtTime = getPlayersAtTimeForNem(timeIdx, nemType);
    const cells = new Array(laneCount).fill(null);
    
    playersAtTime.forEach(p => {
      const lane = laneMap[p.ë‹‰ë„¤ì„];
      if (lane !== undefined) cells[lane] = p;
    });
    
    return cells.map((p, lane) => {
      if (p) {
        const jobInfo = getJobInfo(p.ì§ì—…);
        const isHidden = p.hiddenTimes && p.hiddenTimes.includes(timeIdx);
        const disabledClass = isHidden ? 'disabled' : '';
        return `<td class="player-lane-cell">
          <span class="player-chip ${jobInfo.class} ${disabledClass}" 
                data-player="${p.ë‹‰ë„¤ì„}" 
                data-nem="${nemType}" 
                data-time="${timeIdx}"
                title="${p.ì°¸ê³ ì‚¬í•­ || ''}">
            <span class="job-icon">${jobInfo.icon}</span>${p.ë‹‰ë„¤ì„}
          </span>
        </td>`;
      } else {
        return '<td class="player-lane-cell empty"></td>';
      }
    }).join('');
  };
  
  // ì‹œê°„ë³„ í™œë™ ì¸ì› ìˆ˜ (hiddenTimes ì œì™¸)
  const getActiveCount = (timeIdx, nemType) => {
    return getPlayersAtTimeForNem(timeIdx, nemType).filter(p => {
      if (p.hiddenTimes && p.hiddenTimes.includes(timeIdx)) return false;
      return true;
    }).length;
  };
  
  const requiredCount = getCurrentRaidRequired();
  const rows = TIME_ORDER.map((_, idx) => {
    let total = 0;
    nemNames.forEach(nem => total += getActiveCount(idx, nem));
    const highlightClass = total >= requiredCount ? 'highlight' : '';
    
    // ë„¤ì„ë“œë³„ ì…€ + êµ¬ë¶„ì„  ìƒì„±
    const nemCellsHtml = nemNames.map((nem, i) => {
      const cells = renderCells(idx, nem);
      const divider = i < nemNames.length - 1 ? '<td class="divider-cell"></td>' : '';
      return cells + divider;
    }).join('');
    
    return `
      <tr>
        <td class="time-cell">${TIME_LABELS[idx]}</td>
        ${nemCellsHtml}
        <td class="total-cell ${highlightClass}">${total}ëª…</td>
      </tr>
    `;
  }).join('');
  
  // í—¤ë” ìƒì„±
  const nemHeadersHtml = nemNames.map((nem, i) => {
    const config = NEM_CONFIG[i + 1];
    const { laneCount } = nemData[nem];
    const divider = i < nemNames.length - 1 ? '<th class="divider-header"></th>' : '';
    return `<th class="${config.class}" colspan="${laneCount}">${config.icon} ${nem}</th>${divider}`;
  }).join('');
  
  container.innerHTML = `
    <div class="table-scroll-wrapper">
      <table class="schedule-table edit-table">
        <thead>
          <tr>
            <th class="time-header">ì‹œê°„</th>
            ${nemHeadersHtml}
            <th class="total">í•©ê³„</th>
          </tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>
    </div>
  `;
}

// ì°¸ê³ ì‚¬í•­ ë Œë”ë§ - ì°¸ê³ ì‚¬í•­ ìˆëŠ” ì‚¬ëŒë§Œ!
function renderNotes() {
  const notes = allPlayers
    .filter(p => p.ì°¸ê³ ì‚¬í•­ && p.ì°¸ê³ ì‚¬í•­.trim() !== '' && p.ë ˆì´ë“œì¢…ë¥˜ === currentRaidType)
    .map(p => ({ name: p.ë‹‰ë„¤ì„, note: p.ì°¸ê³ ì‚¬í•­ }));
  
  const container = document.getElementById('notes-section');
  
  if (notes.length > 0) {
    container.innerHTML = `
      <div class="notes">
        <h3>ğŸ“Œ ì°¸ê³  ì‚¬í•­</h3>
        ${notes.map(n => `<div class="note-item"><span class="name">${n.name}</span> â€” ${n.note}</div>`).join('')}
      </div>
    `;
  } else {
    container.innerHTML = '';
  }
}

// === ë“±ë¡ í¼ ===

document.querySelectorAll('.day-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    btn.classList.toggle('selected');
  });
});

function getSelectedDays() {
  const days = [];
  document.querySelectorAll('.day-btn.selected').forEach(btn => {
    days.push(btn.dataset.day);
  });
  return days;
}

function showMessage(elementId, type, text) {
  const el = document.getElementById(elementId);
  el.innerHTML = `<div class="message ${type}">${text}</div>`;
  setTimeout(() => { el.innerHTML = ''; }, 5000);
}

// ë‚´ ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸° - ìˆ˜ì •ë¨
// í˜„ì¬ ë¶ˆëŸ¬ì˜¨ ì‹ ì²­ ì •ë³´ (ì‚­ì œìš©)
let loadedRegistrationId = null;

async function loadMyInfo() {
  const nickname = document.getElementById('nickname').value.trim();
  if (!nickname) {
    showMessage('register-message', 'error', 'ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”');
    return;
  }

  const btn = document.querySelector('.search-btn');
  btn.disabled = true;
  btn.textContent = 'ê²€ìƒ‰ ì¤‘...';
  
  // ì‚­ì œ ë²„íŠ¼ ì´ˆê¸°í™”
  loadedRegistrationId = null;
  document.getElementById('delete-registration-btn').style.display = 'none';

  try {
    const response = await fetch(WEBHOOK_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ action: 'get', data: { 'ë‹‰ë„¤ì„': nickname } })
    });
    const result = await response.json();
    
    console.log('ë¶ˆëŸ¬ì˜¤ê¸° ê²°ê³¼:', result); // ë””ë²„ê¹…ìš©
    
    if (result.success && result.data) {
      const d = result.data;
      
      // ì‹ ì²­ ID ì €ì¥ (ì‚­ì œìš©)
      loadedRegistrationId = d.id;
      if (loadedRegistrationId) {
        document.getElementById('delete-registration-btn').style.display = 'block';
      }
      
      // í¼ í•„ë“œ ì±„ìš°ê¸° (ìˆœì„œ ì¤‘ìš”: ë ˆì´ë“œ â†’ ë„¤ì„ë“œ ì˜µì…˜ ì—…ë°ì´íŠ¸ â†’ ë„¤ì„ë“œ ì„ íƒ)
      document.getElementById('job').value = d.ì§ì—… || '';
      document.getElementById('raidType').value = d.ë ˆì´ë“œì¢…ë¥˜ || raidSettings[0]?.ë ˆì´ë“œëª… || '';
      updateNamedOptions(); // ë ˆì´ë“œ ë³€ê²½ í›„ ë„¤ì„ë“œ ì˜µì…˜ ì—…ë°ì´íŠ¸
      document.getElementById('named').value = d.ë„¤ì„ë“œ || '';
      document.getElementById('startTime').value = d.ì‹œì‘ì‹œê°„ || 'ìƒê´€ì—†ìŒ';
      document.getElementById('endTime').value = d.ì¢…ë£Œì‹œê°„ || 'ìƒê´€ì—†ìŒ';
      document.getElementById('note').value = d.ì°¸ê³ ì‚¬í•­ || '';
      
      // ëª»í•˜ëŠ” ìš”ì¼ ì„¤ì •
      document.querySelectorAll('.day-btn').forEach(btn => {
        btn.classList.remove('selected');
      });
      
      if (d.ëª»í•˜ëŠ”ìš”ì¼ && Array.isArray(d.ëª»í•˜ëŠ”ìš”ì¼)) {
        d.ëª»í•˜ëŠ”ìš”ì¼.forEach(day => {
          const btn = document.querySelector(`.day-btn[data-day="${day}"]`);
          if (btn) btn.classList.add('selected');
        });
      }
      
      showMessage('register-message', 'success', `${nickname}ë‹˜ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤`);
    } else {
      showMessage('register-message', 'info', 'ë“±ë¡ëœ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤. ìƒˆë¡œ ë“±ë¡í•´ì£¼ì„¸ìš”.');
    }
  } catch (error) {
    console.error('ë¶ˆëŸ¬ì˜¤ê¸° ì—ëŸ¬:', error);
    showMessage('register-message', 'error', 'ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ' + error.message);
  } finally {
    btn.disabled = false;
    btn.textContent = 'ë¶ˆëŸ¬ì˜¤ê¸°';
  }
}

// ë‚´ ì‹ ì²­ ì‚­ì œ
async function deleteMyRegistration() {
  const nickname = document.getElementById('nickname').value.trim();
  
  // loadedRegistrationIdê°€ ì—†ìœ¼ë©´ allPlayersì—ì„œ ì°¾ê¸°
  let playerId = loadedRegistrationId;
  if (!playerId) {
    const player = allPlayers.find(p => p.ë‹‰ë„¤ì„ === nickname);
    playerId = player?.id;
  }
  
  if (!playerId) {
    showToast('ì‚­ì œí•  ì‹ ì²­ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤', 'error');
    return;
  }
  
  const confirmed = await showConfirm(`${nickname}ë‹˜ì˜ ì°¸ê°€ ì‹ ì²­ì„ ì·¨ì†Œí• ê¹Œìš”?`);
  if (!confirmed) return;
  
  try {
    const response = await fetch(WEBHOOK_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ action: 'deletePlayer', id: playerId })
    });
    
    if (response.ok) {
      showToast('ì‹ ì²­ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
      closeModal('register-modal');
      
      // ë¡œì»¬ì—ì„œë„ ì œê±°
      const idx = allPlayers.findIndex(p => p.id === playerId);
      if (idx !== -1) allPlayers.splice(idx, 1);
      
      loadedRegistrationId = null;
      renderSchedule();
    } else {
      showToast('ì·¨ì†Œ ì‹¤íŒ¨', 'error');
    }
  } catch (error) {
    showToast('ì·¨ì†Œ ì‹¤íŒ¨: ' + error.message, 'error');
  }
}

async function submitForm() {
  const nickname = document.getElementById('nickname').value.trim();
  const job = document.getElementById('job').value;
  
  if (!nickname) {
    showMessage('register-message', 'error', 'ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”');
    return;
  }
  if (!job) {
    showMessage('register-message', 'error', 'ì§ì—…ì„ ì„ íƒí•˜ì„¸ìš”');
    return;
  }

  const weekStart = currentWeekStart || getCurrentWeekStart();
  const data = {
    'ë‹‰ë„¤ì„': nickname,
    'ì§ì—…': job,
    'ë„¤ì„ë“œ': document.getElementById('named').value || '',
    'ì‹œì‘ì‹œê°„': document.getElementById('startTime').value,
    'ì¢…ë£Œì‹œê°„': document.getElementById('endTime').value,
    'ëª»í•˜ëŠ”ìš”ì¼': getSelectedDays(),
    'ë ˆì´ë“œì¢…ë¥˜': document.getElementById('raidType').value,
    'ì°¸ê³ ì‚¬í•­': document.getElementById('note').value || '',
    'weekStart': weekStart,
    'weekEnd': getWeekEnd(weekStart)
  };

  const btn = document.querySelector('.submit-btn');
  btn.disabled = true;
  btn.textContent = 'ì €ì¥ ì¤‘...';

  try {
    const response = await fetch(WEBHOOK_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ action: 'register', data })
    });
    
    // ì‘ë‹µ í…ìŠ¤íŠ¸ ë¨¼ì € ë°›ê¸°
    const text = await response.text();
    let result;
    
    try {
      result = text ? JSON.parse(text) : { success: response.ok };
    } catch {
      // JSON íŒŒì‹± ì‹¤íŒ¨ì‹œ ì‘ë‹µ ìƒíƒœë¡œ íŒë‹¨
      result = { success: response.ok };
    }
    
    if (result.success || response.ok) {
      showMessage('register-message', 'success', 'ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
      setTimeout(async () => {
        closeModal('register-modal');
        await loadPlayerList(); // ì‹¤ì‹œê°„ ë°˜ì˜
        renderSchedule();
      }, 500);
    } else {
      showMessage('register-message', 'error', 'ì €ì¥ ì‹¤íŒ¨: ' + (result.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
    }
  } catch (error) {
    showMessage('register-message', 'error', 'ì €ì¥ ì‹¤íŒ¨: ' + error.message);
  } finally {
    btn.disabled = false;
    btn.textContent = 'ì €ì¥í•˜ê¸°';
  }
}

// ============================================
// ë°•ìŠ¤ ì„ íƒ, ë“œë˜ê·¸ ë“œë¡­, ë¹„í™œì„±í™”, Undo
// ============================================
// selectedChips: "ë‹‰ë„¤ì„|ì‹œê°„ì¸ë±ìŠ¤" í˜•íƒœë¡œ ì €ì¥
let selectedChips = new Set();
let isSelecting = false;
let selectionStart = { x: 0, y: 0 };
let isDragging = false;
let undoStack = [];
const MAX_UNDO = 50;

// ìƒíƒœ ì €ì¥ (Undoìš©)
function saveState() {
  const state = allPlayers.map(p => ({
    ë‹‰ë„¤ì„: p.ë‹‰ë„¤ì„,
    ë„¤ì„ë“œ: p.ë„¤ì„ë“œ,
    timeNemMap: p.timeNemMap ? {...p.timeNemMap} : {},
    hiddenTimes: p.hiddenTimes ? [...p.hiddenTimes] : []
  }));
  undoStack.push(JSON.stringify(state));
  if (undoStack.length > MAX_UNDO) undoStack.shift();
}

// Undo ì‹¤í–‰
function undo() {
  if (undoStack.length === 0) return;
  const state = JSON.parse(undoStack.pop());
  state.forEach(saved => {
    const player = allPlayers.find(p => p.ë‹‰ë„¤ì„ === saved.ë‹‰ë„¤ì„);
    if (player) {
      player.ë„¤ì„ë“œ = saved.ë„¤ì„ë“œ;
      player.timeNemMap = saved.timeNemMap || {};
      player.hiddenTimes = saved.hiddenTimes || [];
    }
  });
  clearSelection();
  renderSchedule();
}

// í¸ì§‘ ëª¨ë“œ í† ê¸€
function toggleEditMode() {
  const btn = document.getElementById('edit-mode-btn');
  
  // ì§€ë‚œ ì£¼ì°¨ë©´ í¸ì§‘ ëª¨ë“œ ì§„ì… ì°¨ë‹¨
  if (currentMode === 'view' && !isCurrentWeek()) {
    showToast('ì§€ë‚œ ì£¼ì°¨ëŠ” í¸ì§‘í•  ìˆ˜ ì—†ì–´ìš”ğŸŒ™');
    return;
  }
  
  if (currentMode === 'view') {
    currentMode = 'edit';
    btn.textContent = 'âœï¸ í¸ì§‘ ëª¨ë“œ';
    btn.classList.add('active');
    document.getElementById('edit-hint').style.display = 'block';
  } else {
    currentMode = 'view';
    btn.textContent = 'âœ… í¸ì§‘ ì™„ë£Œ';
    btn.classList.remove('active');
    document.getElementById('edit-hint').style.display = 'none';
    clearSelection();
  }
  
  renderSchedule();
}

// ì„ íƒ ì´ˆê¸°í™”
function clearSelection() {
  selectedChips.clear();
  document.querySelectorAll('.player-chip.selected').forEach(chip => {
    chip.classList.remove('selected');
  });
  updateMoveControls();
}

// ì´ë™ ì»¨íŠ¸ë¡¤ ì—…ë°ì´íŠ¸
function updateMoveControls() {
  const controls = document.getElementById('move-controls');
  const countEl = document.getElementById('selected-count');
  
  // ì„ íƒëœ ê³ ìœ  í”Œë ˆì´ì–´ ìˆ˜ ê³„ì‚°
  const uniquePlayers = new Set();
  selectedChips.forEach(key => {
    const [name] = key.split('|');
    uniquePlayers.add(name);
  });
  
  if (selectedChips.size > 0) {
    controls.classList.add('active');
    countEl.textContent = `${uniquePlayers.size}ëª… (${selectedChips.size}ì¹¸) ì„ íƒë¨`;
  } else {
    controls.classList.remove('active');
  }
}

// ì„ íƒëœ ì¹©ë“¤ ì´ë™ (ì‹œê°„ëŒ€ë³„)
function moveSelectedTo(targetNem, targetLaneIdx = -1) {
  if (selectedChips.size === 0) return;
  
  saveState();
  
  // ì´ë™í•  í”Œë ˆì´ì–´ ë‹‰ë„¤ì„ë“¤ ìˆ˜ì§‘
  const movingPlayers = new Set();
  selectedChips.forEach(key => {
    const [name] = key.split('|');
    movingPlayers.add(name);
  });
  
  // ë ˆì¸ ìˆœì„œ ì—…ë°ì´íŠ¸
  const targetOrder = nemLaneOrders[targetNem];
  
  // ê¸°ì¡´ ìœ„ì¹˜ì—ì„œ ì œê±° (ëª¨ë“  ë„¤ì„ë“œì—ì„œ)
  movingPlayers.forEach(name => {
    Object.keys(nemLaneOrders).forEach(nem => {
      const idx = nemLaneOrders[nem].indexOf(name);
      if (idx !== -1) nemLaneOrders[nem].splice(idx, 1);
    });
  });
  
  // ìƒˆ ìœ„ì¹˜ì— ì‚½ì…
  const playersArray = Array.from(movingPlayers);
  if (targetLaneIdx === -1 || targetLaneIdx >= targetOrder.length) {
    // ë§¨ ë’¤ì— ì¶”ê°€
    targetOrder.push(...playersArray);
  } else {
    // ì§€ì • ìœ„ì¹˜ì— ì‚½ì…
    targetOrder.splice(targetLaneIdx, 0, ...playersArray);
  }
  
  // ì„ íƒëœ ì‹œê°„ëŒ€ë“¤ì˜ ë„¤ì„ë“œ ë³€ê²½
  selectedChips.forEach(key => {
    const [name, timeIdxStr] = key.split('|');
    const timeIdx = parseInt(timeIdxStr);
    const player = allPlayers.find(p => p.ë‹‰ë„¤ì„ === name);
    
    if (player) {
      if (!player.timeNemMap) player.timeNemMap = {};
      player.timeNemMap[timeIdx] = targetNem;
    }
  });
  
  // ìˆœì„œ ì €ì¥
  saveNemLaneOrders();
  
  clearSelection();
  renderSchedule();
}

// ì„ íƒëœ ì¹©ë“¤ ë¹„í™œì„±í™” (Delete)
function disableSelected() {
  if (selectedChips.size === 0) return;
  
  saveState();
  
  // í”Œë ˆì´ì–´ë³„ë¡œ ì„ íƒëœ ì‹œê°„ëŒ€ ìˆ˜ì§‘
  const playerTimes = {};
  selectedChips.forEach(key => {
    const [name, timeIdx] = key.split('|');
    if (!playerTimes[name]) playerTimes[name] = [];
    playerTimes[name].push(parseInt(timeIdx));
  });
  
  // ê° í”Œë ˆì´ì–´ì˜ ì„ íƒëœ ì‹œê°„ëŒ€ í† ê¸€
  Object.entries(playerTimes).forEach(([name, times]) => {
    const player = allPlayers.find(p => p.ë‹‰ë„¤ì„ === name);
    if (player) {
      if (!player.hiddenTimes) player.hiddenTimes = [];
      
      // ì„ íƒëœ ì‹œê°„ë“¤ì´ ì´ë¯¸ ë‹¤ ìˆ¨ê²¨ì ¸ ìˆìœ¼ë©´ ë³µì›, ì•„ë‹ˆë©´ ìˆ¨ê¹€
      const allHidden = times.every(t => player.hiddenTimes.includes(t));
      if (allHidden) {
        player.hiddenTimes = player.hiddenTimes.filter(t => !times.includes(t));
      } else {
        times.forEach(t => {
          if (!player.hiddenTimes.includes(t)) player.hiddenTimes.push(t);
        });
      }
    }
  });
  
  clearSelection();
  renderSchedule();
}

// ì„ íƒì˜ì—­ ì™¸ ë¹„í™œì„±í™” (Ctrl+Delete)
function disableUnselected() {
  if (selectedChips.size === 0) return;
  
  saveState();
  
  // í”Œë ˆì´ì–´ë³„ë¡œ ì„ íƒëœ ì‹œê°„ëŒ€ ìˆ˜ì§‘
  const playerSelectedTimes = {};
  selectedChips.forEach(key => {
    const [name, timeIdx] = key.split('|');
    if (!playerSelectedTimes[name]) playerSelectedTimes[name] = [];
    playerSelectedTimes[name].push(parseInt(timeIdx));
  });
  
  // ì„ íƒëœ í”Œë ˆì´ì–´ë“¤ë§Œ ì²˜ë¦¬
  Object.entries(playerSelectedTimes).forEach(([name, selectedTimes]) => {
    const player = allPlayers.find(p => p.ë‹‰ë„¤ì„ === name);
    if (player) {
      const { startIdx, endIdx } = getTimeRange(player.ì‹œì‘ì‹œê°„, player.ì¢…ë£Œì‹œê°„);
      
      // ì„ íƒë˜ì§€ ì•Šì€ ì‹œê°„ëŒ€ë¥¼ hiddenìœ¼ë¡œ
      player.hiddenTimes = [];
      for (let t = startIdx; t <= endIdx; t++) {
        if (!selectedTimes.includes(t)) {
          player.hiddenTimes.push(t);
        }
      }
    }
  });
  
  clearSelection();
  renderSchedule();
}

// ì„ íƒëœ í”Œë ˆì´ì–´ DBì—ì„œ ì‚­ì œ
async function deleteSelectedPlayers() {
  if (selectedChips.size === 0) return;
  
  // ì„ íƒëœ í”Œë ˆì´ì–´ ë‹‰ë„¤ì„ë“¤ ìˆ˜ì§‘
  const playerNames = new Set();
  selectedChips.forEach(key => {
    const [name] = key.split('|');
    playerNames.add(name);
  });
  
  // ì‚­ì œí•  í”Œë ˆì´ì–´ ì •ë³´ ìˆ˜ì§‘
  const playersToDelete = [];
  playerNames.forEach(name => {
    const player = allPlayers.find(p => p.ë‹‰ë„¤ì„ === name);
    if (player && player.id) {
      playersToDelete.push(player);
    }
  });
  
  if (playersToDelete.length === 0) {
    showToast('ì‚­ì œí•  ì°¸ê°€ì ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤', 'error');
    return;
  }
  
  // í™•ì¸
  const names = playersToDelete.map(p => p.ë‹‰ë„¤ì„).join(', ');
  const confirmed = await showConfirm(`${names} ì°¸ê°€ìë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì‚­ì œëœ ë°ì´í„°ëŠ” ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
  if (!confirmed) return;
  
  // ì‚­ì œ ìš”ì²­
  let successCount = 0;
  for (const player of playersToDelete) {
    try {
      const response = await fetch(WEBHOOK_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ action: 'deletePlayer', id: player.id })
      });
      
      if (response.ok) {
        successCount++;
        // ë¡œì»¬ì—ì„œë„ ì œê±°
        const idx = allPlayers.findIndex(p => p.id === player.id);
        if (idx !== -1) allPlayers.splice(idx, 1);
      }
    } catch (error) {
      console.error('ì‚­ì œ ì‹¤íŒ¨:', player.ë‹‰ë„¤ì„, error);
    }
  }
  
  if (successCount > 0) {
    showToast(`${successCount}ëª… ì‚­ì œë¨`, 'success');
    clearSelection();
    renderSchedule();
  } else {
    showToast('ì‚­ì œ ì‹¤íŒ¨', 'error');
  }
}

// ============================================
// ìš°í´ë¦­ ì»¨í…ìŠ¤íŠ¸ ë©”ë‰´
// ============================================
function showContextMenu(e) {
  const menu = document.getElementById('context-menu');
  
  // í™”ë©´ ê²½ê³„ ì²´í¬
  let x = e.clientX;
  let y = e.clientY;
  
  menu.style.display = 'block';
  const menuRect = menu.getBoundingClientRect();
  
  if (x + menuRect.width > window.innerWidth) {
    x = window.innerWidth - menuRect.width - 10;
  }
  if (y + menuRect.height > window.innerHeight) {
    y = window.innerHeight - menuRect.height - 10;
  }
  
  menu.style.left = x + 'px';
  menu.style.top = y + 'px';
}

function hideContextMenu() {
  document.getElementById('context-menu').style.display = 'none';
}

document.addEventListener('contextmenu', (e) => {
  if (currentMode !== 'edit') return;
  
  const chip = e.target.closest('.player-chip');
  if (chip) {
    e.preventDefault();
    
    // ìš°í´ë¦­í•œ ì¹©ì´ ì„ íƒ ì•ˆ ë¼ìˆìœ¼ë©´ ê·¸ ì¹©ë§Œ ì„ íƒ
    const nickname = chip.dataset.player;
    const timeIdx = chip.dataset.time;
    const key = `${nickname}|${timeIdx}`;
    
    if (!selectedChips.has(key)) {
      clearSelection();
      selectedChips.add(key);
      chip.classList.add('selected');
      updateMoveControls();
    }
    
    showContextMenu(e);
  }
});

// ë‹¤ë¥¸ ê³³ í´ë¦­í•˜ë©´ ë©”ë‰´ ë‹«ê¸°
document.addEventListener('click', () => {
  hideContextMenu();
});

// í‚¤ë³´ë“œ ì´ë²¤íŠ¸
document.addEventListener('keydown', (e) => {
  // ESC: ì„ íƒ ì·¨ì†Œ + ë©”ë‰´ ë‹«ê¸°
  if (e.key === 'Escape') {
    hideContextMenu();
    clearSelection();
    return;
  }
  
  // Ctrl+Z: ì„ íƒ ìˆìœ¼ë©´ ì„ íƒ ì·¨ì†Œ, ì—†ìœ¼ë©´ ë˜ëŒë¦¬ê¸°
  if (e.ctrlKey && e.key === 'z') {
    e.preventDefault();
    if (selectedChips.size > 0) {
      clearSelection();
    } else {
      undo();
    }
    return;
  }
  
  // Delete ê´€ë ¨
  if (e.key === 'Delete' && currentMode === 'edit' && selectedChips.size > 0) {
    e.preventDefault();
    if (e.ctrlKey) {
      disableUnselected(); // Ctrl+Delete: ì„ íƒì˜ì—­ ì™¸ ë¹„í™œì„±í™”
    } else {
      disableSelected(); // Delete: ì„ íƒì˜ì—­ ë¹„í™œì„±í™”
    }
  }
});

// ============================================
// ë°•ìŠ¤ ì„ íƒ ì´ë²¤íŠ¸ (ë“œë˜ê·¸)
// ============================================
document.addEventListener('pointerdown', (e) => {
  if (currentMode !== 'edit') return;
  
  const clickedChip = e.target.closest('.player-chip');
  
  // ì¹© í´ë¦­ - ê·¸ëƒ¥ í´ë¦­ìœ¼ë¡œ í† ê¸€
  if (clickedChip) {
    const nickname = clickedChip.dataset.player;
    const timeIdx = clickedChip.dataset.time;
    const key = `${nickname}|${timeIdx}`;
    
    if (clickedChip.classList.contains('selected')) {
      // ì„ íƒëœ ì¹© í´ë¦­
      if (e.shiftKey) {
        // Shift+í´ë¦­: ì„ íƒ í•´ì œ
        selectedChips.delete(key);
        clickedChip.classList.remove('selected');
      } else {
        // ì¼ë°˜ í´ë¦­: ë“œë˜ê·¸ ì¤€ë¹„ (pointerupì—ì„œ í† ê¸€ ì²˜ë¦¬)
        isDragging = true;
        const uniquePlayers = new Set();
        selectedChips.forEach(k => uniquePlayers.add(k.split('|')[0]));
        
        const ghost = document.getElementById('drag-ghost');
        ghost.textContent = `${uniquePlayers.size}ëª… ì´ë™`;
        ghost.style.left = e.clientX + 10 + 'px';
        ghost.style.top = e.clientY + 10 + 'px';
        ghost.style.display = 'block';
      }
    } else {
      // ì„ íƒ ì•ˆ ëœ ì¹© í´ë¦­ = ì„ íƒ ì¶”ê°€ (í† ê¸€)
      selectedChips.add(key);
      clickedChip.classList.add('selected');
    }
    
    updateMoveControls();
    e.preventDefault();
    return;
  }
  
  // ë¹ˆ ê³µê°„ì—ì„œ ë“œë˜ê·¸: ë°•ìŠ¤ ì„ íƒ
  if (!isDragging) {
    isSelecting = true;
    selectionStart = { x: e.clientX, y: e.clientY };
    
    const box = document.getElementById('selection-box');
    box.style.left = e.clientX + 'px';
    box.style.top = e.clientY + 'px';
    box.style.width = '0';
    box.style.height = '0';
    box.style.display = 'block';
    
    e.preventDefault();
  }
});

document.addEventListener('pointermove', (e) => {
  // ë°•ìŠ¤ ì„ íƒ ì¤‘
  if (isSelecting) {
    const box = document.getElementById('selection-box');
    const x = Math.min(e.clientX, selectionStart.x);
    const y = Math.min(e.clientY, selectionStart.y);
    const w = Math.abs(e.clientX - selectionStart.x);
    const h = Math.abs(e.clientY - selectionStart.y);
    
    box.style.left = x + 'px';
    box.style.top = y + 'px';
    box.style.width = w + 'px';
    box.style.height = h + 'px';
    return;
  }
  
  // ë“œë˜ê·¸ ì´ë™ ì¤‘
  if (isDragging) {
    const ghost = document.getElementById('drag-ghost');
    ghost.style.left = e.clientX + 10 + 'px';
    ghost.style.top = e.clientY + 10 + 'px';
    
    // ë“œë¡­ ì˜ì—­ í•˜ì´ë¼ì´íŠ¸
    document.querySelectorAll('.nem1, .nem2, .nem3, .nem4').forEach(el => el.classList.remove('drop-hover'));
    
    const target = document.elementFromPoint(e.clientX, e.clientY);
    if (target) {
      const th = target.closest('th.nem1, th.nem2, th.nem3, th.nem4');
      if (th) th.classList.add('drop-hover');
    }
  }
});

document.addEventListener('pointerup', (e) => {
  // ë°•ìŠ¤ ì„ íƒ ì™„ë£Œ
  if (isSelecting) {
    isSelecting = false;
    
    const box = document.getElementById('selection-box');
    const boxRect = box.getBoundingClientRect();
    box.style.display = 'none';
    
    // ë°•ìŠ¤ í¬ê¸°ê°€ ë„ˆë¬´ ì‘ìœ¼ë©´ = ë¹ˆ ê³µê°„ í´ë¦­ = ì „ì²´ ì„ íƒ í•´ì œ
    if (boxRect.width < 5 && boxRect.height < 5) {
      clearSelection();
      return;
    }
    
    // ë°•ìŠ¤ ì•ˆì˜ ì¹©ë“¤ë§Œ ì„ íƒ (ê°™ì€ ì´ë¦„ì´ë¼ë„ ì „ì²´ X)
    document.querySelectorAll('.edit-table .player-chip').forEach(chip => {
      const chipRect = chip.getBoundingClientRect();
      
      if (chipRect.left < boxRect.right && 
          chipRect.right > boxRect.left &&
          chipRect.top < boxRect.bottom && 
          chipRect.bottom > boxRect.top) {
        
        const playerName = chip.dataset.player;
        const timeIdx = chip.dataset.time;
        if (playerName && timeIdx !== undefined) {
          const key = `${playerName}|${timeIdx}`;
          selectedChips.add(key);
          chip.classList.add('selected');
        }
      }
    });
    
    updateMoveControls();
    return;
  }
  
  // ë“œë˜ê·¸ ë“œë¡­ ì™„ë£Œ
  if (isDragging) {
    isDragging = false;
    
    const ghost = document.getElementById('drag-ghost');
    ghost.style.display = 'none';
    
    document.querySelectorAll('.nem1, .nem2, .nem3, .nem4').forEach(el => el.classList.remove('drop-hover'));
    
    // ë“œë¡­ ì˜ì—­ íŒë³„
    const target = document.elementFromPoint(e.clientX, e.clientY);
    if (target) {
      // ì¹© ìœ„ì— ë“œë¡­ â†’ ê·¸ ì¹© ì•ì— ì‚½ì…
      const targetChip = target.closest('.player-chip');
      if (targetChip) {
        const targetName = targetChip.dataset.player;
        const targetNem = targetChip.dataset.nem;
        
        if (targetName && targetNem) {
          // í•´ë‹¹ ë„¤ì„ë“œì—ì„œ íƒ€ê²Ÿ ì¹©ì˜ ìœ„ì¹˜ ì°¾ê¸°
          const targetIdx = nemLaneOrders[targetNem].indexOf(targetName);
          moveSelectedTo(targetNem, targetIdx);
          return;
        }
      }
      
      // í—¤ë”ì— ë“œë¡­ â†’ ë§¨ ë’¤ì— ì¶”ê°€
      const th = target.closest('th.nem1, th.nem2, th.nem3, th.nem4');
      if (th) {
        for (let i = 1; i <= 4; i++) {
          if (th.classList.contains(`nem${i}`)) {
            moveSelectedTo(`${i}ë„´`, -1);
            return;
          }
        }
      }
      
      // ì…€(ë¹ˆ ê³µê°„)ì— ë“œë¡­ â†’ í•´ë‹¹ ë„¤ì„ë“œ ë§¨ ë’¤ì— ì¶”ê°€
      const cell = target.closest('td.player-lane-cell');
      if (cell) {
        const row = cell.closest('tr');
        const cells = Array.from(row.children);
        const cellIdx = cells.indexOf(cell);
        
        // ë””ë°”ì´ë” ìœ„ì¹˜ë“¤ ì°¾ê¸°
        const dividerIdxs = cells.map((c, i) => c.classList.contains('divider-cell') ? i : -1).filter(i => i !== -1);
        
        // ì…€ì´ ì–´ëŠ ë„¤ì„ë“œ ì˜ì—­ì¸ì§€ ê²°ì •
        const namedCount = getCurrentRaidNamedCount();
        let targetNem = '1ë„´';
        let regionStart = 1; // ì‹œê°„ ì…€ ì œì™¸
        
        for (let i = 0; i < namedCount; i++) {
          const regionEnd = i < dividerIdxs.length ? dividerIdxs[i] : cells.length - 1;
          if (cellIdx >= regionStart && cellIdx < regionEnd) {
            targetNem = `${i + 1}ë„´`;
            break;
          }
          regionStart = regionEnd + 1;
        }
        
        moveSelectedTo(targetNem, -1);
        return;
      }
    }
    
    clearSelection();
  }
});

// ============================================
// ëª¨ë‹¬ ê´€ë ¨ í•¨ìˆ˜
// ============================================
function openModal(modalId) {
  document.getElementById(modalId).classList.add('active');
  
  // ëª¨ë°”ì¼ì—ì„œ ëª¨ë‹¬ ì—´ë©´ viewport ì •ìƒí™” (input ìë™ì¤Œ ë°©ì§€)
  if (document.body.classList.contains('is-mobile')) {
    const viewport = document.querySelector('meta[name="viewport"]');
    viewport.setAttribute('content', 'width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no');
  }
}

function closeModal(modalId) {
  document.getElementById(modalId).classList.remove('active');
  
  // ëª¨ë°”ì¼ì—ì„œ ëª¨ë‹¬ ë‹«ìœ¼ë©´ viewport ì›ë˜ëŒ€ë¡œ (í…Œì´ë¸” ë³´ê¸°ìš©)
  if (document.body.classList.contains('is-mobile')) {
    const viewport = document.querySelector('meta[name="viewport"]');
    viewport.setAttribute('content', 'width=800, initial-scale=0.5, user-scalable=yes');
  }
}

// ì°¸ê°€ì ë“±ë¡ ëª¨ë‹¬
function openRegisterModal() {
  // ë ˆì´ë“œ ì¢…ë¥˜ select ì—…ë°ì´íŠ¸ (í˜„ì¬ íƒ­ ê¸°ë³¸ ì„ íƒ)
  const select = document.getElementById('raidType');
  select.innerHTML = raidSettings.map(r => 
    `<option value="${r.ë ˆì´ë“œëª…}" ${r.ë ˆì´ë“œëª… === currentRaidType ? 'selected' : ''}>${r.ë ˆì´ë“œëª…}</option>`
  ).join('');
  
  // ì´ˆê¸° ë„¤ì„ë“œ ì˜µì…˜ ì„¤ì •
  updateNamedOptions();
  
  // ì‚­ì œ ë²„íŠ¼ ì´ˆê¸°í™” (ë¶ˆëŸ¬ì˜¤ê¸° ì „ê¹Œì§€ ìˆ¨ê¹€)
  loadedRegistrationId = null;
  document.getElementById('delete-registration-btn').style.display = 'none';
  
  openModal('register-modal');
}

// ë„¤ì„ë“œ ë“œë¡­ë‹¤ìš´ ë™ì  ì—…ë°ì´íŠ¸
function updateNamedOptions() {
  const raidName = document.getElementById('raidType').value;
  const raid = raidSettings.find(r => r.ë ˆì´ë“œëª… === raidName);
  const namedCount = raid?.ë„¤ì„ë“œìˆ˜ || 2;
  
  const select = document.getElementById('named');
  select.innerHTML = '<option value="">ì„ íƒí•˜ì„¸ìš”</option>' + 
    Array.from({length: namedCount}, (_, i) => 
      `<option value="${i+1}ë„´">${i+1}ë„´</option>`
    ).join('');
}

// ê¸°ê°„ ì—†ìŒ í† ê¸€ (ì¶”ê°€ ëª¨ë‹¬)
function toggleNewRaidPeriod() {
  // ë¹„í™œì„±í™”ë¨ (ì£¼ì°¨ ì‹œìŠ¤í…œìœ¼ë¡œ ëŒ€ì²´)
}

// ê¸°ê°„ ì—†ìŒ í† ê¸€ (ì„¤ì • ëª¨ë‹¬)
function toggleEditRaidPeriod() {
  // ë¹„í™œì„±í™”ë¨ (ì£¼ì°¨ ì‹œìŠ¤í…œìœ¼ë¡œ ëŒ€ì²´)
}

// ========== íƒ­ ë“œë˜ê·¸ ìˆœì„œ ==========
let draggedTab = null;

function onTabDragStart(e) {
  draggedTab = e.target;
  e.target.style.opacity = '0.5';
  e.dataTransfer.effectAllowed = 'move';
}

function onTabDragOver(e) {
  e.preventDefault();
  e.dataTransfer.dropEffect = 'move';
  
  const target = e.target.closest('.raid-tab');
  if (target && target !== draggedTab) {
    const container = document.getElementById('raid-tabs');
    const tabs = [...container.querySelectorAll('.raid-tab')];
    const draggedIdx = tabs.indexOf(draggedTab);
    const targetIdx = tabs.indexOf(target);
    
    if (draggedIdx < targetIdx) {
      target.after(draggedTab);
    } else {
      target.before(draggedTab);
    }
  }
}

function onTabDrop(e) {
  e.preventDefault();
}

function onTabDragEnd(e) {
  e.target.style.opacity = '1';
  draggedTab = null;
  saveTabOrder();
}

async function saveTabOrder() {
  const container = document.getElementById('raid-tabs');
  const tabs = [...container.querySelectorAll('.raid-tab')];
  
  // ìˆœì„œ ì—…ë°ì´íŠ¸
  const updates = tabs.map((tab, idx) => ({
    id: tab.dataset.id,
    ìˆœì„œ: idx + 1
  }));
  
  // raidSettings ì—…ë°ì´íŠ¸
  updates.forEach(u => {
    const raid = raidSettings.find(r => r.id === u.id);
    if (raid) raid.ìˆœì„œ = u.ìˆœì„œ;
  });
  
  // ë…¸ì…˜ì— ì €ì¥
  for (const u of updates) {
    await fetch(WEBHOOK_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        action: 'updateRaidOrder',
        data: { id: u.id, ìˆœì„œ: u.ìˆœì„œ }
      })
    });
  }
}

// ë ˆì´ë“œ ì¶”ê°€ ëª¨ë‹¬
function openAddRaidModal() {
  document.getElementById('new-raid-name').value = '';
  document.getElementById('new-raid-named-count').value = '2';
  document.getElementById('new-raid-required').value = '8';
  openModal('add-raid-modal');
}

async function addNewRaid() {
  const name = document.getElementById('new-raid-name').value.trim();
  const namedCount = parseInt(document.getElementById('new-raid-named-count').value);
  const required = parseInt(document.getElementById('new-raid-required').value);
  
  if (!name) {
    showToast('ë ˆì´ë“œ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”ğŸŒ™');
    return;
  }
  
  // ì¤‘ë³µ ì´ë¦„ ì²´í¬
  const duplicate = raidSettings.find(r => r.ë ˆì´ë“œëª… === name);
  if (duplicate) {
    showToast(`"${name}" ì´ë¦„ì˜ ë ˆì´ë“œê°€ ì´ë¯¸ ì¡´ì¬í•´ìš”ğŸŒ™`);
    return;
  }
  
  try {
    const response = await fetch(WEBHOOK_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        action: 'addRaidSetting',
        data: {
          ë ˆì´ë“œëª…: name,
          ë„¤ì„ë“œìˆ˜: namedCount,
          í•„ìš”ì¸ì›: required,
          í™œì„±í™”: true
        }
      })
    });
    
    if (response.ok) {
      showToast('ë ˆì´ë“œê°€ ì¶”ê°€ë˜ì—ˆì–´ìš”ğŸŒ™', 'success');
      closeModal('add-raid-modal');
      await loadRaidSettings();
      renderRaidTabs();
    } else {
      showToast('ì¶”ê°€ì— ì‹¤íŒ¨í–ˆì–´ìš”ğŸŒ™', 'error');
    }
  } catch (error) {
    showToast('ì¶”ê°€ì— ì‹¤íŒ¨í–ˆì–´ìš”ğŸŒ™', 'error');
  }
}

// ë ˆì´ë“œ ì„¤ì • ëª¨ë‹¬
function openRaidSettingsModal() {
  const select = document.getElementById('settings-raid-select');
  select.innerHTML = raidSettings.map(r => 
    `<option value="${r.id}">${r.ë ˆì´ë“œëª…}</option>`
  ).join('');
  
  // í˜„ì¬ ì„ íƒëœ íƒ­ ê¸°ì¤€ìœ¼ë¡œ ì„¤ì •
  const currentRaid = raidSettings.find(r => r.ë ˆì´ë“œëª… === currentRaidType);
  if (currentRaid) {
    select.value = currentRaid.id;
  }
  
  loadRaidSettingsForEdit();
  openModal('raid-settings-modal');
}

function loadRaidSettingsForEdit() {
  const select = document.getElementById('settings-raid-select');
  const selectedId = select.value;
  const raid = raidSettings.find(r => r.id === selectedId);
  
  if (raid) {
    document.getElementById('edit-raid-name').value = raid.ë ˆì´ë“œëª…;
    document.getElementById('edit-raid-named-count').value = raid.ë„¤ì„ë“œìˆ˜ || 2;
    document.getElementById('edit-raid-required').value = raid.í•„ìš”ì¸ì› || 8;
  }
}

async function saveRaidSettings() {
  const selectedId = document.getElementById('settings-raid-select').value;
  const name = document.getElementById('edit-raid-name').value.trim();
  const namedCount = parseInt(document.getElementById('edit-raid-named-count').value);
  const required = parseInt(document.getElementById('edit-raid-required').value);
  
  if (!name) {
    showToast('ë ˆì´ë“œ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”ğŸŒ™');
    return;
  }
  
  // ì¤‘ë³µ ì´ë¦„ ì²´í¬ (ìê¸° ìì‹  ì œì™¸)
  const duplicate = raidSettings.find(r => r.ë ˆì´ë“œëª… === name && r.id !== selectedId);
  if (duplicate) {
    showToast(`"${name}" ì´ë¦„ì˜ ë ˆì´ë“œê°€ ì´ë¯¸ ì¡´ì¬í•´ìš”ğŸŒ™`);
    return;
  }
  
  // ê¸°ì¡´ ë ˆì´ë“œ ì •ë³´
  const oldRaid = raidSettings.find(r => r.id === selectedId);
  const oldName = oldRaid?.ë ˆì´ë“œëª…;
  
  try {
    const response = await fetch(WEBHOOK_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        action: 'updateRaidSetting',
        data: {
          id: selectedId,
          ë ˆì´ë“œëª…: name,
          oldName: oldName, // ì´ë¦„ ë³€ê²½ ì‹œ ì°¸ê°€ì ì—°ë™ìš©
          ë„¤ì„ë“œìˆ˜: namedCount,
          í•„ìš”ì¸ì›: required,
          í™œì„±í™”: true,
          ê¸°ê°„: null
        }
      })
    });
    
    if (response.ok) {
      showToast('ì„¤ì •ì´ ì €ì¥ë˜ì—ˆì–´ìš”ğŸŒ™', 'success');
      closeModal('raid-settings-modal');
      
      // ì´ë¦„ ë³€ê²½ ì‹œ localStorageë„ ì—…ë°ì´íŠ¸
      if (oldName !== name && currentRaidType === oldName) {
        currentRaidType = name;
        localStorage.setItem('dalnim_lastRaid', name);
      }
      
      await loadRaidSettings();
      renderRaidTabs();
      renderSchedule();
    } else {
      showToast('ì €ì¥ì— ì‹¤íŒ¨í–ˆì–´ìš”ğŸŒ™', 'error');
    }
  } catch (error) {
    showToast('ì €ì¥ì— ì‹¤íŒ¨í–ˆì–´ìš”ğŸŒ™', 'error');
  }
}

async function deleteRaid() {
  const selectedId = document.getElementById('settings-raid-select').value;
  const raid = raidSettings.find(r => r.id === selectedId);
  
  const confirmed = await showConfirm(`"${raid.ë ˆì´ë“œëª…}" ë ˆì´ë“œë¥¼ ì‚­ì œí• ê¹Œìš”?ğŸŒ™`);
  if (!confirmed) return;
  
  try {
    const response = await fetch(WEBHOOK_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        action: 'deleteRaidSetting',
        data: { id: selectedId }
      })
    });
    
    const result = await response.json();
    if (result.success) {
      showToast('ë ˆì´ë“œê°€ ì‚­ì œë˜ì—ˆì–´ìš”ğŸŒ™', 'success');
      closeModal('raid-settings-modal');
      await loadRaidSettings();
      renderRaidTabs();
    } else {
      showToast('ì‚­ì œì— ì‹¤íŒ¨í–ˆì–´ìš”ğŸŒ™', 'error');
    }
  } catch (error) {
    showToast('ì‚­ì œì— ì‹¤íŒ¨í–ˆì–´ìš”ğŸŒ™', 'error');
  }
}

// ëª¨ë°”ì¼ ê°ì§€ + viewport ë™ì  ë³€ê²½
function detectMobile() {
  const isMobileDevice = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
  const viewport = document.querySelector('meta[name="viewport"]');
  
  if (isMobileDevice) {
    document.body.classList.add('is-mobile');
    // ëª¨ë°”ì¼: 800px ê³ ì • + ì¶•ì†Œ
    viewport.setAttribute('content', 'width=800, initial-scale=0.5, user-scalable=yes');
  } else {
    document.body.classList.remove('is-mobile');
    // PC: ê¸°ë³¸
    viewport.setAttribute('content', 'width=device-width, initial-scale=1.0, user-scalable=yes');
  }
}
detectMobile();

// ì´ˆê¸° ë¡œë“œ
initViewPanel();
</script>

</body>
</html>
