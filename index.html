<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë‹¬ ê¸¸ë“œ ë ˆì´ë“œ ì¼ì •</title>
    <style>
        * {
            box-sizing: border-box;
            font-family: 'Malgun Gothic', sans-serif;
        }
        body {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            color: #fff;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 {
            text-align: center;
            color: #ffd700;
            margin-bottom: 30px;
            font-size: 28px;
        }
        
        /* ë©”ì¸ íƒ­ (ë“±ë¡/ì¼ì •ë³´ê¸°) */
        .main-tabs {
            display: flex;
            margin-bottom: 20px;
            border-radius: 10px;
            overflow: hidden;
            max-width: 400px;
        }
        .main-tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            background: #2a2a4a;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            transition: background 0.3s;
        }
        .main-tab:hover {
            background: #3a3a5a;
        }
        .main-tab.active {
            background: #4a4a7a;
            color: #ffd700;
        }
        .panel {
            display: none;
            background: #2a2a4a;
            padding: 25px;
            border-radius: 15px;
        }
        .panel.active {
            display: block;
        }
        
        /* ë“±ë¡ í¼ */
        .register-panel {
            max-width: 500px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-size: 16px;
            color: #ccc;
        }
        input[type="text"] {
            width: 100%;
            padding: 15px;
            font-size: 18px;
            border: none;
            border-radius: 8px;
            background: #1a1a2e;
            color: #fff;
        }
        select {
            width: 100%;
            padding: 15px;
            font-size: 18px;
            border: none;
            border-radius: 8px;
            background: #1a1a2e;
            color: #fff;
        }
        .day-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        .day-btn {
            padding: 12px 18px;
            font-size: 16px;
            border: 2px solid #4a4a7a;
            border-radius: 8px;
            background: transparent;
            color: #fff;
            cursor: pointer;
            transition: all 0.3s;
        }
        .day-btn:hover {
            border-color: #ffd700;
        }
        .day-btn.selected {
            background: #ff6b6b;
            border-color: #ff6b6b;
            color: #fff;
        }
        .submit-btn {
            width: 100%;
            padding: 18px;
            font-size: 20px;
            font-weight: bold;
            border: none;
            border-radius: 10px;
            background: linear-gradient(135deg, #ffd700 0%, #ffaa00 100%);
            color: #1a1a2e;
            cursor: pointer;
            margin-top: 20px;
            transition: transform 0.2s;
        }
        .submit-btn:hover {
            transform: scale(1.02);
        }
        .submit-btn:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
        }
        .search-box {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .search-box input {
            flex: 1;
        }
        .search-btn {
            padding: 15px 25px;
            font-size: 16px;
            border: none;
            border-radius: 8px;
            background: #4a4a7a;
            color: #fff;
            cursor: pointer;
        }
        .message {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
            font-size: 16px;
        }
        .message.success { background: #2ecc71; }
        .message.error { background: #e74c3c; }
        .message.info { background: #3498db; }

        /* ë ˆì´ë“œ íƒ€ì… íƒ­ */
        .raid-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .raid-tab {
            padding: 12px 24px;
            background: #1a1a2e;
            border: 2px solid #4a4a7a;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s;
        }
        .raid-tab:hover {
            border-color: #ffd700;
        }
        .raid-tab.active {
            background: #ffd700;
            color: #1a1a2e;
            border-color: #ffd700;
        }

        /* ìš”ì¼ íƒ­ */
        .day-tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .day-tab {
            padding: 10px 15px;
            background: #1a1a2e;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            min-width: 60px;
            transition: all 0.3s;
        }
        .day-tab:hover {
            background: #3a3a5a;
        }
        .day-tab.active {
            background: #ffd700;
            color: #1a1a2e;
        }
        .day-tab .day-name {
            font-size: 14px;
            font-weight: bold;
        }
        .day-tab .day-count {
            font-size: 20px;
            font-weight: bold;
        }

        /* ì‹œê°„ ë¸”ë¡ ë·° */
        .schedule-view {
            display: flex;
            gap: 20px;
        }
        .named-column {
            flex: 1;
            min-width: 0;
        }
        .named-header {
            padding: 15px;
            text-align: center;
            font-size: 18px;
            font-weight: bold;
            border-radius: 8px 8px 0 0;
            margin-bottom: 10px;
        }
        .named-header.named-1 {
            background: #3b82f6;
        }
        .named-header.named-2 {
            background: #8b5cf6;
        }
        .named-header.named-none {
            background: #6b7280;
        }

        /* ì‹œê°„ ê·¸ë¦¬ë“œ */
        .time-grid {
            position: relative;
            background: #1a1a2e;
            border-radius: 8px;
            min-height: 500px;
        }
        .time-row {
            display: flex;
            align-items: center;
            border-bottom: 1px solid #2a2a4a;
            min-height: 50px;
            position: relative;
        }
        .time-label {
            width: 70px;
            padding: 10px;
            font-size: 14px;
            color: #888;
            text-align: center;
            flex-shrink: 0;
        }
        .time-content {
            flex: 1;
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            padding: 5px;
            min-height: 40px;
        }

        /* í”Œë ˆì´ì–´ ë¸”ë¡ */
        .player-block {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: bold;
            white-space: nowrap;
        }
        .player-block .job-icon {
            font-size: 12px;
        }

        /* ì„¸ë¡œ ë¸”ë¡ (ì‹œê°„ ë²”ìœ„) */
        .player-bar {
            position: absolute;
            left: 75px;
            right: 5px;
            border-radius: 6px;
            padding: 8px;
            font-size: 13px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            z-index: 10;
            cursor: default;
        }
        .player-bar:hover {
            z-index: 20;
            box-shadow: 0 4px 8px rgba(0,0,0,0.5);
        }
        .player-bar .bar-content {
            writing-mode: horizontal-tb;
        }

        /* ì§ì—… ìƒ‰ìƒ */
        .job-ìˆ˜í˜¸ì„± { background: rgba(96, 165, 250, 0.9); color: #000; }
        .job-ê²€ì„± { background: rgba(248, 113, 113, 0.9); color: #000; }
        .job-ê¶ì„± { background: rgba(251, 146, 60, 0.9); color: #000; }
        .job-ë§ˆë„ì„± { background: rgba(192, 132, 252, 0.9); color: #000; }
        .job-ì¹˜ìœ ì„± { background: rgba(74, 222, 128, 0.9); color: #000; }
        .job-í˜¸ë²•ì„± { background: rgba(250, 204, 21, 0.9); color: #000; }
        .job-ì‚´ì„± { background: rgba(236, 72, 153, 0.9); color: #000; }
        .job-ì •ë ¹ì„± { background: rgba(20, 184, 166, 0.9); color: #000; }

        /* ì‹œê°„ ë¯¸ì •ì */
        .job-unknown { background: rgba(107, 114, 128, 0.7); color: #fff; }

        /* ë²”ë¡€ */
        .legend {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
            padding: 15px;
            background: #1a1a2e;
            border-radius: 8px;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 12px;
        }
        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 4px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #888;
        }

        /* í•©ê³„ í‘œì‹œ */
        .total-count {
            text-align: center;
            font-size: 16px;
            color: #ffd700;
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸŒ™ ë‹¬ ê¸¸ë“œ ë ˆì´ë“œ</h1>
        
        <div class="main-tabs">
            <div class="main-tab active" onclick="showMainTab('register')">ë“±ë¡/ìˆ˜ì •</div>
            <div class="main-tab" onclick="showMainTab('view')">ì¼ì • ë³´ê¸°</div>
        </div>

        <!-- ë“±ë¡/ìˆ˜ì • íŒ¨ë„ -->
        <div id="register-panel" class="panel register-panel active">
            <div id="register-message"></div>
            
            <div class="form-group">
                <label>ë‹‰ë„¤ì„ *</label>
                <div class="search-box">
                    <input type="text" id="nickname" placeholder="ìºë¦­í„° ì´ë¦„">
                    <button class="search-btn" onclick="loadMyInfo()">ë¶ˆëŸ¬ì˜¤ê¸°</button>
                </div>
            </div>

            <div class="form-group">
                <label>ì§ì—… *</label>
                <select id="job">
                    <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                    <option value="ìˆ˜í˜¸ì„±">ìˆ˜í˜¸ì„±</option>
                    <option value="ê²€ì„±">ê²€ì„±</option>
                    <option value="ê¶ì„±">ê¶ì„±</option>
                    <option value="ë§ˆë„ì„±">ë§ˆë„ì„±</option>
                    <option value="ì¹˜ìœ ì„±">ì¹˜ìœ ì„±</option>
                    <option value="í˜¸ë²•ì„±">í˜¸ë²•ì„±</option>
                    <option value="ì‚´ì„±">ì‚´ì„±</option>
                    <option value="ì •ë ¹ì„±">ì •ë ¹ì„±</option>
                </select>
            </div>

            <div class="form-group">
                <label>ë„¤ì„ë“œ</label>
                <select id="named">
                    <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                    <option value="1ë„´">1ë„´</option>
                    <option value="2ë„´">2ë„´</option>
                </select>
            </div>

            <div class="form-group">
                <label>ì‹œì‘ ê°€ëŠ¥ ì‹œê°„</label>
                <select id="startTime">
                    <option value="ìƒê´€ì—†ìŒ">ìƒê´€ì—†ìŒ</option>
                    <option value="PM 6">PM 6 (18ì‹œ)</option>
                    <option value="PM 7">PM 7 (19ì‹œ)</option>
                    <option value="PM 8">PM 8 (20ì‹œ)</option>
                    <option value="PM 9">PM 9 (21ì‹œ)</option>
                    <option value="PM 10">PM 10 (22ì‹œ)</option>
                    <option value="PM 11">PM 11 (23ì‹œ)</option>
                    <option value="AM 12">AM 12 (24ì‹œ)</option>
                    <option value="AM 1">AM 1 (01ì‹œ)</option>
                    <option value="AM 2">AM 2 (02ì‹œ)</option>
                </select>
            </div>

            <div class="form-group">
                <label>ì¢…ë£Œ ê°€ëŠ¥ ì‹œê°„</label>
                <select id="endTime">
                    <option value="ìƒê´€ì—†ìŒ">ìƒê´€ì—†ìŒ</option>
                    <option value="PM 6">PM 6 (18ì‹œ)</option>
                    <option value="PM 7">PM 7 (19ì‹œ)</option>
                    <option value="PM 8">PM 8 (20ì‹œ)</option>
                    <option value="PM 9">PM 9 (21ì‹œ)</option>
                    <option value="PM 10">PM 10 (22ì‹œ)</option>
                    <option value="PM 11">PM 11 (23ì‹œ)</option>
                    <option value="AM 12">AM 12 (24ì‹œ)</option>
                    <option value="AM 1">AM 1 (01ì‹œ)</option>
                    <option value="AM 2">AM 2 (02ì‹œ)</option>
                </select>
            </div>

            <div class="form-group">
                <label>ë ˆì´ë“œ ì¢…ë¥˜</label>
                <select id="raidType">
                    <option value="íŠ¸ë¼ì´íŒŸ">íŠ¸ë¼ì´íŒŸ</option>
                    <option value="í´ë¦¬ì–´íŒŸ">í´ë¦¬ì–´íŒŸ</option>
                </select>
            </div>

            <div class="form-group">
                <label>ëª»í•˜ëŠ” ìš”ì¼ (í´ë¦­í•´ì„œ ì„ íƒ)</label>
                <div class="day-buttons">
                    <button type="button" class="day-btn" data-day="ì›”">ì›”</button>
                    <button type="button" class="day-btn" data-day="í™”">í™”</button>
                    <button type="button" class="day-btn" data-day="ìˆ˜">ìˆ˜</button>
                    <button type="button" class="day-btn" data-day="ëª©">ëª©</button>
                    <button type="button" class="day-btn" data-day="ê¸ˆ">ê¸ˆ</button>
                    <button type="button" class="day-btn" data-day="í† ">í† </button>
                    <button type="button" class="day-btn" data-day="ì¼">ì¼</button>
                </div>
            </div>

            <div class="form-group">
                <label>ì°¸ê³ ì‚¬í•­</label>
                <input type="text" id="note" placeholder="ì˜ˆ: ê¸ˆí† ë§Œ ê°€ëŠ¥, 24ì‹œ ì´ì „ ì„ í˜¸">
            </div>

            <button class="submit-btn" onclick="submitForm()">ì €ì¥í•˜ê¸°</button>
        </div>

        <!-- ì¼ì • ë³´ê¸° íŒ¨ë„ -->
        <div id="view-panel" class="panel">
            <div id="view-message"></div>
            
            <!-- ë ˆì´ë“œ íƒ€ì… íƒ­ -->
            <div class="raid-tabs" id="raid-tabs">
                <div class="raid-tab active" data-raid="íŠ¸ë¼ì´íŒŸ">íŠ¸ë¼ì´íŒŸ</div>
                <div class="raid-tab" data-raid="í´ë¦¬ì–´íŒŸ">í´ë¦¬ì–´íŒŸ</div>
            </div>

            <!-- ìš”ì¼ íƒ­ -->
            <div class="day-tabs" id="day-tabs"></div>

            <!-- í•©ê³„ -->
            <div class="total-count" id="total-count"></div>

            <!-- ì¼ì • ë·° -->
            <div class="schedule-view" id="schedule-view">
                <div class="loading">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
            </div>

            <!-- ë²”ë¡€ -->
            <div class="legend">
                <div class="legend-item"><div class="legend-color" style="background:#60a5fa"></div>ìˆ˜í˜¸ì„±</div>
                <div class="legend-item"><div class="legend-color" style="background:#f87171"></div>ê²€ì„±</div>
                <div class="legend-item"><div class="legend-color" style="background:#fb923c"></div>ê¶ì„±</div>
                <div class="legend-item"><div class="legend-color" style="background:#c084fc"></div>ë§ˆë„ì„±</div>
                <div class="legend-item"><div class="legend-color" style="background:#4ade80"></div>ì¹˜ìœ ì„±</div>
                <div class="legend-item"><div class="legend-color" style="background:#facc15"></div>í˜¸ë²•ì„±</div>
                <div class="legend-item"><div class="legend-color" style="background:#ec4899"></div>ì‚´ì„±</div>
                <div class="legend-item"><div class="legend-color" style="background:#14b8a6"></div>ì •ë ¹ì„±</div>
            </div>
        </div>
    </div>

    <script>
        const WEBHOOK_URL = 'https://n8n-production-f0a7.up.railway.app/webhook/raid';
        
        // ì‹œê°„ ìˆœì„œ (ì¸ë±ìŠ¤ë¡œ ìœ„ì¹˜ ê³„ì‚°ìš©)
        const TIME_ORDER = ['PM 6', 'PM 7', 'PM 8', 'PM 9', 'PM 10', 'PM 11', 'AM 12', 'AM 1', 'AM 2'];
        const TIME_LABELS = ['18ì‹œ', '19ì‹œ', '20ì‹œ', '21ì‹œ', '22ì‹œ', '23ì‹œ', 'ìµì¼ 00ì‹œ', 'ìµì¼ 01ì‹œ', 'ìµì¼ 02ì‹œ'];
        const DAYS = ['ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† ', 'ì¼'];
        
        let allPlayers = [];
        let currentRaidType = 'íŠ¸ë¼ì´íŒŸ';
        let currentDay = 'ê¸ˆ'; // ê¸°ë³¸ê°’

        // ë©”ì¸ íƒ­ ì „í™˜
        function showMainTab(tabName) {
            document.querySelectorAll('.main-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
            
            document.querySelector(`.main-tab:nth-child(${tabName === 'register' ? 1 : 2})`).classList.add('active');
            document.getElementById(`${tabName}-panel`).classList.add('active');
            
            if (tabName === 'view') {
                loadPlayerList();
            }
        }

        // ìš”ì¼ ë²„íŠ¼ í† ê¸€ (ë“±ë¡í¼)
        document.querySelectorAll('.day-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                btn.classList.toggle('selected');
            });
        });

        // ì„ íƒëœ ëª»í•˜ëŠ” ìš”ì¼ ê°€ì ¸ì˜¤ê¸°
        function getSelectedDays() {
            const days = [];
            document.querySelectorAll('.day-btn.selected').forEach(btn => {
                days.push(btn.dataset.day);
            });
            return days;
        }

        // ë©”ì‹œì§€ í‘œì‹œ
        function showMessage(elementId, type, text) {
            const el = document.getElementById(elementId);
            el.innerHTML = `<div class="message ${type}">${text}</div>`;
            setTimeout(() => { el.innerHTML = ''; }, 5000);
        }

        // ë‚´ ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸°
        async function loadMyInfo() {
            const nickname = document.getElementById('nickname').value.trim();
            if (!nickname) {
                showMessage('register-message', 'error', 'ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”');
                return;
            }

            try {
                const response = await fetch(WEBHOOK_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'get', data: { ë‹‰ë„¤ì„: nickname } })
                });
                const result = await response.json();
                
                if (result.success && result.data) {
                    const d = result.data;
                    document.getElementById('job').value = d.ì§ì—… || '';
                    document.getElementById('named').value = d.ë„¤ì„ë“œ || '';
                    document.getElementById('startTime').value = d.ì‹œì‘ì‹œê°„ || 'ìƒê´€ì—†ìŒ';
                    document.getElementById('endTime').value = d.ì¢…ë£Œì‹œê°„ || 'ìƒê´€ì—†ìŒ';
                    document.getElementById('raidType').value = d.ë ˆì´ë“œì¢…ë¥˜ || 'íŠ¸ë¼ì´íŒŸ';
                    document.getElementById('note').value = d.ì°¸ê³ ì‚¬í•­ || '';
                    
                    document.querySelectorAll('.day-btn').forEach(btn => {
                        btn.classList.remove('selected');
                        if (d.ëª»í•˜ëŠ”ìš”ì¼ && d.ëª»í•˜ëŠ”ìš”ì¼.includes(btn.dataset.day)) {
                            btn.classList.add('selected');
                        }
                    });
                    
                    showMessage('register-message', 'success', 'ì •ë³´ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤');
                } else {
                    showMessage('register-message', 'info', 'ë“±ë¡ëœ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤. ìƒˆë¡œ ë“±ë¡í•´ì£¼ì„¸ìš”.');
                }
            } catch (error) {
                showMessage('register-message', 'error', 'ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ' + error.message);
            }
        }

        // í¼ ì œì¶œ
        async function submitForm() {
            const nickname = document.getElementById('nickname').value.trim();
            const job = document.getElementById('job').value;
            
            if (!nickname) {
                showMessage('register-message', 'error', 'ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”');
                return;
            }
            if (!job) {
                showMessage('register-message', 'error', 'ì§ì—…ì„ ì„ íƒí•˜ì„¸ìš”');
                return;
            }

            const data = {
                ë‹‰ë„¤ì„: nickname,
                ì§ì—…: job,
                ë„¤ì„ë“œ: document.getElementById('named').value || '',
                ì‹œì‘ì‹œê°„: document.getElementById('startTime').value,
                ì¢…ë£Œì‹œê°„: document.getElementById('endTime').value,
                ëª»í•˜ëŠ”ìš”ì¼: getSelectedDays(),
                ë ˆì´ë“œì¢…ë¥˜: document.getElementById('raidType').value,
                ì°¸ê³ ì‚¬í•­: document.getElementById('note').value || ''
            };

            const btn = document.querySelector('.submit-btn');
            btn.disabled = true;
            btn.textContent = 'ì €ì¥ ì¤‘...';

            try {
                const response = await fetch(WEBHOOK_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'register', data })
                });
                const result = await response.json();
                
                if (result.success) {
                    showMessage('register-message', 'success', 'ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
                } else {
                    showMessage('register-message', 'error', 'ì €ì¥ ì‹¤íŒ¨: ' + (result.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
                }
            } catch (error) {
                showMessage('register-message', 'error', 'ì €ì¥ ì‹¤íŒ¨: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.textContent = 'ì €ì¥í•˜ê¸°';
            }
        }

        // ì°¸ê°€ì ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
        async function loadPlayerList() {
            const container = document.getElementById('schedule-view');
            container.innerHTML = '<div class="loading">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';

            try {
                const response = await fetch(WEBHOOK_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'list' })
                });
                const result = await response.json();
                
                if (result.success && result.data) {
                    // ë…¸ì…˜ API ì‘ë‹µ íŒŒì‹±
                    allPlayers = result.data.map(player => {
                        const props = player.properties || player;
                        return {
                            ë‹‰ë„¤ì„: props.ë‹‰ë„¤ì„?.title?.[0]?.text?.content || props.ë‹‰ë„¤ì„ || '???',
                            ì§ì—…: props.ì§ì—…?.select?.name || props.ì§ì—… || '',
                            ë„¤ì„ë“œ: props.ë„¤ì„ë“œ?.select?.name || props.ë„¤ì„ë“œ || '',
                            ì‹œì‘ì‹œê°„: props.ì‹œì‘ì‹œê°„?.select?.name || props.ì‹œì‘ì‹œê°„ || 'ìƒê´€ì—†ìŒ',
                            ì¢…ë£Œì‹œê°„: props.ì¢…ë£Œì‹œê°„?.select?.name || props.ì¢…ë£Œì‹œê°„ || 'ìƒê´€ì—†ìŒ',
                            ëª»í•˜ëŠ”ìš”ì¼: props.ëª»í•˜ëŠ”ìš”ì¼?.multi_select?.map(m => m.name) || props.ëª»í•˜ëŠ”ìš”ì¼ || [],
                            ë ˆì´ë“œì¢…ë¥˜: props.ë ˆì´ë“œì¢…ë¥˜?.select?.name || props.ë ˆì´ë“œì¢…ë¥˜ || 'íŠ¸ë¼ì´íŒŸ',
                            ì°¸ê³ ì‚¬í•­: props.ì°¸ê³ ì‚¬í•­?.rich_text?.[0]?.text?.content || props.ì°¸ê³ ì‚¬í•­ || ''
                        };
                    });
                    
                    renderDayTabs();
                    renderSchedule();
                } else {
                    container.innerHTML = '<div class="loading">ë“±ë¡ëœ ì°¸ê°€ìê°€ ì—†ìŠµë‹ˆë‹¤</div>';
                }
            } catch (error) {
                container.innerHTML = `<div class="message error">ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ${error.message}</div>`;
            }
        }

        // ìš”ì¼ íƒ­ ë Œë”ë§
        function renderDayTabs() {
            const container = document.getElementById('day-tabs');
            
            // ê° ìš”ì¼ë³„ ì°¸ê°€ ê°€ëŠ¥ ì¸ì› ê³„ì‚°
            const counts = {};
            DAYS.forEach(day => {
                counts[day] = allPlayers.filter(p => 
                    p.ë ˆì´ë“œì¢…ë¥˜ === currentRaidType && 
                    !p.ëª»í•˜ëŠ”ìš”ì¼.includes(day)
                ).length;
            });
            
            container.innerHTML = DAYS.map(day => `
                <div class="day-tab ${day === currentDay ? 'active' : ''}" data-day="${day}">
                    <div class="day-name">${day}</div>
                    <div class="day-count">${counts[day]}</div>
                </div>
            `).join('');
            
            // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
            container.querySelectorAll('.day-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    currentDay = tab.dataset.day;
                    container.querySelectorAll('.day-tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    renderSchedule();
                });
            });
        }

        // ë ˆì´ë“œ íƒ€ì… íƒ­ ì´ë²¤íŠ¸
        document.querySelectorAll('.raid-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                currentRaidType = tab.dataset.raid;
                document.querySelectorAll('.raid-tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                renderDayTabs();
                renderSchedule();
            });
        });

        // ì¼ì • ë Œë”ë§
        function renderSchedule() {
            const container = document.getElementById('schedule-view');
            
            // í˜„ì¬ ë ˆì´ë“œ íƒ€ì… + ìš”ì¼ë¡œ í•„í„°ë§
            const filtered = allPlayers.filter(p => 
                p.ë ˆì´ë“œì¢…ë¥˜ === currentRaidType && 
                !p.ëª»í•˜ëŠ”ìš”ì¼.includes(currentDay)
            );
            
            // 1ë„´, 2ë„´, ë¯¸ì • ë¶„ë¥˜
            const named1 = filtered.filter(p => p.ë„¤ì„ë“œ === '1ë„´');
            const named2 = filtered.filter(p => p.ë„¤ì„ë“œ === '2ë„´');
            const namedNone = filtered.filter(p => !p.ë„¤ì„ë“œ || p.ë„¤ì„ë“œ === '');
            
            // í•©ê³„ í‘œì‹œ
            document.getElementById('total-count').textContent = 
                `${currentDay}ìš”ì¼ ì°¸ê°€ ê°€ëŠ¥: 1ë„´ ${named1.length}ëª… / 2ë„´ ${named2.length}ëª… / ë¯¸ì • ${namedNone.length}ëª… (ì´ ${filtered.length}ëª…)`;
            
            container.innerHTML = `
                <div class="named-column">
                    <div class="named-header named-1">1ë„´ (${named1.length}ëª…)</div>
                    ${renderTimeGrid(named1)}
                </div>
                <div class="named-column">
                    <div class="named-header named-2">2ë„´ (${named2.length}ëª…)</div>
                    ${renderTimeGrid(named2)}
                </div>
                ${namedNone.length > 0 ? `
                <div class="named-column">
                    <div class="named-header named-none">ë¯¸ì • (${namedNone.length}ëª…)</div>
                    ${renderTimeGrid(namedNone)}
                </div>
                ` : ''}
            `;
        }

        // ì‹œê°„ ê·¸ë¦¬ë“œ ë Œë”ë§ (ë¸”ë¡ í˜•íƒœ)
        function renderTimeGrid(players) {
            const ROW_HEIGHT = 50;
            
            // ê° í”Œë ˆì´ì–´ì˜ ì‹œê°„ ë²”ìœ„ ê³„ì‚°
            const playerBars = players.map(p => {
                let startIdx = TIME_ORDER.indexOf(p.ì‹œì‘ì‹œê°„);
                let endIdx = TIME_ORDER.indexOf(p.ì¢…ë£Œì‹œê°„);
                
                // ìƒê´€ì—†ìŒ ì²˜ë¦¬
                if (startIdx === -1) startIdx = 0;
                if (endIdx === -1) endIdx = TIME_ORDER.length - 1;
                
                // ì¢…ë£Œê°€ ì‹œì‘ë³´ë‹¤ ì‘ìœ¼ë©´ (ì˜ëª»ëœ ì…ë ¥) ìˆ˜ì •
                if (endIdx < startIdx) endIdx = startIdx;
                
                return {
                    ...p,
                    startIdx,
                    endIdx,
                    height: (endIdx - startIdx + 1) * ROW_HEIGHT
                };
            });
            
            // ê²¹ì¹˜ì§€ ì•Šê²Œ ë ˆì¸ ë°°ì •
            const lanes = assignLanes(playerBars);
            const maxLane = Math.max(...playerBars.map(p => p.lane || 0), 0);
            const laneWidth = maxLane > 0 ? Math.floor(100 / (maxLane + 1)) : 100;
            
            // ì‹œê°„ í–‰ ìƒì„±
            let rows = TIME_ORDER.map((time, idx) => `
                <div class="time-row" style="height: ${ROW_HEIGHT}px;">
                    <div class="time-label">${TIME_LABELS[idx]}</div>
                    <div class="time-content"></div>
                </div>
            `).join('');
            
            // í”Œë ˆì´ì–´ ë°” ìƒì„±
            let bars = playerBars.map(p => {
                const top = p.startIdx * ROW_HEIGHT;
                const left = 70 + (p.lane || 0) * (laneWidth);
                const width = laneWidth - 2;
                const jobClass = p.ì§ì—… ? `job-${p.ì§ì—…}` : 'job-unknown';
                const title = `${p.ë‹‰ë„¤ì„}\n${p.ì§ì—…}\n${TIME_LABELS[p.startIdx]} ~ ${TIME_LABELS[p.endIdx]}${p.ì°¸ê³ ì‚¬í•­ ? '\n' + p.ì°¸ê³ ì‚¬í•­ : ''}`;
                
                return `
                    <div class="player-bar ${jobClass}" 
                         style="top: ${top}px; left: ${left}px; width: calc(${width}% - 70px); height: ${p.height}px;"
                         title="${title}">
                        <div class="bar-content">${p.ë‹‰ë„¤ì„}</div>
                    </div>
                `;
            }).join('');
            
            return `<div class="time-grid" style="position: relative;">${rows}${bars}</div>`;
        }

        // ë ˆì¸ ë°°ì • (ê²¹ì¹˜ì§€ ì•Šê²Œ)
        function assignLanes(players) {
            // ì‹œì‘ ì‹œê°„ ìˆœìœ¼ë¡œ ì •ë ¬
            players.sort((a, b) => a.startIdx - b.startIdx);
            
            const laneEnds = []; // ê° ë ˆì¸ì˜ ë ì¸ë±ìŠ¤
            
            players.forEach(p => {
                // ì‚¬ìš© ê°€ëŠ¥í•œ ë ˆì¸ ì°¾ê¸°
                let assignedLane = -1;
                for (let i = 0; i < laneEnds.length; i++) {
                    if (laneEnds[i] < p.startIdx) {
                        assignedLane = i;
                        break;
                    }
                }
                
                if (assignedLane === -1) {
                    // ìƒˆ ë ˆì¸ ìƒì„±
                    assignedLane = laneEnds.length;
                    laneEnds.push(p.endIdx);
                } else {
                    laneEnds[assignedLane] = p.endIdx;
                }
                
                p.lane = assignedLane;
            });
            
            return players;
        }
    </script>
</body>
</html>
