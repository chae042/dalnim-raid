<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸŒ™ ë‹¬ë‹˜ë´‡ - íŒŒí‹° ì¼ì •</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700;900&display=swap');

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'Noto Sans KR', sans-serif;
    background: #1a1a2e;
    color: #e0e0e0;
    padding: 24px;
    min-height: 100vh;
  }

  .container {
    max-width: 1100px;
    margin: 0 auto;
  }

  .loading {
    text-align: center;
    padding: 60px;
    color: #888;
  }

  .loading .spinner {
    font-size: 40px;
    animation: spin 2s linear infinite;
    display: inline-block;
  }

  @keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
  }

  /* Header */
  .header {
    text-align: center;
    margin-bottom: 32px;
  }

  .header h1 {
    font-size: 14px;
    font-weight: 400;
    color: #ffd700;
    letter-spacing: 4px;
    text-transform: uppercase;
    margin-bottom: 8px;
    opacity: 0.7;
  }

  .header h2 {
    font-size: 36px;
    font-weight: 700;
    color: #fff;
    margin-bottom: 4px;
  }

  .header .subtitle {
    font-size: 13px;
    color: #888;
  }

  /* Main Tabs */
  .main-tabs {
    display: flex;
    gap: 4px;
    margin-bottom: 24px;
    justify-content: center;
  }

  .main-tab {
    padding: 14px 32px;
    border-radius: 8px;
    background: #16213e;
    border: 1px solid #2a2a4a;
    color: #888;
    cursor: pointer;
    font-size: 16px;
    font-weight: 500;
    transition: all 0.2s;
  }

  .main-tab:hover {
    background: #1f2f5a;
    color: #ccc;
  }

  .main-tab.active {
    background: #ffd700;
    color: #1a1a2e;
    border-color: #ffd700;
    font-weight: 700;
  }

  .panel {
    display: none;
  }

  .panel.active {
    display: block;
  }

  /* ë“±ë¡ í¼ */
  .register-panel {
    max-width: 500px;
    margin: 0 auto;
    background: #16213e;
    padding: 24px;
    border-radius: 12px;
  }

  .form-group {
    margin-bottom: 20px;
  }

  .form-group label {
    display: block;
    margin-bottom: 8px;
    font-size: 14px;
    color: #888;
    font-weight: 500;
  }

  .form-group input[type="text"],
  .form-group select {
    width: 100%;
    padding: 14px;
    font-size: 16px;
    border: 1px solid #2a2a4a;
    border-radius: 8px;
    background: #1a1a2e;
    color: #fff;
    font-family: inherit;
  }

  .form-group input:focus,
  .form-group select:focus {
    outline: none;
    border-color: #ffd700;
  }

  .search-box {
    display: flex;
    gap: 8px;
  }

  .search-box input {
    flex: 1;
  }

  .search-btn {
    padding: 14px 20px;
    background: #2a2a4a;
    border: 1px solid #3a3a5a;
    border-radius: 8px;
    color: #fff;
    cursor: pointer;
    font-size: 14px;
    white-space: nowrap;
  }

  .search-btn:hover {
    background: #3a3a5a;
  }

  .day-buttons {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
  }

  .day-btn {
    padding: 12px 16px;
    font-size: 14px;
    border: 2px solid #2a2a4a;
    border-radius: 8px;
    background: transparent;
    color: #888;
    cursor: pointer;
    transition: all 0.2s;
    font-weight: 500;
  }

  .day-btn:hover {
    border-color: #ffd700;
    color: #ffd700;
  }

  .day-btn.selected {
    background: #ff6b6b;
    border-color: #ff6b6b;
    color: #fff;
  }

  .submit-btn {
    width: 100%;
    padding: 16px;
    font-size: 18px;
    font-weight: 700;
    border: none;
    border-radius: 8px;
    background: #ffd700;
    color: #1a1a2e;
    cursor: pointer;
    margin-top: 12px;
    transition: all 0.2s;
  }

  .submit-btn:hover {
    background: #ffed4a;
    transform: translateY(-1px);
  }

  .submit-btn:disabled {
    background: #444;
    cursor: not-allowed;
    transform: none;
  }

  .message {
    padding: 12px 16px;
    border-radius: 8px;
    margin-bottom: 16px;
    text-align: center;
    font-size: 14px;
  }

  .message.success { background: rgba(46, 204, 113, 0.2); color: #2ecc71; border: 1px solid #2ecc71; }
  .message.error { background: rgba(231, 76, 60, 0.2); color: #e74c3c; border: 1px solid #e74c3c; }
  .message.info { background: rgba(52, 152, 219, 0.2); color: #3498db; border: 1px solid #3498db; }

  /* Raid Type Tabs */
  .raid-tabs {
    display: flex;
    gap: 8px;
    margin-bottom: 20px;
    justify-content: center;
  }

  .raid-tab {
    padding: 10px 24px;
    border-radius: 20px;
    background: #16213e;
    border: 1px solid #2a2a4a;
    color: #888;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    transition: all 0.2s;
  }

  .raid-tab:hover {
    border-color: #ffd700;
    color: #ffd700;
  }

  .raid-tab.active {
    background: #ffd700;
    color: #1a1a2e;
    border-color: #ffd700;
    font-weight: 700;
  }

  /* Mode Toggle */
  .mode-toggle {
    display: flex;
    gap: 8px;
    margin-bottom: 20px;
    justify-content: center;
  }

  .mode-toggle-btn {
    padding: 10px 20px;
    border-radius: 6px;
    background: #16213e;
    border: 1px solid #2a2a4a;
    color: #888;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    transition: all 0.2s;
  }

  .mode-toggle-btn:hover {
    border-color: #60a5fa;
    color: #60a5fa;
  }

  .mode-toggle-btn.active {
    background: #60a5fa;
    color: #fff;
    border-color: #60a5fa;
  }

  /* í¸ì§‘ ëª¨ë“œ ë²„íŠ¼ */
  .edit-mode-bar {
    display: flex;
    justify-content: flex-end;
    margin-bottom: 16px;
  }

  .edit-mode-btn {
    padding: 8px 16px;
    background: #2a2a4a;
    border: 1px solid #3a3a5a;
    color: #aaa;
    border-radius: 8px;
    cursor: pointer;
    font-size: 14px;
    transition: all 0.2s;
  }

  .edit-mode-btn:hover {
    background: #3a3a5a;
    color: #fff;
  }

  .edit-mode-btn.active {
    background: #ffd700;
    color: #1a1a2e;
    border-color: #ffd700;
  }

  /* Day Tabs */
  .day-tabs {
    display: flex;
    gap: 4px;
    margin-bottom: 24px;
    overflow-x: auto;
    padding-bottom: 4px;
    justify-content: center;
  }

  .day-tab {
    padding: 14px 24px;
    border-radius: 8px;
    background: #16213e;
    border: 1px solid #2a2a4a;
    color: #888;
    cursor: pointer;
    font-size: 16px;
    font-weight: 500;
    transition: all 0.2s;
    white-space: nowrap;
    text-align: center;
    min-width: 85px;
  }

  .day-tab:hover {
    background: #1f2f5a;
    color: #ccc;
  }

  .day-tab.active {
    background: #ffd700;
    color: #1a1a2e;
    border-color: #ffd700;
    font-weight: 700;
  }

  .day-tab .count {
    display: block;
    font-size: 24px;
    font-weight: 900;
    margin-top: 2px;
  }

  .day-tab.active .count {
    color: #1a1a2e;
  }

  /* Schedule Table */
  .schedule-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
  }

  .schedule-table th {
    background: #16213e;
    padding: 16px 12px;
    font-size: 18px;
    font-weight: 700;
    border-bottom: 2px solid #2a2a4a;
  }

  .schedule-table th.nem1 { color: #74b9ff; }
  .schedule-table th.nem2 { color: #ff7675; }
  .schedule-table th.total { color: #ffd700; }

  .schedule-table td {
    padding: 10px 8px;
    border-bottom: 1px solid #2a2a4a;
    vertical-align: top;
  }

  .time-cell {
    font-size: 16px;
    font-weight: 700;
    color: #666;
    text-align: center;
    width: 80px;
  }

  .players-cell {
    min-width: 180px;
  }

  .players-wrap {
    display: flex;
    flex-wrap: wrap;
    gap: 4px;
  }

  .total-cell {
    text-align: center;
    font-weight: 700;
    font-size: 16px;
    color: #888;
    width: 60px;
  }

  .total-cell.highlight {
    color: #ffd700;
    background: rgba(255, 215, 0, 0.1);
  }

  /* íƒ€ì„ë¼ì¸ í…Œì´ë¸” (ë³´ê¸°ëª¨ë“œ) */
  .timeline-table {
    border-collapse: collapse;
  }

  .timeline-table .time-header {
    width: 70px;
  }

  .timeline-table .nem1-block-cell,
  .timeline-table .nem2-block-cell {
    padding: 0;
    vertical-align: top;
    position: relative;
  }

  .blocks-container {
    position: relative;
    width: 100%;
  }

  .timeline-block {
    position: absolute;
    border-radius: 6px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    font-size: 13px;
    font-weight: 600;
    gap: 2px;
    box-sizing: border-box;
    transition: filter 0.15s;
  }

  .timeline-block:hover {
    filter: brightness(1.2);
  }

  .timeline-block .job-icon {
    font-size: 10px;
    opacity: 0.8;
  }

  /* íƒ€ì„ë¼ì¸ ë¸”ë¡ ì§ì—… ìƒ‰ìƒ */
  .timeline-block.job-tank { background: rgba(59, 130, 246, 0.3); color: #60a5fa; }
  .timeline-block.job-melee { background: rgba(239, 68, 68, 0.3); color: #f87171; }
  .timeline-block.job-ranged { background: rgba(249, 115, 22, 0.3); color: #fb923c; }
  .timeline-block.job-magic { background: rgba(168, 85, 247, 0.3); color: #c084fc; }
  .timeline-block.job-assassin { background: rgba(236, 72, 153, 0.3); color: #ec4899; }
  .timeline-block.job-summoner { background: rgba(20, 184, 166, 0.3); color: #14b8a6; }
  .timeline-block.job-healer { background: rgba(34, 197, 94, 0.3); color: #4ade80; }
  .timeline-block.job-support { background: rgba(234, 179, 8, 0.3); color: #facc15; }

  /* í¸ì§‘ ëª¨ë“œ í…Œì´ë¸” */
  .schedule-table.edit-table {
    border-collapse: collapse;
  }

  .schedule-table.edit-table .time-header {
    width: 70px;
  }

  .schedule-table.edit-table .divider-header,
  .schedule-table.edit-table .divider-cell {
    width: 3px;
    background: #3a3a5a;
    padding: 0;
  }

  .schedule-table.edit-table .player-lane-cell {
    padding: 4px;
    text-align: center;
    vertical-align: middle;
  }

  .schedule-table.edit-table .player-lane-cell.empty {
    min-width: 70px;
  }

  /* ë°•ìŠ¤ ì„ íƒ */
  .selection-box {
    position: fixed;
    border: 2px dashed #ffd700;
    background: rgba(255, 215, 0, 0.1);
    pointer-events: none;
    z-index: 1000;
    display: none;
  }

  .player-chip.selected {
    outline: 3px solid #ffd700;
    outline-offset: 2px;
  }

  /* ì´ë™ ì»¨íŠ¸ë¡¤ */
  .move-controls {
    display: none;
    justify-content: center;
    align-items: center;
    gap: 12px;
    margin: 12px 0;
    padding: 12px;
    background: rgba(255, 215, 0, 0.1);
    border-radius: 8px;
    border: 1px solid rgba(255, 215, 0, 0.3);
  }

  .move-controls.active {
    display: flex;
  }

  .move-controls span {
    color: #ffd700;
    font-weight: 600;
  }

  .move-controls .hint-text {
    color: #888;
    font-weight: 400;
    font-size: 12px;
  }

  .move-btn {
    padding: 8px 16px;
    border: none;
    border-radius: 6px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
  }

  .move-btn.cancel {
    background: #666;
    color: white;
  }

  .move-btn:hover {
    transform: scale(1.05);
  }

  .edit-hint {
    text-align: center;
    color: #888;
    font-size: 12px;
    margin-top: 8px;
  }

  /* ë¹„í™œì„±í™”ëœ ì¹© */
  .player-chip.disabled {
    opacity: 0.3;
    filter: grayscale(100%);
  }

  /* ë“œë˜ê·¸ ê³ ìŠ¤íŠ¸ */
  .drag-ghost {
    position: fixed;
    padding: 8px 12px;
    background: rgba(255, 215, 0, 0.9);
    color: #1a1a2e;
    border-radius: 8px;
    font-weight: 600;
    pointer-events: none;
    z-index: 1001;
    display: none;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
  }

  /* ë“œë¡­ ì˜ì—­ í•˜ì´ë¼ì´íŠ¸ */
  .schedule-table.edit-table th.nem1.drop-hover,
  .schedule-table.edit-table th.nem2.drop-hover {
    background: rgba(255, 215, 0, 0.3);
    box-shadow: inset 0 0 10px rgba(255, 215, 0, 0.5);
  }

  .schedule-table.edit-table .player-lane-cell.drop-zone {
    position: relative;
  }

  .schedule-table.edit-table tr.drop-target-nem1 td:not(.time-cell):not(.divider-cell):not(.total-cell) {
    background: rgba(59, 130, 246, 0.2);
  }

  .schedule-table.edit-table tr.drop-target-nem2 td:not(.time-cell):not(.divider-cell):not(.total-cell) {
    background: rgba(139, 92, 246, 0.2);
  }

  /* Player Chip */
  .player-chip {
    display: inline-flex;
    align-items: center;
    gap: 3px;
    padding: 5px 10px;
    border-radius: 5px;
    font-size: 13px;
    font-weight: 500;
    white-space: nowrap;
    transition: all 0.15s;
    border: 1px solid transparent;
    cursor: default;
  }

  .player-chip:hover {
    transform: translateY(-1px);
    filter: brightness(1.2);
  }

  .player-chip .job-icon {
    font-size: 10px;
    opacity: 0.8;
  }

  /* Player Block (ë³´ê¸°ëª¨ë“œ) */
  .player-block {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 8px 12px;
    border-radius: 6px;
    font-size: 13px;
    font-weight: 600;
    white-space: nowrap;
    margin: 2px;
    border: 1px solid transparent;
  }

  .player-block .time-range {
    font-size: 11px;
    opacity: 0.7;
    margin-left: 4px;
  }

  /* Job Colors */
  .job-tank {
    background: rgba(59, 130, 246, 0.2);
    border-color: rgba(59, 130, 246, 0.4);
    color: #60a5fa;
  }

  .job-melee {
    background: rgba(239, 68, 68, 0.2);
    border-color: rgba(239, 68, 68, 0.4);
    color: #f87171;
  }

  .job-ranged {
    background: rgba(249, 115, 22, 0.2);
    border-color: rgba(249, 115, 22, 0.4);
    color: #fb923c;
  }

  .job-magic {
    background: rgba(168, 85, 247, 0.2);
    border-color: rgba(168, 85, 247, 0.4);
    color: #c084fc;
  }

  .job-assassin {
    background: rgba(236, 72, 153, 0.2);
    border-color: rgba(236, 72, 153, 0.4);
    color: #ec4899;
  }

  .job-summoner {
    background: rgba(20, 184, 166, 0.2);
    border-color: rgba(20, 184, 166, 0.4);
    color: #14b8a6;
  }

  .job-healer {
    background: rgba(34, 197, 94, 0.2);
    border-color: rgba(34, 197, 94, 0.4);
    color: #4ade80;
  }

  .job-support {
    background: rgba(234, 179, 8, 0.2);
    border-color: rgba(234, 179, 8, 0.4);
    color: #facc15;
  }

  .empty-cell {
    color: #444;
    font-size: 12px;
  }

  /* Legend */
  .legend {
    display: flex;
    gap: 16px;
    margin-top: 24px;
    padding: 16px;
    background: #16213e;
    border-radius: 8px;
    flex-wrap: wrap;
    justify-content: center;
  }

  .legend-item {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 12px;
    color: #888;
  }

  .legend-chip {
    width: 14px;
    height: 14px;
    border-radius: 4px;
  }

  /* Notes */
  .notes {
    margin-top: 16px;
    padding: 16px;
    background: #16213e;
    border-radius: 8px;
    border-left: 3px solid #ffd700;
  }

  .notes h3 {
    font-size: 13px;
    color: #ffd700;
    margin-bottom: 8px;
    font-weight: 700;
  }

  .note-item {
    font-size: 13px;
    color: #888;
    line-height: 1.8;
  }

  .note-item .name {
    color: #ccc;
    font-weight: 500;
  }

  /* Footer */
  .footer {
    text-align: center;
    margin-top: 32px;
    font-size: 12px;
    color: #444;
  }
</style>
</head>
<body>

<div class="container">
  <div class="header">
    <h1>ğŸŒ™ ë‹¬ ë ˆê¸°ì˜¨</h1>
    <h2>íŒŒí‹° ì¼ì •</h2>
    <div class="subtitle">ë“±ë¡ ë° ì‹œê°„ëŒ€ë³„ ì°¸ì—¬ ê°€ëŠ¥ ì¸ì›</div>
  </div>

  <!-- ë©”ì¸ íƒ­ -->
  <div class="main-tabs">
    <div class="main-tab active" onclick="showMainTab('view')">ğŸ“‹ ì¼ì • ë³´ê¸°</div>
    <div class="main-tab" onclick="showMainTab('register')">âœï¸ ë“±ë¡/ìˆ˜ì •</div>
  </div>

  <!-- ì¼ì • ë³´ê¸° íŒ¨ë„ -->
  <div id="view-panel" class="panel active">
    <!-- ë ˆì´ë“œ íƒ€ì… íƒ­ (ë™ì  ìƒì„±) -->
    <div class="raid-tabs" id="raid-tabs"></div>

    <!-- í¸ì§‘ ëª¨ë“œ ë²„íŠ¼ -->
    <div class="edit-mode-bar">
      <button class="edit-mode-btn" id="edit-mode-btn" onclick="toggleEditMode()">âœï¸ í¸ì§‘ ëª¨ë“œ</button>
    </div>

    <!-- ìš”ì¼ íƒ­ -->
    <div class="day-tabs" id="day-tabs"></div>

    <!-- ì¼ì • ë·° -->
    <div id="schedule-view">
      <div class="loading">
        <div class="spinner">ğŸŒ™</div>
        <p style="margin-top: 16px;">ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
      </div>
    </div>

    <!-- ì´ë™ ì»¨íŠ¸ë¡¤ (í¸ì§‘ëª¨ë“œ) -->
    <div class="move-controls" id="move-controls">
      <span id="selected-count">0ê°œ ì„ íƒë¨</span>
      <span class="hint-text">ë“œë˜ê·¸í•˜ì—¬ 1ë„´/2ë„´ìœ¼ë¡œ ì´ë™ | Delete: ë¹„í™œì„±í™” | Ctrl+Del: ì„ íƒ ì™¸ ë¹„í™œì„±í™” | Ctrl+Z: ë˜ëŒë¦¬ê¸°</span>
      <button class="move-btn cancel" onclick="clearSelection()">ì„ íƒ ì·¨ì†Œ</button>
    </div>
    <div class="edit-hint" id="edit-hint" style="display:none;">ğŸ’¡ Ctrl + ë“œë˜ê·¸ë¡œ ì—¬ëŸ¬ ì¹© ì„ íƒ</div>

    <!-- ì„ íƒ ë°•ìŠ¤ ì˜¤ë²„ë ˆì´ -->
    <div class="selection-box" id="selection-box"></div>
    
    <!-- ë“œë˜ê·¸ ì¤‘ ê³ ìŠ¤íŠ¸ -->
    <div class="drag-ghost" id="drag-ghost"></div>

    <!-- ë²”ë¡€ -->
    <div class="legend">
      <div class="legend-item"><div class="legend-chip" style="background: rgba(59, 130, 246, 0.4);"></div> ìˆ˜í˜¸ì„±</div>
      <div class="legend-item"><div class="legend-chip" style="background: rgba(239, 68, 68, 0.4);"></div> ê²€ì„±</div>
      <div class="legend-item"><div class="legend-chip" style="background: rgba(249, 115, 22, 0.4);"></div> ê¶ì„±</div>
      <div class="legend-item"><div class="legend-chip" style="background: rgba(168, 85, 247, 0.4);"></div> ë§ˆë„ì„±</div>
      <div class="legend-item"><div class="legend-chip" style="background: rgba(34, 197, 94, 0.4);"></div> ì¹˜ìœ ì„±</div>
      <div class="legend-item"><div class="legend-chip" style="background: rgba(234, 179, 8, 0.4);"></div> í˜¸ë²•ì„±</div>
      <div class="legend-item"><div class="legend-chip" style="background: rgba(236, 72, 153, 0.4);"></div> ì‚´ì„±</div>
      <div class="legend-item"><div class="legend-chip" style="background: rgba(20, 184, 166, 0.4);"></div> ì •ë ¹ì„±</div>
    </div>

    <!-- ì°¸ê³ ì‚¬í•­ -->
    <div id="notes-section"></div>

    <div class="footer">
      ğŸŒ™ ë‹¬ë‹˜ë´‡ Â· <span id="update-time"></span>
    </div>
  </div>

  <!-- ë“±ë¡/ìˆ˜ì • íŒ¨ë„ -->
  <div id="register-panel" class="panel">
    <div class="register-panel">
      <div id="register-message"></div>
      
      <div class="form-group">
        <label>ë‹‰ë„¤ì„ *</label>
        <div class="search-box">
          <input type="text" id="nickname" placeholder="ìºë¦­í„° ì´ë¦„">
          <button class="search-btn" onclick="loadMyInfo()">ë¶ˆëŸ¬ì˜¤ê¸°</button>
        </div>
      </div>

      <div class="form-group">
        <label>ì§ì—… *</label>
        <select id="job">
          <option value="">ì„ íƒí•˜ì„¸ìš”</option>
          <option value="ìˆ˜í˜¸ì„±">ìˆ˜í˜¸ì„±</option>
          <option value="ê²€ì„±">ê²€ì„±</option>
          <option value="ê¶ì„±">ê¶ì„±</option>
          <option value="ë§ˆë„ì„±">ë§ˆë„ì„±</option>
          <option value="ì¹˜ìœ ì„±">ì¹˜ìœ ì„±</option>
          <option value="í˜¸ë²•ì„±">í˜¸ë²•ì„±</option>
          <option value="ì‚´ì„±">ì‚´ì„±</option>
          <option value="ì •ë ¹ì„±">ì •ë ¹ì„±</option>
        </select>
      </div>

      <div class="form-group">
        <label>ë„¤ì„ë“œ</label>
        <select id="named">
          <option value="">ì„ íƒí•˜ì„¸ìš”</option>
          <option value="1ë„´">1ë„´</option>
          <option value="2ë„´">2ë„´</option>
        </select>
      </div>

      <div class="form-group">
        <label>ì‹œì‘ ê°€ëŠ¥ ì‹œê°„</label>
        <select id="startTime">
          <option value="ìƒê´€ì—†ìŒ">ìƒê´€ì—†ìŒ</option>
          <option value="PM 6">PM 6 (18ì‹œ)</option>
          <option value="PM 7">PM 7 (19ì‹œ)</option>
          <option value="PM 8">PM 8 (20ì‹œ)</option>
          <option value="PM 9">PM 9 (21ì‹œ)</option>
          <option value="PM 10">PM 10 (22ì‹œ)</option>
          <option value="PM 11">PM 11 (23ì‹œ)</option>
          <option value="AM 12">AM 12 (24ì‹œ)</option>
          <option value="AM 1">AM 1 (01ì‹œ)</option>
          <option value="AM 2">AM 2 (02ì‹œ)</option>
        </select>
      </div>

      <div class="form-group">
        <label>ì¢…ë£Œ ê°€ëŠ¥ ì‹œê°„</label>
        <select id="endTime">
          <option value="ìƒê´€ì—†ìŒ">ìƒê´€ì—†ìŒ</option>
          <option value="PM 6">PM 6 (18ì‹œ)</option>
          <option value="PM 7">PM 7 (19ì‹œ)</option>
          <option value="PM 8">PM 8 (20ì‹œ)</option>
          <option value="PM 9">PM 9 (21ì‹œ)</option>
          <option value="PM 10">PM 10 (22ì‹œ)</option>
          <option value="PM 11">PM 11 (23ì‹œ)</option>
          <option value="AM 12">AM 12 (24ì‹œ)</option>
          <option value="AM 1">AM 1 (01ì‹œ)</option>
          <option value="AM 2">AM 2 (02ì‹œ)</option>
        </select>
      </div>

      <div class="form-group">
        <label>ë ˆì´ë“œ ì¢…ë¥˜</label>
        <select id="raidType">
          <option value="íŠ¸ë¼ì´íŒŸ">íŠ¸ë¼ì´íŒŸ</option>
          <option value="í´ë¦¬ì–´íŒŸ">í´ë¦¬ì–´íŒŸ</option>
        </select>
      </div>

      <div class="form-group">
        <label>ëª»í•˜ëŠ” ìš”ì¼ (í´ë¦­í•´ì„œ ì„ íƒ)</label>
        <div class="day-buttons">
          <button type="button" class="day-btn" data-day="ì›”">ì›”</button>
          <button type="button" class="day-btn" data-day="í™”">í™”</button>
          <button type="button" class="day-btn" data-day="ìˆ˜">ìˆ˜</button>
          <button type="button" class="day-btn" data-day="ëª©">ëª©</button>
          <button type="button" class="day-btn" data-day="ê¸ˆ">ê¸ˆ</button>
          <button type="button" class="day-btn" data-day="í† ">í† </button>
          <button type="button" class="day-btn" data-day="ì¼">ì¼</button>
        </div>
      </div>

      <div class="form-group">
        <label>ì°¸ê³ ì‚¬í•­</label>
        <input type="text" id="note" placeholder="ì˜ˆ: ê¸ˆí† ë§Œ ê°€ëŠ¥, 24ì‹œ ì´ì „ ì„ í˜¸">
      </div>

      <button class="submit-btn" onclick="submitForm()">ì €ì¥í•˜ê¸°</button>
    </div>
  </div>
</div>

<script>
const WEBHOOK_URL = 'https://n8n-production-f0a7.up.railway.app/webhook/raid';
const DAYS = ['ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† ', 'ì¼'];
const TIME_ORDER = ['PM 6', 'PM 7', 'PM 8', 'PM 9', 'PM 10', 'PM 11', 'AM 12', 'AM 1', 'AM 2'];
const TIME_LABELS = ['18ì‹œ', '19ì‹œ', '20ì‹œ', '21ì‹œ', '22ì‹œ', '23ì‹œ', 'ìµì¼00ì‹œ', 'ìµì¼01ì‹œ', 'ìµì¼02ì‹œ'];

const JOB_MAP = {
  'ìˆ˜í˜¸ì„±': { class: 'job-tank', icon: 'ğŸ›¡' },
  'ê²€ì„±': { class: 'job-melee', icon: 'âš”ï¸' },
  'ê¶ì„±': { class: 'job-ranged', icon: 'ğŸ¹' },
  'ë§ˆë„ì„±': { class: 'job-magic', icon: 'â—†' },
  'ì¹˜ìœ ì„±': { class: 'job-healer', icon: 'âœš' },
  'í˜¸ë²•ì„±': { class: 'job-support', icon: 'â—ˆ' },
  'ì‚´ì„±': { class: 'job-assassin', icon: 'ğŸ—¡' },
  'ì •ë ¹ì„±': { class: 'job-summoner', icon: 'ğŸ”®' },
};

let allPlayers = [];
let raidSettings = [];
let raidIdToName = {};
let currentDay = 'ê¸ˆ';
let currentRaidType = '';
let currentMode = 'view';

// ë©”ì¸ íƒ­ ì „í™˜
function showMainTab(tabName) {
  document.querySelectorAll('.main-tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
  
  const tabIndex = tabName === 'view' ? 0 : 1;
  document.querySelectorAll('.main-tab')[tabIndex].classList.add('active');
  document.getElementById(`${tabName}-panel`).classList.add('active');
  
  if (tabName === 'view') {
    initViewPanel();
  }
}

// ë³´ê¸° íŒ¨ë„ ì´ˆê¸°í™” (ë ˆì´ë“œ ì„¤ì • ë¨¼ì € ë¡œë“œ)
async function initViewPanel() {
  if (raidSettings.length === 0) {
    await loadRaidSettings();
  }
  await loadPlayerList();
}

// ë ˆì´ë“œ íƒ€ì… ì„ íƒ
function selectRaidType(type) {
  currentRaidType = type;
  document.querySelectorAll('.raid-tab').forEach(t => {
    t.classList.toggle('active', t.dataset.raid === type);
  });
  renderDayTabs();
  renderSchedule();
  renderNotes();
}

// ìš”ì¼ ì„ íƒ
function selectDay(day) {
  currentDay = day;
  document.querySelectorAll('.day-tab').forEach(t => {
    t.classList.toggle('active', t.dataset.day === day);
  });
  renderSchedule();
}

// ì§ì—… ì •ë³´
function getJobInfo(job) {
  return JOB_MAP[job] || { class: 'job-support', icon: 'â—' };
}

// ì‹œê°„ ì¸ë±ìŠ¤
function getTimeIndex(timeStr) {
  if (!timeStr || timeStr === 'ìƒê´€ì—†ìŒ') return -1;
  return TIME_ORDER.indexOf(timeStr);
}

// ì‹œê°„ ë²”ìœ„
function getTimeRange(startTime, endTime) {
  let startIdx = getTimeIndex(startTime);
  let endIdx = getTimeIndex(endTime);
  
  if (startIdx === -1) startIdx = 0;
  if (endIdx === -1) endIdx = TIME_ORDER.length - 1;
  if (endIdx < startIdx) endIdx = startIdx;
  
  return { startIdx, endIdx };
}

// ë ˆì´ë“œ ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸°
async function loadRaidSettings() {
  try {
    const response = await fetch(WEBHOOK_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ action: 'getRaidSettings' })
    });
    const result = await response.json();
    
    if (result.raidSettings && result.raidSettings.length > 0) {
      raidSettings = result.raidSettings.map(item => {
        const props = item.properties || item;
        return {
          id: item.id,
          ë ˆì´ë“œëª…: props.ë ˆì´ë“œëª…?.title?.[0]?.text?.content || '',
          ë ˆì´ë“œì¢…ë¥˜: props.ë ˆì´ë“œì¢…ë¥˜?.select?.name || ''
        };
      });
      
      // ID â†’ ì´ë¦„ ë§¤í•‘
      raidIdToName = {};
      raidSettings.forEach(r => {
        raidIdToName[r.id] = r.ë ˆì´ë“œëª…;
      });
      
      // ì²« ë²ˆì§¸ë¥¼ ê¸°ë³¸ê°’ìœ¼ë¡œ
      if (raidSettings.length > 0 && !currentRaidType) {
        currentRaidType = raidSettings[0].ë ˆì´ë“œëª…;
      }
      
      renderRaidTabs();
    }
  } catch (error) {
    console.error('ë ˆì´ë“œ ì„¤ì • ë¡œë“œ ì‹¤íŒ¨:', error);
  }
}

// ë ˆì´ë“œ íƒ­ ë Œë”ë§
function renderRaidTabs() {
  const container = document.getElementById('raid-tabs');
  container.innerHTML = raidSettings.map((r, idx) => `
    <div class="raid-tab ${r.ë ˆì´ë“œëª… === currentRaidType ? 'active' : ''}" 
         data-raid="${r.ë ˆì´ë“œëª…}" 
         onclick="selectRaidType('${r.ë ˆì´ë“œëª…}')">${r.ë ˆì´ë“œëª…}</div>
  `).join('');
}

// í”Œë ˆì´ì–´ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
async function loadPlayerList() {
  const container = document.getElementById('schedule-view');
  container.innerHTML = `
    <div class="loading">
      <div class="spinner">ğŸŒ™</div>
      <p style="margin-top: 16px;">ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
    </div>
  `;

  try {
    const response = await fetch(WEBHOOK_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ action: 'list' })
    });
    const result = await response.json();
    
    if (result.success && result.data) {
      allPlayers = result.data.map(player => {
        const props = player.properties || player;
        // ë ˆì´ë“œì¢…ë¥˜ê°€ relationì´ë©´ IDë¡œ ì´ë¦„ ì°¾ê¸°
        let raidType = '';
        if (props.ë ˆì´ë“œì¢…ë¥˜?.relation?.[0]?.id) {
          raidType = raidIdToName[props.ë ˆì´ë“œì¢…ë¥˜.relation[0].id] || '';
        } else {
          raidType = props.ë ˆì´ë“œì¢…ë¥˜?.select?.name || props.ë ˆì´ë“œì¢…ë¥˜ || '';
        }
        
        return {
          ë‹‰ë„¤ì„: props.ë‹‰ë„¤ì„?.title?.[0]?.text?.content || props.ë‹‰ë„¤ì„ || '???',
          ì§ì—…: props.ì§ì—…?.select?.name || props.ì§ì—… || '',
          ë„¤ì„ë“œ: props.ë„¤ì„ë“œ?.select?.name || props.ë„¤ì„ë“œ || '',
          ì‹œì‘ì‹œê°„: props.ì‹œì‘ì‹œê°„?.select?.name || props.ì‹œì‘ì‹œê°„ || 'ìƒê´€ì—†ìŒ',
          ì¢…ë£Œì‹œê°„: props.ì¢…ë£Œì‹œê°„?.select?.name || props.ì¢…ë£Œì‹œê°„ || 'ìƒê´€ì—†ìŒ',
          ëª»í•˜ëŠ”ìš”ì¼: props.ëª»í•˜ëŠ”ìš”ì¼?.multi_select?.map(m => m.name) || props.ëª»í•˜ëŠ”ìš”ì¼ || [],
          ë ˆì´ë“œì¢…ë¥˜: raidType,
          ì°¸ê³ ì‚¬í•­: props.ì°¸ê³ ì‚¬í•­?.rich_text?.[0]?.text?.content || props.ì°¸ê³ ì‚¬í•­ || ''
        };
      });
      
      document.getElementById('update-time').textContent = new Date().toLocaleString('ko-KR');
      renderDayTabs();
      renderSchedule();
      renderNotes();
    } else {
      container.innerHTML = '<div class="loading">ë“±ë¡ëœ ì°¸ê°€ìê°€ ì—†ìŠµë‹ˆë‹¤</div>';
    }
  } catch (error) {
    container.innerHTML = `<div class="loading">âŒ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ${error.message}</div>`;
  }
}

// ìš”ì¼ íƒ­ ë Œë”ë§
function renderDayTabs() {
  const container = document.getElementById('day-tabs');
  
  container.innerHTML = DAYS.map(day => `
    <div class="day-tab ${day === currentDay ? 'active' : ''}" data-day="${day}" onclick="selectDay('${day}')">
      ${day}
    </div>
  `).join('');
}

// ì¼ì • ë Œë”ë§
function renderSchedule() {
  const container = document.getElementById('schedule-view');
  
  const filtered = allPlayers.filter(p => 
    p.ë ˆì´ë“œì¢…ë¥˜ === currentRaidType && 
    !p.ëª»í•˜ëŠ”ìš”ì¼.includes(currentDay)
  );
  
  if (currentMode === 'view') {
    renderViewMode(container, filtered);
  } else {
    renderEditMode(container, filtered);
  }
}

// ì‹œê°„ëŒ€ë³„ ë„¤ì„ë“œ í™•ì¸
function getPlayerNemAtTime(player, timeIdx) {
  if (player.timeNemMap && player.timeNemMap[timeIdx] !== undefined) {
    return player.timeNemMap[timeIdx];
  }
  return player.ë„¤ì„ë“œ; // ê¸°ë³¸ê°’
}

// ë³´ê¸° ëª¨ë“œ - ì‹œê°„ëŒ€ë³„ ë„¤ì„ë“œ ì§€ì›
function renderViewMode(container, players) {
  const ROW_HEIGHT = 44;
  
  // í”Œë ˆì´ì–´ë³„ë¡œ ì—°ì†ëœ ë„¤ì„ë“œ êµ¬ê°„(ì„¸ê·¸ë¨¼íŠ¸)ìœ¼ë¡œ ë¶„ë¦¬
  const createSegments = (player) => {
    const { startIdx, endIdx } = getTimeRange(player.ì‹œì‘ì‹œê°„, player.ì¢…ë£Œì‹œê°„);
    const segments = [];
    let currentSeg = null;
    
    for (let t = startIdx; t <= endIdx; t++) {
      // hidden ì²´í¬
      if (player.hiddenTimes && player.hiddenTimes.includes(t)) {
        if (currentSeg) {
          segments.push(currentSeg);
          currentSeg = null;
        }
        continue;
      }
      
      const nem = getPlayerNemAtTime(player, t);
      
      if (!currentSeg || currentSeg.nem !== nem) {
        if (currentSeg) segments.push(currentSeg);
        currentSeg = { ...player, nem, startIdx: t, endIdx: t };
      } else {
        currentSeg.endIdx = t;
      }
    }
    if (currentSeg) segments.push(currentSeg);
    
    return segments;
  };
  
  // ëª¨ë“  í”Œë ˆì´ì–´ì˜ ì„¸ê·¸ë¨¼íŠ¸ ìƒì„±
  const allSegments = players.flatMap(createSegments);
  const nem1Segs = allSegments.filter(s => s.nem === '1ë„´');
  const nem2Segs = allSegments.filter(s => s.nem === '2ë„´');
  
  // ë ˆì¸ ë°°ì¹˜ (ê²¹ì¹¨ ì²˜ë¦¬)
  const assignLanes = (segs) => {
    if (segs.length === 0) return { segments: [], laneCount: 0 };
    const sorted = [...segs].sort((a, b) => a.startIdx - b.startIdx);
    const lanes = [];
    sorted.forEach(seg => {
      let assignedLane = -1;
      for (let i = 0; i < lanes.length; i++) {
        if (lanes[i] < seg.startIdx) { assignedLane = i; break; }
      }
      if (assignedLane === -1) { assignedLane = lanes.length; lanes.push(-1); }
      seg.lane = assignedLane;
      lanes[assignedLane] = seg.endIdx;
    });
    return { segments: sorted, laneCount: lanes.length || 1 };
  };
  
  const nem1Lanes = assignLanes(nem1Segs);
  const nem2Lanes = assignLanes(nem2Segs);
  
  // ì‹œê°„ë³„ í™œë™ ì¸ì› ìˆ˜
  const getActiveCount = (segs, timeIdx) => {
    return segs.filter(s => timeIdx >= s.startIdx && timeIdx <= s.endIdx).length;
  };
  
  // ë¸”ë¡ ë Œë”ë§
  const renderBlocks = (laneData, laneWidth) => {
    if (laneData.segments.length === 0) return '';
    return laneData.segments.map(s => {
      const jobInfo = getJobInfo(s.ì§ì—…);
      const top = s.startIdx * ROW_HEIGHT;
      const height = (s.endIdx - s.startIdx + 1) * ROW_HEIGHT - 4;
      const left = s.lane * laneWidth + 2;
      const width = laneWidth - 4;
      return `<div class="timeline-block ${jobInfo.class}" style="top:${top}px; height:${height}px; left:${left}px; width:${width}px;" title="${s.ì°¸ê³ ì‚¬í•­ || ''}">
        <span class="job-icon">${jobInfo.icon}</span>${s.ë‹‰ë„¤ì„}
      </div>`;
    }).join('');
  };
  
  // í–‰ ìƒì„±
  const rows = TIME_ORDER.map((_, idx) => {
    const total = getActiveCount(nem1Segs, idx) + getActiveCount(nem2Segs, idx);
    const highlightClass = total >= 8 ? 'highlight' : '';
    return `<tr style="height:${ROW_HEIGHT}px;">
      <td class="time-cell">${TIME_LABELS[idx]}</td>
      <td class="nem1-block-cell"></td>
      <td class="nem2-block-cell"></td>
      <td class="total-cell ${highlightClass}">${total}ëª…</td>
    </tr>`;
  }).join('');
  
  const laneWidth = 80;
  const nem1Width = Math.max(nem1Lanes.laneCount, 1) * laneWidth;
  const nem2Width = Math.max(nem2Lanes.laneCount, 1) * laneWidth;
  const totalHeight = TIME_ORDER.length * ROW_HEIGHT;
  
  container.innerHTML = `
    <table class="schedule-table timeline-table">
      <thead>
        <tr>
          <th class="time-header">ì‹œê°„</th>
          <th class="nem1" style="width:${nem1Width}px;">1ï¸âƒ£ 1ë„´</th>
          <th class="nem2" style="width:${nem2Width}px;">2ï¸âƒ£ 2ë„´</th>
          <th class="total">í•©ê³„</th>
        </tr>
      </thead>
      <tbody>${rows}</tbody>
    </table>
  `;
  
  // ì²« ë²ˆì§¸ í–‰ì— ë¸”ë¡ ì»¨í…Œì´ë„ˆ ì‚½ì…
  const firstRow = container.querySelector('tbody tr');
  const nem1Cell = firstRow.querySelector('.nem1-block-cell');
  const nem2Cell = firstRow.querySelector('.nem2-block-cell');
  
  nem1Cell.innerHTML = `<div class="blocks-container" style="height:${totalHeight}px;">${renderBlocks(nem1Lanes, laneWidth)}</div>`;
  nem1Cell.setAttribute('rowspan', TIME_ORDER.length);
  
  nem2Cell.innerHTML = `<div class="blocks-container" style="height:${totalHeight}px;">${renderBlocks(nem2Lanes, laneWidth)}</div>`;
  nem2Cell.setAttribute('rowspan', TIME_ORDER.length);
  
  // ë‚˜ë¨¸ì§€ í–‰ì˜ ë¸”ë¡ ì…€ ì œê±°
  const allRows = container.querySelectorAll('tbody tr');
  for (let i = 1; i < allRows.length; i++) {
    const nem1 = allRows[i].querySelector('.nem1-block-cell');
    const nem2 = allRows[i].querySelector('.nem2-block-cell');
    if (nem1) nem1.remove();
    if (nem2) nem2.remove();
  }
}

// í¸ì§‘ ëª¨ë“œ - ì‹œê°„ëŒ€ë³„ ë„¤ì„ë“œ ì§€ì›
function renderEditMode(container, players) {
  // í”Œë ˆì´ì–´ì— ì‹œê°„ ì •ë³´ ì¶”ê°€
  const processedPlayers = players.map(p => {
    const { startIdx, endIdx } = getTimeRange(p.ì‹œì‘ì‹œê°„, p.ì¢…ë£Œì‹œê°„);
    return { ...p, startIdx, endIdx };
  });
  
  // íŠ¹ì • ì‹œê°„ëŒ€ì— íŠ¹ì • ë„¤ì„ë“œë¡œ í™œë™ ì¤‘ì¸ í”Œë ˆì´ì–´ë“¤
  const getPlayersAtTimeForNem = (timeIdx, nemType) => {
    return processedPlayers.filter(p => {
      if (timeIdx < p.startIdx || timeIdx > p.endIdx) return false;
      return getPlayerNemAtTime(p, timeIdx) === nemType;
    });
  };
  
  // ë„¤ì„ë“œë³„ ê³ ìœ  í”Œë ˆì´ì–´ ëª©ë¡ (ë ˆì¸ ë°°ì¹˜ìš©)
  const getUniquePlayersForNem = (nemType) => {
    const seen = new Set();
    const result = [];
    processedPlayers.forEach(p => {
      if (seen.has(p.ë‹‰ë„¤ì„)) return;
      // ì´ í”Œë ˆì´ì–´ê°€ í•´ë‹¹ ë„¤ì„ë“œì— í•œ ë²ˆì´ë¼ë„ ì†í•˜ëŠ”ì§€
      for (let t = p.startIdx; t <= p.endIdx; t++) {
        if (getPlayerNemAtTime(p, t) === nemType) {
          seen.add(p.ë‹‰ë„¤ì„);
          result.push(p);
          break;
        }
      }
    });
    return result;
  };
  
  const nem1Players = getUniquePlayersForNem('1ë„´');
  const nem2Players = getUniquePlayersForNem('2ë„´');
  
  // í”Œë ˆì´ì–´ë³„ ë ˆì¸ ì¸ë±ìŠ¤ ë§¤í•‘
  const nem1LaneMap = {};
  nem1Players.forEach((p, idx) => nem1LaneMap[p.ë‹‰ë„¤ì„] = idx);
  const nem2LaneMap = {};
  nem2Players.forEach((p, idx) => nem2LaneMap[p.ë‹‰ë„¤ì„] = idx);
  
  // ì…€ ë Œë”ë§
  const renderCells = (timeIdx, nemType, laneMap, laneCount) => {
    if (laneCount === 0) return '<td class="players-cell"><span class="empty-cell">-</span></td>';
    
    const playersAtTime = getPlayersAtTimeForNem(timeIdx, nemType);
    const cells = new Array(laneCount).fill(null);
    
    playersAtTime.forEach(p => {
      const lane = laneMap[p.ë‹‰ë„¤ì„];
      if (lane !== undefined) cells[lane] = p;
    });
    
    return cells.map((p, lane) => {
      if (p) {
        const jobInfo = getJobInfo(p.ì§ì—…);
        const isHidden = p.hiddenTimes && p.hiddenTimes.includes(timeIdx);
        const disabledClass = isHidden ? 'disabled' : '';
        return `<td class="player-lane-cell">
          <span class="player-chip ${jobInfo.class} ${disabledClass}" 
                data-player="${p.ë‹‰ë„¤ì„}" 
                data-nem="${nemType}" 
                data-time="${timeIdx}"
                title="${p.ì°¸ê³ ì‚¬í•­ || ''}">
            <span class="job-icon">${jobInfo.icon}</span>${p.ë‹‰ë„¤ì„}
          </span>
        </td>`;
      } else {
        return '<td class="player-lane-cell empty"></td>';
      }
    }).join('');
  };
  
  // ì‹œê°„ë³„ í™œë™ ì¸ì› ìˆ˜ (hiddenTimes ì œì™¸)
  const getActiveCount = (timeIdx, nemType) => {
    return getPlayersAtTimeForNem(timeIdx, nemType).filter(p => {
      if (p.hiddenTimes && p.hiddenTimes.includes(timeIdx)) return false;
      return true;
    }).length;
  };
  
  const nem1LaneCount = nem1Players.length || 1;
  const nem2LaneCount = nem2Players.length || 1;
  
  const rows = TIME_ORDER.map((_, idx) => {
    const total = getActiveCount(idx, '1ë„´') + getActiveCount(idx, '2ë„´');
    const highlightClass = total >= 8 ? 'highlight' : '';
    return `
      <tr>
        <td class="time-cell">${TIME_LABELS[idx]}</td>
        ${renderCells(idx, '1ë„´', nem1LaneMap, nem1Players.length)}
        <td class="divider-cell"></td>
        ${renderCells(idx, '2ë„´', nem2LaneMap, nem2Players.length)}
        <td class="total-cell ${highlightClass}">${total}ëª…</td>
      </tr>
    `;
  }).join('');
  
  container.innerHTML = `
    <table class="schedule-table edit-table">
      <thead>
        <tr>
          <th class="time-header">ì‹œê°„</th>
          <th class="nem1" colspan="${nem1LaneCount}">1ï¸âƒ£ 1ë„´</th>
          <th class="divider-header"></th>
          <th class="nem2" colspan="${nem2LaneCount}">2ï¸âƒ£ 2ë„´</th>
          <th class="total">í•©ê³„</th>
        </tr>
      </thead>
      <tbody>${rows}</tbody>
    </table>
  `;
}

// ì°¸ê³ ì‚¬í•­ ë Œë”ë§ - ì°¸ê³ ì‚¬í•­ ìˆëŠ” ì‚¬ëŒë§Œ!
function renderNotes() {
  const notes = allPlayers
    .filter(p => p.ì°¸ê³ ì‚¬í•­ && p.ì°¸ê³ ì‚¬í•­.trim() !== '' && p.ë ˆì´ë“œì¢…ë¥˜ === currentRaidType)
    .map(p => ({ name: p.ë‹‰ë„¤ì„, note: p.ì°¸ê³ ì‚¬í•­ }));
  
  const container = document.getElementById('notes-section');
  
  if (notes.length > 0) {
    container.innerHTML = `
      <div class="notes">
        <h3>ğŸ“Œ ì°¸ê³  ì‚¬í•­</h3>
        ${notes.map(n => `<div class="note-item"><span class="name">${n.name}</span> â€” ${n.note}</div>`).join('')}
      </div>
    `;
  } else {
    container.innerHTML = '';
  }
}

// === ë“±ë¡ í¼ ===

document.querySelectorAll('.day-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    btn.classList.toggle('selected');
  });
});

function getSelectedDays() {
  const days = [];
  document.querySelectorAll('.day-btn.selected').forEach(btn => {
    days.push(btn.dataset.day);
  });
  return days;
}

function showMessage(elementId, type, text) {
  const el = document.getElementById(elementId);
  el.innerHTML = `<div class="message ${type}">${text}</div>`;
  setTimeout(() => { el.innerHTML = ''; }, 5000);
}

// ë‚´ ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸° - ìˆ˜ì •ë¨
async function loadMyInfo() {
  const nickname = document.getElementById('nickname').value.trim();
  if (!nickname) {
    showMessage('register-message', 'error', 'ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”');
    return;
  }

  const btn = document.querySelector('.search-btn');
  btn.disabled = true;
  btn.textContent = 'ê²€ìƒ‰ ì¤‘...';

  try {
    const response = await fetch(WEBHOOK_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ action: 'get', data: { 'ë‹‰ë„¤ì„': nickname } })
    });
    const result = await response.json();
    
    console.log('ë¶ˆëŸ¬ì˜¤ê¸° ê²°ê³¼:', result); // ë””ë²„ê¹…ìš©
    
    if (result.success && result.data) {
      const d = result.data;
      
      // í¼ í•„ë“œ ì±„ìš°ê¸°
      document.getElementById('job').value = d.ì§ì—… || '';
      document.getElementById('named').value = d.ë„¤ì„ë“œ || '';
      document.getElementById('startTime').value = d.ì‹œì‘ì‹œê°„ || 'ìƒê´€ì—†ìŒ';
      document.getElementById('endTime').value = d.ì¢…ë£Œì‹œê°„ || 'ìƒê´€ì—†ìŒ';
      document.getElementById('raidType').value = d.ë ˆì´ë“œì¢…ë¥˜ || 'íŠ¸ë¼ì´íŒŸ';
      document.getElementById('note').value = d.ì°¸ê³ ì‚¬í•­ || '';
      
      // ëª»í•˜ëŠ” ìš”ì¼ ì„¤ì •
      document.querySelectorAll('.day-btn').forEach(btn => {
        btn.classList.remove('selected');
      });
      
      if (d.ëª»í•˜ëŠ”ìš”ì¼ && Array.isArray(d.ëª»í•˜ëŠ”ìš”ì¼)) {
        d.ëª»í•˜ëŠ”ìš”ì¼.forEach(day => {
          const btn = document.querySelector(`.day-btn[data-day="${day}"]`);
          if (btn) btn.classList.add('selected');
        });
      }
      
      showMessage('register-message', 'success', `${nickname}ë‹˜ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤`);
    } else {
      showMessage('register-message', 'info', 'ë“±ë¡ëœ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤. ìƒˆë¡œ ë“±ë¡í•´ì£¼ì„¸ìš”.');
    }
  } catch (error) {
    console.error('ë¶ˆëŸ¬ì˜¤ê¸° ì—ëŸ¬:', error);
    showMessage('register-message', 'error', 'ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ' + error.message);
  } finally {
    btn.disabled = false;
    btn.textContent = 'ë¶ˆëŸ¬ì˜¤ê¸°';
  }
}

async function submitForm() {
  const nickname = document.getElementById('nickname').value.trim();
  const job = document.getElementById('job').value;
  
  if (!nickname) {
    showMessage('register-message', 'error', 'ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”');
    return;
  }
  if (!job) {
    showMessage('register-message', 'error', 'ì§ì—…ì„ ì„ íƒí•˜ì„¸ìš”');
    return;
  }

  const data = {
    'ë‹‰ë„¤ì„': nickname,
    'ì§ì—…': job,
    'ë„¤ì„ë“œ': document.getElementById('named').value || '',
    'ì‹œì‘ì‹œê°„': document.getElementById('startTime').value,
    'ì¢…ë£Œì‹œê°„': document.getElementById('endTime').value,
    'ëª»í•˜ëŠ”ìš”ì¼': getSelectedDays(),
    'ë ˆì´ë“œì¢…ë¥˜': document.getElementById('raidType').value,
    'ì°¸ê³ ì‚¬í•­': document.getElementById('note').value || ''
  };

  const btn = document.querySelector('.submit-btn');
  btn.disabled = true;
  btn.textContent = 'ì €ì¥ ì¤‘...';

  try {
    const response = await fetch(WEBHOOK_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ action: 'register', data })
    });
    const result = await response.json();
    
    if (result.success) {
      showMessage('register-message', 'success', 'ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
    } else {
      showMessage('register-message', 'error', 'ì €ì¥ ì‹¤íŒ¨: ' + (result.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
    }
  } catch (error) {
    showMessage('register-message', 'error', 'ì €ì¥ ì‹¤íŒ¨: ' + error.message);
  } finally {
    btn.disabled = false;
    btn.textContent = 'ì €ì¥í•˜ê¸°';
  }
}

// ============================================
// ë°•ìŠ¤ ì„ íƒ, ë“œë˜ê·¸ ë“œë¡­, ë¹„í™œì„±í™”, Undo
// ============================================
// selectedChips: "ë‹‰ë„¤ì„|ì‹œê°„ì¸ë±ìŠ¤" í˜•íƒœë¡œ ì €ì¥
let selectedChips = new Set();
let isSelecting = false;
let selectionStart = { x: 0, y: 0 };
let isDragging = false;
let undoStack = [];
const MAX_UNDO = 50;

// ìƒíƒœ ì €ì¥ (Undoìš©)
function saveState() {
  const state = allPlayers.map(p => ({
    ë‹‰ë„¤ì„: p.ë‹‰ë„¤ì„,
    ë„¤ì„ë“œ: p.ë„¤ì„ë“œ,
    timeNemMap: p.timeNemMap ? {...p.timeNemMap} : {},
    hiddenTimes: p.hiddenTimes ? [...p.hiddenTimes] : []
  }));
  undoStack.push(JSON.stringify(state));
  if (undoStack.length > MAX_UNDO) undoStack.shift();
}

// Undo ì‹¤í–‰
function undo() {
  if (undoStack.length === 0) return;
  const state = JSON.parse(undoStack.pop());
  state.forEach(saved => {
    const player = allPlayers.find(p => p.ë‹‰ë„¤ì„ === saved.ë‹‰ë„¤ì„);
    if (player) {
      player.ë„¤ì„ë“œ = saved.ë„¤ì„ë“œ;
      player.timeNemMap = saved.timeNemMap || {};
      player.hiddenTimes = saved.hiddenTimes || [];
    }
  });
  clearSelection();
  renderSchedule();
}

// í¸ì§‘ ëª¨ë“œ í† ê¸€
function toggleEditMode() {
  const btn = document.getElementById('edit-mode-btn');
  
  if (currentMode === 'view') {
    currentMode = 'edit';
    btn.textContent = 'âœ… í¸ì§‘ ì™„ë£Œ';
    btn.classList.add('active');
    document.getElementById('edit-hint').style.display = 'block';
  } else {
    currentMode = 'view';
    btn.textContent = 'âœï¸ í¸ì§‘ ëª¨ë“œ';
    btn.classList.remove('active');
    document.getElementById('edit-hint').style.display = 'none';
    clearSelection();
  }
  
  renderSchedule();
}

// ì„ íƒ ì´ˆê¸°í™”
function clearSelection() {
  selectedChips.clear();
  document.querySelectorAll('.player-chip.selected').forEach(chip => {
    chip.classList.remove('selected');
  });
  updateMoveControls();
}

// ì´ë™ ì»¨íŠ¸ë¡¤ ì—…ë°ì´íŠ¸
function updateMoveControls() {
  const controls = document.getElementById('move-controls');
  const countEl = document.getElementById('selected-count');
  
  // ì„ íƒëœ ê³ ìœ  í”Œë ˆì´ì–´ ìˆ˜ ê³„ì‚°
  const uniquePlayers = new Set();
  selectedChips.forEach(key => {
    const [name] = key.split('|');
    uniquePlayers.add(name);
  });
  
  if (selectedChips.size > 0) {
    controls.classList.add('active');
    countEl.textContent = `${uniquePlayers.size}ëª… (${selectedChips.size}ì¹¸) ì„ íƒë¨`;
  } else {
    controls.classList.remove('active');
  }
}

// ì„ íƒëœ ì¹©ë“¤ ì´ë™ (ì‹œê°„ëŒ€ë³„)
function moveSelectedTo(targetNem) {
  if (selectedChips.size === 0) return;
  
  saveState();
  
  // ì„ íƒëœ ì‹œê°„ëŒ€ë“¤ì˜ ë„¤ì„ë“œ ë³€ê²½
  selectedChips.forEach(key => {
    const [name, timeIdxStr] = key.split('|');
    const timeIdx = parseInt(timeIdxStr);
    const player = allPlayers.find(p => p.ë‹‰ë„¤ì„ === name);
    
    if (player) {
      if (!player.timeNemMap) player.timeNemMap = {};
      player.timeNemMap[timeIdx] = targetNem;
    }
  });
  
  clearSelection();
  renderSchedule();
}

// ì„ íƒëœ ì¹©ë“¤ ë¹„í™œì„±í™” (Delete)
function disableSelected() {
  if (selectedChips.size === 0) return;
  
  saveState();
  
  // í”Œë ˆì´ì–´ë³„ë¡œ ì„ íƒëœ ì‹œê°„ëŒ€ ìˆ˜ì§‘
  const playerTimes = {};
  selectedChips.forEach(key => {
    const [name, timeIdx] = key.split('|');
    if (!playerTimes[name]) playerTimes[name] = [];
    playerTimes[name].push(parseInt(timeIdx));
  });
  
  // ê° í”Œë ˆì´ì–´ì˜ ì„ íƒëœ ì‹œê°„ëŒ€ í† ê¸€
  Object.entries(playerTimes).forEach(([name, times]) => {
    const player = allPlayers.find(p => p.ë‹‰ë„¤ì„ === name);
    if (player) {
      if (!player.hiddenTimes) player.hiddenTimes = [];
      
      // ì„ íƒëœ ì‹œê°„ë“¤ì´ ì´ë¯¸ ë‹¤ ìˆ¨ê²¨ì ¸ ìˆìœ¼ë©´ ë³µì›, ì•„ë‹ˆë©´ ìˆ¨ê¹€
      const allHidden = times.every(t => player.hiddenTimes.includes(t));
      if (allHidden) {
        player.hiddenTimes = player.hiddenTimes.filter(t => !times.includes(t));
      } else {
        times.forEach(t => {
          if (!player.hiddenTimes.includes(t)) player.hiddenTimes.push(t);
        });
      }
    }
  });
  
  clearSelection();
  renderSchedule();
}

// ì„ íƒì˜ì—­ ì™¸ ë¹„í™œì„±í™” (Ctrl+Delete)
function disableUnselected() {
  if (selectedChips.size === 0) return;
  
  saveState();
  
  // í”Œë ˆì´ì–´ë³„ë¡œ ì„ íƒëœ ì‹œê°„ëŒ€ ìˆ˜ì§‘
  const playerSelectedTimes = {};
  selectedChips.forEach(key => {
    const [name, timeIdx] = key.split('|');
    if (!playerSelectedTimes[name]) playerSelectedTimes[name] = [];
    playerSelectedTimes[name].push(parseInt(timeIdx));
  });
  
  // ì„ íƒëœ í”Œë ˆì´ì–´ë“¤ë§Œ ì²˜ë¦¬
  Object.entries(playerSelectedTimes).forEach(([name, selectedTimes]) => {
    const player = allPlayers.find(p => p.ë‹‰ë„¤ì„ === name);
    if (player) {
      const { startIdx, endIdx } = getTimeRange(player.ì‹œì‘ì‹œê°„, player.ì¢…ë£Œì‹œê°„);
      
      // ì„ íƒë˜ì§€ ì•Šì€ ì‹œê°„ëŒ€ë¥¼ hiddenìœ¼ë¡œ
      player.hiddenTimes = [];
      for (let t = startIdx; t <= endIdx; t++) {
        if (!selectedTimes.includes(t)) {
          player.hiddenTimes.push(t);
        }
      }
    }
  });
  
  clearSelection();
  renderSchedule();
}

// í‚¤ë³´ë“œ ì´ë²¤íŠ¸
document.addEventListener('keydown', (e) => {
  // ESC: ì„ íƒ ì·¨ì†Œ
  if (e.key === 'Escape') {
    clearSelection();
    return;
  }
  
  // Ctrl+Z: ì„ íƒ ìˆìœ¼ë©´ ì„ íƒ ì·¨ì†Œ, ì—†ìœ¼ë©´ ë˜ëŒë¦¬ê¸°
  if (e.ctrlKey && e.key === 'z') {
    e.preventDefault();
    if (selectedChips.size > 0) {
      clearSelection();
    } else {
      undo();
    }
    return;
  }
  
  // Delete ê´€ë ¨
  if (e.key === 'Delete' && currentMode === 'edit' && selectedChips.size > 0) {
    e.preventDefault();
    if (e.ctrlKey) {
      disableUnselected(); // Ctrl+Delete: ì„ íƒì˜ì—­ ì™¸ ë¹„í™œì„±í™”
    } else {
      disableSelected(); // Delete: ì„ íƒì˜ì—­ ë¹„í™œì„±í™”
    }
  }
});

// ============================================
// ë°•ìŠ¤ ì„ íƒ ì´ë²¤íŠ¸ (Ctrl+ë“œë˜ê·¸)
// ============================================
document.addEventListener('mousedown', (e) => {
  if (currentMode !== 'edit') return;
  
  // Ctrl+ë“œë˜ê·¸: ë°•ìŠ¤ ì„ íƒ
  if (e.ctrlKey && !isDragging) {
    isSelecting = true;
    selectionStart = { x: e.clientX, y: e.clientY };
    
    const box = document.getElementById('selection-box');
    box.style.left = e.clientX + 'px';
    box.style.top = e.clientY + 'px';
    box.style.width = '0';
    box.style.height = '0';
    box.style.display = 'block';
    
    e.preventDefault();
    return;
  }
  
  // ì„ íƒëœ ì¹© ìœ„ì—ì„œ ë“œë˜ê·¸ ì‹œì‘ (ì´ë™ìš©)
  const chip = e.target.closest('.player-chip.selected');
  if (chip && selectedChips.size > 0) {
    isDragging = true;
    
    const uniquePlayers = new Set();
    selectedChips.forEach(key => uniquePlayers.add(key.split('|')[0]));
    
    const ghost = document.getElementById('drag-ghost');
    ghost.textContent = `${uniquePlayers.size}ëª… ì´ë™`;
    ghost.style.left = e.clientX + 10 + 'px';
    ghost.style.top = e.clientY + 10 + 'px';
    ghost.style.display = 'block';
    
    e.preventDefault();
  }
});

document.addEventListener('mousemove', (e) => {
  // ë°•ìŠ¤ ì„ íƒ ì¤‘
  if (isSelecting) {
    const box = document.getElementById('selection-box');
    const x = Math.min(e.clientX, selectionStart.x);
    const y = Math.min(e.clientY, selectionStart.y);
    const w = Math.abs(e.clientX - selectionStart.x);
    const h = Math.abs(e.clientY - selectionStart.y);
    
    box.style.left = x + 'px';
    box.style.top = y + 'px';
    box.style.width = w + 'px';
    box.style.height = h + 'px';
    return;
  }
  
  // ë“œë˜ê·¸ ì´ë™ ì¤‘
  if (isDragging) {
    const ghost = document.getElementById('drag-ghost');
    ghost.style.left = e.clientX + 10 + 'px';
    ghost.style.top = e.clientY + 10 + 'px';
    
    // ë“œë¡­ ì˜ì—­ í•˜ì´ë¼ì´íŠ¸
    document.querySelectorAll('.nem1, .nem2').forEach(el => el.classList.remove('drop-hover'));
    
    const target = document.elementFromPoint(e.clientX, e.clientY);
    if (target) {
      const th = target.closest('th.nem1, th.nem2');
      if (th) th.classList.add('drop-hover');
    }
  }
});

document.addEventListener('mouseup', (e) => {
  // ë°•ìŠ¤ ì„ íƒ ì™„ë£Œ
  if (isSelecting) {
    isSelecting = false;
    
    const box = document.getElementById('selection-box');
    const boxRect = box.getBoundingClientRect();
    box.style.display = 'none';
    
    // ë°•ìŠ¤ í¬ê¸°ê°€ ë„ˆë¬´ ì‘ìœ¼ë©´ ë¬´ì‹œ
    if (boxRect.width < 5 && boxRect.height < 5) return;
    
    // ë°•ìŠ¤ ì•ˆì˜ ì¹©ë“¤ë§Œ ì„ íƒ (ê°™ì€ ì´ë¦„ì´ë¼ë„ ì „ì²´ X)
    document.querySelectorAll('.edit-table .player-chip').forEach(chip => {
      const chipRect = chip.getBoundingClientRect();
      
      if (chipRect.left < boxRect.right && 
          chipRect.right > boxRect.left &&
          chipRect.top < boxRect.bottom && 
          chipRect.bottom > boxRect.top) {
        
        const playerName = chip.dataset.player;
        const timeIdx = chip.dataset.time;
        if (playerName && timeIdx !== undefined) {
          const key = `${playerName}|${timeIdx}`;
          selectedChips.add(key);
          chip.classList.add('selected');
        }
      }
    });
    
    updateMoveControls();
    return;
  }
  
  // ë“œë˜ê·¸ ë“œë¡­ ì™„ë£Œ
  if (isDragging) {
    isDragging = false;
    
    const ghost = document.getElementById('drag-ghost');
    ghost.style.display = 'none';
    
    document.querySelectorAll('.nem1, .nem2').forEach(el => el.classList.remove('drop-hover'));
    
    // ë“œë¡­ ì˜ì—­ íŒë³„
    const target = document.elementFromPoint(e.clientX, e.clientY);
    if (target) {
      // í—¤ë”ì— ë“œë¡­
      const th = target.closest('th.nem1, th.nem2');
      if (th) {
        const targetNem = th.classList.contains('nem1') ? '1ë„´' : '2ë„´';
        moveSelectedTo(targetNem);
        return;
      }
      
      // ì…€ì— ë“œë¡­
      const cell = target.closest('td.player-lane-cell');
      if (cell) {
        const row = cell.closest('tr');
        const dividerIdx = Array.from(row.children).findIndex(c => c.classList.contains('divider-cell'));
        const cellIdx = Array.from(row.children).indexOf(cell);
        const targetNem = cellIdx < dividerIdx ? '1ë„´' : '2ë„´';
        moveSelectedTo(targetNem);
        return;
      }
    }
    
    clearSelection();
  }
});

// ì´ˆê¸° ë¡œë“œ
initViewPanel();
</script>

</body>
</html>
