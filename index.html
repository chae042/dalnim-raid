<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸŒ™ ë‹¬ë‹˜ë´‡ - íŒŒí‹° ì¼ì •</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700;900&display=swap');

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'Noto Sans KR', sans-serif;
    background: #1a1a2e;
    color: #e0e0e0;
    padding: 24px;
    min-height: 100vh;
  }

  .container {
    max-width: 1100px;
    margin: 0 auto;
  }

  .loading {
    text-align: center;
    padding: 60px;
    color: #888;
  }

  .loading .spinner {
    font-size: 40px;
    animation: spin 2s linear infinite;
    display: inline-block;
  }

  @keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
  }

  /* Header */
  .header {
    text-align: center;
    margin-bottom: 32px;
  }

  .header h1 {
    font-size: 14px;
    font-weight: 400;
    color: #ffd700;
    letter-spacing: 4px;
    text-transform: uppercase;
    margin-bottom: 8px;
    opacity: 0.7;
  }

  .header h2 {
    font-size: 36px;
    font-weight: 700;
    color: #fff;
    margin-bottom: 4px;
  }

  .header .subtitle {
    font-size: 13px;
    color: #888;
  }

  /* Day Tabs */
  .day-tabs {
    display: flex;
    gap: 4px;
    margin-bottom: 24px;
    overflow-x: auto;
    padding-bottom: 4px;
    justify-content: center;
  }

  .day-tab {
    padding: 14px 24px;
    border-radius: 8px;
    background: #16213e;
    border: 1px solid #2a2a4a;
    color: #888;
    cursor: pointer;
    font-size: 16px;
    font-weight: 500;
    transition: all 0.2s;
    white-space: nowrap;
    text-align: center;
    min-width: 85px;
  }

  .day-tab:hover {
    background: #1f2f5a;
    color: #ccc;
  }

  .day-tab.active {
    background: #ffd700;
    color: #1a1a2e;
    border-color: #ffd700;
    font-weight: 700;
  }

  .day-tab .count {
    display: block;
    font-size: 24px;
    font-weight: 900;
    margin-top: 2px;
  }

  .day-tab.active .count {
    color: #1a1a2e;
  }

  /* Summary Bar */
  .summary-bar {
    display: flex;
    gap: 12px;
    margin-bottom: 20px;
    flex-wrap: wrap;
    justify-content: center;
  }

  .summary-item {
    background: #16213e;
    border-radius: 8px;
    padding: 12px 16px;
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 16px;
  }

  .summary-item.peak {
    border: 1px solid #ffd700;
    color: #ffd700;
  }

  .summary-item.info {
    border: 1px solid #60a5fa;
    color: #60a5fa;
  }

  /* Schedule Table */
  .schedule-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
  }

  .schedule-table th {
    background: #16213e;
    padding: 16px 12px;
    font-size: 18px;
    font-weight: 700;
    border-bottom: 2px solid #2a2a4a;
  }

  .schedule-table th.nem1 { color: #74b9ff; }
  .schedule-table th.nem2 { color: #ff7675; }
  .schedule-table th.total { color: #ffd700; }

  .schedule-table td {
    padding: 14px 12px;
    border-bottom: 1px solid #2a2a4a;
    vertical-align: top;
  }

  .schedule-table tr.peak-row {
    background: rgba(255, 215, 0, 0.05);
  }

  .schedule-table tr.peak-row td {
    border-bottom: 1px solid rgba(255, 215, 0, 0.3);
  }

  .time-cell {
    font-size: 18px;
    font-weight: 700;
    color: #666;
    text-align: center;
    width: 100px;
  }

  .peak-row .time-cell {
    color: #ffd700;
  }

  .players-cell {
    min-width: 200px;
  }

  .players-wrap {
    display: flex;
    flex-wrap: wrap;
    gap: 4px;
  }

  .total-cell {
    text-align: center;
    font-weight: 700;
    font-size: 18px;
    color: #888;
    width: 80px;
  }

  .peak-row .total-cell {
    color: #ffd700;
  }

  /* Player Chip */
  .player-chip {
    display: inline-flex;
    align-items: center;
    gap: 3px;
    padding: 6px 12px;
    border-radius: 5px;
    font-size: 14px;
    font-weight: 500;
    white-space: nowrap;
    transition: all 0.15s;
    border: 1px solid transparent;
  }

  .player-chip:hover {
    transform: translateY(-1px);
    filter: brightness(1.2);
  }

  .player-chip .job-icon {
    font-size: 10px;
    opacity: 0.8;
  }

  .player-chip.confirmed {
    box-shadow: 0 0 0 2px #ffd700;
  }

  /* Job Colors */
  .job-tank {
    background: rgba(59, 130, 246, 0.15);
    border-color: rgba(59, 130, 246, 0.3);
    color: #60a5fa;
  }

  .job-melee {
    background: rgba(239, 68, 68, 0.15);
    border-color: rgba(239, 68, 68, 0.3);
    color: #f87171;
  }

  .job-ranged {
    background: rgba(249, 115, 22, 0.15);
    border-color: rgba(249, 115, 22, 0.3);
    color: #fb923c;
  }

  .job-magic {
    background: rgba(168, 85, 247, 0.15);
    border-color: rgba(168, 85, 247, 0.3);
    color: #c084fc;
  }

  .job-healer {
    background: rgba(34, 197, 94, 0.15);
    border-color: rgba(34, 197, 94, 0.3);
    color: #4ade80;
  }

  .job-support {
    background: rgba(234, 179, 8, 0.15);
    border-color: rgba(234, 179, 8, 0.3);
    color: #facc15;
  }

  .empty-cell {
    color: #444;
    font-size: 12px;
  }

  /* Legend */
  .legend {
    display: flex;
    gap: 16px;
    margin-top: 24px;
    padding: 16px;
    background: #16213e;
    border-radius: 8px;
    flex-wrap: wrap;
    justify-content: center;
  }

  .legend-item {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 12px;
    color: #888;
  }

  .legend-chip {
    width: 14px;
    height: 14px;
    border-radius: 4px;
  }

  /* Notes */
  .notes {
    margin-top: 16px;
    padding: 16px;
    background: #16213e;
    border-radius: 8px;
    border-left: 3px solid #ffd700;
  }

  .notes h3 {
    font-size: 13px;
    color: #ffd700;
    margin-bottom: 8px;
    font-weight: 700;
  }

  .note-item {
    font-size: 13px;
    color: #888;
    line-height: 1.8;
  }

  .note-item .name {
    color: #ccc;
    font-weight: 500;
  }

  /* Footer */
  .footer {
    text-align: center;
    margin-top: 32px;
    font-size: 12px;
    color: #444;
  }
  .player-chip.no-time {
    opacity: 0.4;
    filter: grayscale(100%);
  }
</style>
</head>
<body>

<div class="container">
  <div id="app">
    <div class="loading">
      <div class="spinner">ğŸŒ™</div>
      <p style="margin-top: 16px;">ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
    </div>
  </div>
</div>

<script>
// êµ¬ê¸€ ì‹œíŠ¸ ì„¤ì •
const SHEET_ID = '1jY2Tqh01WOvTOw69Nd_mK6TmVO18pGstU4TdBVvgd5g';

// ìš”ì¼ ì„¤ì •
const DAYS = ['ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† ', 'ì¼', 'ì›”', 'í™”'];
const DAY_COLS = [9, 10, 11, 12, 13, 14, 15];

// ì§ì—… ë§¤í•‘
const JOB_MAP = {
  'ìˆ˜í˜¸ì„±': { class: 'job-tank', icon: 'ğŸ›¡' },
  'ê²€ì„±': { class: 'job-melee', icon: 'âš”ï¸' },
  'ê¶ì„±': { class: 'job-ranged', icon: 'ğŸ¹' },
  'ë§ˆë„ì„±': { class: 'job-magic', icon: 'â—†' },
  'ì¹˜ìœ ì„±': { class: 'job-healer', icon: 'âœš' },
  'í˜¸ë²•ì„±': { class: 'job-support', icon: 'â—ˆ' },
};

function getJobInfo(job) {
  for (const [name, info] of Object.entries(JOB_MAP)) {
    if (job && job.includes(name)) return { ...info, name };
  }
  return { class: 'job-support', icon: 'â—', name: job };
}

function parseTime(timeStr) {
  if (!timeStr || timeStr.includes('ìƒê´€')) return null;
  const match = timeStr.match(/(AM|PM)\s*(\d+)/i);
  if (match) {
    let hour = parseInt(match[2]);
    if (match[1].toUpperCase() === 'PM' && hour !== 12) hour += 12;
    if (match[1].toUpperCase() === 'AM' && hour === 12) hour = 0;
    return hour;
  }
  return null;
}

function getAvailableHours(startTime, endTime) {
  let start = parseTime(startTime);
  let end = parseTime(endTime);
  
  if (start === null) start = 18;
  if (end === null) end = 2;
  
  const hours = [];
  let current = start;
  let endHour = end <= start ? end + 24 : end;
  
  while (current <= endHour) {
    hours.push(current >= 24 ? current - 24 : current);
    current++;
  }
  return hours;
}

let allData = { nem1: [], nem2: [] };
let currentDay = 'ìˆ˜';

async function fetchSheetData() {
  const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json`;
  
  try {
    const response = await fetch(url);
    const text = await response.text();
    const json = JSON.parse(text.substring(47, text.length - 2));
    
    const rows = json.table.rows;
    let currentType = '1ë„´';
    
    allData = { nem1: [], nem2: [] };
    
    for (let i = 0; i < rows.length; i++) {
      const row = rows[i].c;
      if (!row) continue;
      
      const getValue = (idx) => row[idx]?.v?.toString().trim() || '';
      
      const typeCell = getValue(2);
      if (typeCell.includes('1í¬ìŠ¤') || typeCell.includes('1ë„¤ì„')) currentType = '1ë„´';
      if (typeCell.includes('2í¬ìŠ¤') || typeCell.includes('2ë„¤ì„')) currentType = '2ë„´';
      
      const nickname = getValue(4);
      if (!nickname || nickname === 'ë‹‰ë„¤ì„') continue;
      
      const confirmed = getValue(3) === 'TRUE';
      const job = getValue(5);
      const startTime = getValue(6);
      const endTime = getValue(7);
      const note = getValue(16) || '';
      
      // ìš”ì¼ë³„ ê°€ëŠ¥ ì—¬ë¶€ (ì²´í¬ = ëª»í•¨, ë¯¸ì²´í¬ = ê°€ëŠ¥)
      const days = {};
      DAYS.forEach((day, idx) => {
        const colIdx = DAY_COLS[idx];
        const cell = row[colIdx];
        const isChecked = cell?.v === true || cell?.v === 'TRUE' || cell?.f === 'TRUE';
        days[day] = !isChecked;
      });
      
      const noTime = !startTime && !endTime;
      const hours = getAvailableHours(startTime, endTime);
      
      const player = { nickname, job, confirmed, days, hours, note, startTime, endTime, noTime };
      
      if (currentType === '1ë„´') {
        allData.nem1.push(player);
      } else {
        allData.nem2.push(player);
      }
    }

    console.log('1ë„´:', allData.nem1.map(p => p.nickname));
    console.log('2ë„´:', allData.nem2.map(p => p.nickname));
    for (let i = 0; i < 15; i++) {
      const row = rows[i]?.c;
      const nickname = row?.[4]?.v;
      if (nickname) console.log(`Row ${i}: ${nickname}`);
    }
    
    renderUI();
  } catch (error) {
    document.getElementById('app').innerHTML = `
      <div class="loading">
        <p>âŒ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤</p>
        <p style="margin-top: 8px; font-size: 12px; color: #666;">${error.message}</p>
      </div>
    `;
  }
}

function getDaySchedule(day) {
  const timeSlots = {};
  for (let h = 18; h <= 26; h++) {
    const hour = h >= 24 ? h - 24 : h;
    timeSlots[hour] = { nem1: [], nem2: [] };
  }
  
  allData.nem1.forEach(p => {
    if (p.days[day]) {
      p.hours.forEach(h => {
        if (timeSlots[h]) timeSlots[h].nem1.push(p);
      });
    }
  });
  
  allData.nem2.forEach(p => {
    if (p.days[day]) {
      p.hours.forEach(h => {
        if (timeSlots[h]) timeSlots[h].nem2.push(p);
      });
    }
  });
  
  return timeSlots;
}

function getPeakTime(schedule) {
  let peakHour = 18;
  let peakCount = 0;
  
  Object.entries(schedule).forEach(([hour, data]) => {
    const total = data.nem1.length + data.nem2.length;
    if (total > peakCount) {
      peakCount = total;
      peakHour = parseInt(hour);
    }
  });
  
  return { hour: peakHour, count: peakCount };
}

function getDayTotalCount(day) {
  let count = 0;
  allData.nem1.forEach(p => { if (p.days[day]) count++; });
  allData.nem2.forEach(p => { if (p.days[day]) count++; });
  return count;
}

function renderUI() {
  const schedule = getDaySchedule(currentDay);
  const peak = getPeakTime(schedule);
  
  const notes = [];
  [...allData.nem1, ...allData.nem2].forEach(p => {
    if (p.note) notes.push({ name: p.nickname, note: p.note });
  });
  
  const hours = [18, 19, 20, 21, 22, 23, 0, 1, 2];
  
  const renderPlayers = (players) => {
    if (players.length === 0) return '<span class="empty-cell">-</span>';
    return `<div class="players-wrap">${players.map(p => {
      const jobInfo = getJobInfo(p.job);
      const confirmedClass = p.confirmed ? 'confirmed' : '';
      const noTimeClass = p.noTime ? 'no-time' : '';
      return `<span class="player-chip ${jobInfo.class} ${confirmedClass} ${noTimeClass}">
        <span class="job-icon">${jobInfo.icon}</span>${p.nickname}
      </span>`;
    }).join('')}</div>`;
  };
  
  const tableRows = hours.map(hour => {
    const nem1Players = schedule[hour].nem1;
    const nem2Players = schedule[hour].nem2;
    const total = nem1Players.length + nem2Players.length;
    const isPeak = hour === peak.hour;
    const hourLabel = hour < 6 ? `ìµì¼ ${hour.toString().padStart(2, '0')}ì‹œ` : `${hour.toString().padStart(2, '0')}ì‹œ`;
    
    return `
      <tr>
        <td class="time-cell">${hourLabel}</td>
        <td class="players-cell">${renderPlayers(nem1Players)}</td>
        <td class="players-cell">${renderPlayers(nem2Players)}</td>
        <td class="total-cell">${total}ëª…</td>
      </tr>
    `;
  }).join('');
  
  document.getElementById('app').innerHTML = `
    <div class="header">
      <h1>ğŸŒ™ ë£¨ë“œë¼ íŠ¸ë¼ì´íŒŸ</h1>
      <h2>${currentDay}ìš”ì¼</h2>
      <div class="subtitle">ì‹œê°„ëŒ€ë³„ ì°¸ì—¬ ê°€ëŠ¥ ì¸ì›</div>
    </div>
    
    <div class="day-tabs">
      ${DAYS.map(day => `
        <div class="day-tab ${day === currentDay ? 'active' : ''}" onclick="selectDay('${day}')">
          ${day}
          <span class="count">${getDayTotalCount(day)}</span>
        </div>
      `).join('')}
    </div>
    
    
    <table class="schedule-table">
      <thead>
        <tr>
          <th>ì‹œê°„</th>
          <th class="nem1">1ï¸âƒ£ 1ë„¤ì„ë“œ</th>
          <th class="nem2">2ï¸âƒ£ 2ë„¤ì„ë“œ</th>
          <th class="total">í•©ê³„</th>
        </tr>
      </thead>
      <tbody>
        ${tableRows}
      </tbody>
    </table>
    
    <div class="legend">
      <div class="legend-item"><div class="legend-chip" style="background: rgba(59, 130, 246, 0.4);"></div> ìˆ˜í˜¸ì„±</div>
      <div class="legend-item"><div class="legend-chip" style="background: rgba(239, 68, 68, 0.4);"></div> ê²€ì„±</div>
      <div class="legend-item"><div class="legend-chip" style="background: rgba(249, 115, 22, 0.4);"></div> ê¶ì„±</div>
      <div class="legend-item"><div class="legend-chip" style="background: rgba(168, 85, 247, 0.4);"></div> ë§ˆë„ì„±</div>
      <div class="legend-item"><div class="legend-chip" style="background: rgba(34, 197, 94, 0.4);"></div> ì¹˜ìœ ì„±</div>
      <div class="legend-item"><div class="legend-chip" style="background: rgba(234, 179, 8, 0.4);"></div> í˜¸ë²•ì„±</div>
      <div class="legend-item">âœ¨ ê¸ˆí…Œ = ì°¸ì—¬ í™•ì •</div>
    </div>
    
    ${notes.length > 0 ? `
      <div class="notes">
        <h3>ğŸ“Œ ì°¸ê³  ì‚¬í•­</h3>
        ${notes.map(n => `<div class="note-item"><span class="name">${n.name}</span> â€” ${n.note}</div>`).join('')}
      </div>
    ` : ''}
    
    <div class="footer">
      ğŸŒ™ ë‹¬ë‹˜ë´‡ Â· ${new Date().toLocaleString('ko-KR')}
    </div>
  `;
}

function selectDay(day) {
  currentDay = day;
  renderUI();
}

fetchSheetData();
</script>

</body>
</html>
