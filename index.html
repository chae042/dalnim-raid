<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸŒ™ ë‹¬ë‹˜ë´‡ - íŒŒí‹° ì¼ì •</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700;900&display=swap');

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'Noto Sans KR', sans-serif;
    background: #1a1a2e;
    color: #e0e0e0;
    padding: 24px;
    min-height: 100vh;
  }

  .container {
    max-width: 1100px;
    margin: 0 auto;
  }

  .loading {
    text-align: center;
    padding: 60px;
    color: #888;
  }

  .loading .spinner {
    font-size: 40px;
    animation: spin 2s linear infinite;
    display: inline-block;
  }

  @keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
  }

  /* Header */
  .header {
    text-align: center;
    margin-bottom: 32px;
  }

  .header h1 {
    font-size: 14px;
    font-weight: 400;
    color: #ffd700;
    letter-spacing: 4px;
    text-transform: uppercase;
    margin-bottom: 8px;
    opacity: 0.7;
  }

  .header h2 {
    font-size: 36px;
    font-weight: 700;
    color: #fff;
    margin-bottom: 4px;
  }

  .header .subtitle {
    font-size: 13px;
    color: #888;
  }

  /* Main Tabs (ë“±ë¡/ì¼ì •ë³´ê¸°) */
  .main-tabs {
    display: flex;
    gap: 4px;
    margin-bottom: 24px;
    justify-content: center;
  }

  .main-tab {
    padding: 14px 32px;
    border-radius: 8px;
    background: #16213e;
    border: 1px solid #2a2a4a;
    color: #888;
    cursor: pointer;
    font-size: 16px;
    font-weight: 500;
    transition: all 0.2s;
  }

  .main-tab:hover {
    background: #1f2f5a;
    color: #ccc;
  }

  .main-tab.active {
    background: #ffd700;
    color: #1a1a2e;
    border-color: #ffd700;
    font-weight: 700;
  }

  .panel {
    display: none;
  }

  .panel.active {
    display: block;
  }

  /* ë“±ë¡ í¼ */
  .register-panel {
    max-width: 500px;
    margin: 0 auto;
    background: #16213e;
    padding: 24px;
    border-radius: 12px;
  }

  .form-group {
    margin-bottom: 20px;
  }

  .form-group label {
    display: block;
    margin-bottom: 8px;
    font-size: 14px;
    color: #888;
    font-weight: 500;
  }

  .form-group input[type="text"],
  .form-group select {
    width: 100%;
    padding: 14px;
    font-size: 16px;
    border: 1px solid #2a2a4a;
    border-radius: 8px;
    background: #1a1a2e;
    color: #fff;
    font-family: inherit;
  }

  .form-group input:focus,
  .form-group select:focus {
    outline: none;
    border-color: #ffd700;
  }

  .search-box {
    display: flex;
    gap: 8px;
  }

  .search-box input {
    flex: 1;
  }

  .search-btn {
    padding: 14px 20px;
    background: #2a2a4a;
    border: 1px solid #3a3a5a;
    border-radius: 8px;
    color: #fff;
    cursor: pointer;
    font-size: 14px;
    white-space: nowrap;
  }

  .search-btn:hover {
    background: #3a3a5a;
  }

  .day-buttons {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
  }

  .day-btn {
    padding: 12px 16px;
    font-size: 14px;
    border: 2px solid #2a2a4a;
    border-radius: 8px;
    background: transparent;
    color: #888;
    cursor: pointer;
    transition: all 0.2s;
    font-weight: 500;
  }

  .day-btn:hover {
    border-color: #ffd700;
    color: #ffd700;
  }

  .day-btn.selected {
    background: #ff6b6b;
    border-color: #ff6b6b;
    color: #fff;
  }

  .submit-btn {
    width: 100%;
    padding: 16px;
    font-size: 18px;
    font-weight: 700;
    border: none;
    border-radius: 8px;
    background: #ffd700;
    color: #1a1a2e;
    cursor: pointer;
    margin-top: 12px;
    transition: all 0.2s;
  }

  .submit-btn:hover {
    background: #ffed4a;
    transform: translateY(-1px);
  }

  .submit-btn:disabled {
    background: #444;
    cursor: not-allowed;
    transform: none;
  }

  .message {
    padding: 12px 16px;
    border-radius: 8px;
    margin-bottom: 16px;
    text-align: center;
    font-size: 14px;
  }

  .message.success { background: rgba(46, 204, 113, 0.2); color: #2ecc71; border: 1px solid #2ecc71; }
  .message.error { background: rgba(231, 76, 60, 0.2); color: #e74c3c; border: 1px solid #e74c3c; }
  .message.info { background: rgba(52, 152, 219, 0.2); color: #3498db; border: 1px solid #3498db; }

  /* Raid Type Tabs */
  .raid-tabs {
    display: flex;
    gap: 8px;
    margin-bottom: 20px;
    justify-content: center;
  }

  .raid-tab {
    padding: 10px 24px;
    border-radius: 20px;
    background: #16213e;
    border: 1px solid #2a2a4a;
    color: #888;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    transition: all 0.2s;
  }

  .raid-tab:hover {
    border-color: #ffd700;
    color: #ffd700;
  }

  .raid-tab.active {
    background: #ffd700;
    color: #1a1a2e;
    border-color: #ffd700;
    font-weight: 700;
  }

  /* View Mode Toggle */
  .view-toggle {
    display: flex;
    gap: 8px;
    margin-bottom: 20px;
    justify-content: center;
  }

  .view-toggle-btn {
    padding: 8px 16px;
    border-radius: 6px;
    background: transparent;
    border: 1px solid #2a2a4a;
    color: #888;
    cursor: pointer;
    font-size: 13px;
    transition: all 0.2s;
  }

  .view-toggle-btn:hover {
    border-color: #60a5fa;
    color: #60a5fa;
  }

  .view-toggle-btn.active {
    background: #60a5fa;
    color: #fff;
    border-color: #60a5fa;
  }

  /* Day Tabs */
  .day-tabs {
    display: flex;
    gap: 4px;
    margin-bottom: 24px;
    overflow-x: auto;
    padding-bottom: 4px;
    justify-content: center;
  }

  .day-tab {
    padding: 14px 24px;
    border-radius: 8px;
    background: #16213e;
    border: 1px solid #2a2a4a;
    color: #888;
    cursor: pointer;
    font-size: 16px;
    font-weight: 500;
    transition: all 0.2s;
    white-space: nowrap;
    text-align: center;
    min-width: 85px;
  }

  .day-tab:hover {
    background: #1f2f5a;
    color: #ccc;
  }

  .day-tab.active {
    background: #ffd700;
    color: #1a1a2e;
    border-color: #ffd700;
    font-weight: 700;
  }

  .day-tab .count {
    display: block;
    font-size: 24px;
    font-weight: 900;
    margin-top: 2px;
  }

  .day-tab.active .count {
    color: #1a1a2e;
  }

  /* Schedule Table */
  .schedule-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
  }

  .schedule-table th {
    background: #16213e;
    padding: 16px 12px;
    font-size: 18px;
    font-weight: 700;
    border-bottom: 2px solid #2a2a4a;
  }

  .schedule-table th.nem1 { color: #74b9ff; }
  .schedule-table th.nem2 { color: #ff7675; }
  .schedule-table th.total { color: #ffd700; }

  .schedule-table td {
    padding: 14px 12px;
    border-bottom: 1px solid #2a2a4a;
    vertical-align: top;
  }

  .time-cell {
    font-size: 18px;
    font-weight: 700;
    color: #666;
    text-align: center;
    width: 100px;
  }

  .players-cell {
    min-width: 200px;
    position: relative;
  }

  .players-wrap {
    display: flex;
    flex-wrap: wrap;
    gap: 4px;
  }

  .total-cell {
    text-align: center;
    font-weight: 700;
    font-size: 18px;
    color: #888;
    width: 80px;
  }

  /* Player Chip */
  .player-chip {
    display: inline-flex;
    align-items: center;
    gap: 3px;
    padding: 6px 12px;
    border-radius: 5px;
    font-size: 14px;
    font-weight: 500;
    white-space: nowrap;
    transition: all 0.15s;
    border: 1px solid transparent;
    cursor: default;
  }

  .player-chip:hover {
    transform: translateY(-1px);
    filter: brightness(1.2);
  }

  .player-chip .job-icon {
    font-size: 10px;
    opacity: 0.8;
  }

  /* Player Block (ë·° ëª¨ë“œìš© - ì„¸ë¡œ ë³‘í•©) */
  .player-block {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 8px 14px;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 600;
    white-space: nowrap;
    margin: 2px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
  }

  .player-block .time-range {
    font-size: 11px;
    opacity: 0.7;
    margin-left: 4px;
  }

  /* Job Colors */
  .job-tank {
    background: rgba(59, 130, 246, 0.2);
    border-color: rgba(59, 130, 246, 0.4);
    color: #60a5fa;
  }

  .job-melee {
    background: rgba(239, 68, 68, 0.2);
    border-color: rgba(239, 68, 68, 0.4);
    color: #f87171;
  }

  .job-ranged {
    background: rgba(249, 115, 22, 0.2);
    border-color: rgba(249, 115, 22, 0.4);
    color: #fb923c;
  }

  .job-magic {
    background: rgba(168, 85, 247, 0.2);
    border-color: rgba(168, 85, 247, 0.4);
    color: #c084fc;
  }

  .job-assassin {
    background: rgba(236, 72, 153, 0.2);
    border-color: rgba(236, 72, 153, 0.4);
    color: #ec4899;
  }

  .job-summoner {
    background: rgba(20, 184, 166, 0.2);
    border-color: rgba(20, 184, 166, 0.4);
    color: #14b8a6;
  }

  .job-healer {
    background: rgba(34, 197, 94, 0.2);
    border-color: rgba(34, 197, 94, 0.4);
    color: #4ade80;
  }

  .job-support {
    background: rgba(234, 179, 8, 0.2);
    border-color: rgba(234, 179, 8, 0.4);
    color: #facc15;
  }

  .empty-cell {
    color: #444;
    font-size: 12px;
  }

  .player-chip.no-time {
    opacity: 0.4;
    filter: grayscale(100%);
  }

  /* Block View - ë¸”ë¡ ë·° ì „ìš© ìŠ¤íƒ€ì¼ */
  .block-view {
    display: flex;
    gap: 20px;
    margin-top: 20px;
  }

  .block-column {
    flex: 1;
    background: #16213e;
    border-radius: 12px;
    padding: 16px;
  }

  .block-column-header {
    text-align: center;
    font-size: 18px;
    font-weight: 700;
    padding-bottom: 12px;
    margin-bottom: 12px;
    border-bottom: 2px solid #2a2a4a;
  }

  .block-column-header.nem1 { color: #74b9ff; }
  .block-column-header.nem2 { color: #ff7675; }

  .block-list {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .player-block-card {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 16px;
    border-radius: 8px;
    border: 1px solid transparent;
  }

  .player-block-card .player-name {
    font-weight: 600;
    font-size: 16px;
    flex: 1;
  }

  .player-block-card .player-time {
    font-size: 13px;
    opacity: 0.7;
  }

  .player-block-card .player-note {
    font-size: 12px;
    opacity: 0.6;
    margin-top: 4px;
  }

  /* Legend */
  .legend {
    display: flex;
    gap: 16px;
    margin-top: 24px;
    padding: 16px;
    background: #16213e;
    border-radius: 8px;
    flex-wrap: wrap;
    justify-content: center;
  }

  .legend-item {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 12px;
    color: #888;
  }

  .legend-chip {
    width: 14px;
    height: 14px;
    border-radius: 4px;
  }

  /* Notes */
  .notes {
    margin-top: 16px;
    padding: 16px;
    background: #16213e;
    border-radius: 8px;
    border-left: 3px solid #ffd700;
  }

  .notes h3 {
    font-size: 13px;
    color: #ffd700;
    margin-bottom: 8px;
    font-weight: 700;
  }

  .note-item {
    font-size: 13px;
    color: #888;
    line-height: 1.8;
  }

  .note-item .name {
    color: #ccc;
    font-weight: 500;
  }

  /* Footer */
  .footer {
    text-align: center;
    margin-top: 32px;
    font-size: 12px;
    color: #444;
  }
</style>
</head>
<body>

<div class="container">
  <div class="header">
    <h1>ğŸŒ™ ë‹¬ ê¸¸ë“œ ë ˆì´ë“œ</h1>
    <h2>íŒŒí‹° ì¼ì •</h2>
    <div class="subtitle">ë“±ë¡ ë° ì‹œê°„ëŒ€ë³„ ì°¸ì—¬ ê°€ëŠ¥ ì¸ì›</div>
  </div>

  <!-- ë©”ì¸ íƒ­ -->
  <div class="main-tabs">
    <div class="main-tab active" onclick="showMainTab('view')">ğŸ“‹ ì¼ì • ë³´ê¸°</div>
    <div class="main-tab" onclick="showMainTab('register')">âœï¸ ë“±ë¡/ìˆ˜ì •</div>
  </div>

  <!-- ì¼ì • ë³´ê¸° íŒ¨ë„ -->
  <div id="view-panel" class="panel active">
    <!-- ë ˆì´ë“œ íƒ€ì… íƒ­ -->
    <div class="raid-tabs">
      <div class="raid-tab active" data-raid="íŠ¸ë¼ì´íŒŸ" onclick="selectRaidType('íŠ¸ë¼ì´íŒŸ')">íŠ¸ë¼ì´íŒŸ</div>
      <div class="raid-tab" data-raid="í´ë¦¬ì–´íŒŸ" onclick="selectRaidType('í´ë¦¬ì–´íŒŸ')">í´ë¦¬ì–´íŒŸ</div>
    </div>

    <!-- ë·° ëª¨ë“œ í† ê¸€ -->
    <div class="view-toggle">
      <button class="view-toggle-btn active" onclick="setViewMode('block')">ğŸ“Š ë¸”ë¡ ë·°</button>
      <button class="view-toggle-btn" onclick="setViewMode('table')">ğŸ“‹ ì‹œê°„ë³„ ë·°</button>
    </div>

    <!-- ìš”ì¼ íƒ­ -->
    <div class="day-tabs" id="day-tabs"></div>

    <!-- ì¼ì • ë·° -->
    <div id="schedule-view">
      <div class="loading">
        <div class="spinner">ğŸŒ™</div>
        <p style="margin-top: 16px;">ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
      </div>
    </div>

    <!-- ë²”ë¡€ -->
    <div class="legend">
      <div class="legend-item"><div class="legend-chip" style="background: rgba(59, 130, 246, 0.4);"></div> ìˆ˜í˜¸ì„±</div>
      <div class="legend-item"><div class="legend-chip" style="background: rgba(239, 68, 68, 0.4);"></div> ê²€ì„±</div>
      <div class="legend-item"><div class="legend-chip" style="background: rgba(249, 115, 22, 0.4);"></div> ê¶ì„±</div>
      <div class="legend-item"><div class="legend-chip" style="background: rgba(168, 85, 247, 0.4);"></div> ë§ˆë„ì„±</div>
      <div class="legend-item"><div class="legend-chip" style="background: rgba(34, 197, 94, 0.4);"></div> ì¹˜ìœ ì„±</div>
      <div class="legend-item"><div class="legend-chip" style="background: rgba(234, 179, 8, 0.4);"></div> í˜¸ë²•ì„±</div>
      <div class="legend-item"><div class="legend-chip" style="background: rgba(236, 72, 153, 0.4);"></div> ì‚´ì„±</div>
      <div class="legend-item"><div class="legend-chip" style="background: rgba(20, 184, 166, 0.4);"></div> ì •ë ¹ì„±</div>
    </div>

    <!-- ì°¸ê³ ì‚¬í•­ -->
    <div id="notes-section"></div>

    <div class="footer">
      ğŸŒ™ ë‹¬ë‹˜ë´‡ Â· <span id="update-time"></span>
    </div>
  </div>

  <!-- ë“±ë¡/ìˆ˜ì • íŒ¨ë„ -->
  <div id="register-panel" class="panel">
    <div class="register-panel">
      <div id="register-message"></div>
      
      <div class="form-group">
        <label>ë‹‰ë„¤ì„ *</label>
        <div class="search-box">
          <input type="text" id="nickname" placeholder="ìºë¦­í„° ì´ë¦„">
          <button class="search-btn" onclick="loadMyInfo()">ë¶ˆëŸ¬ì˜¤ê¸°</button>
        </div>
      </div>

      <div class="form-group">
        <label>ì§ì—… *</label>
        <select id="job">
          <option value="">ì„ íƒí•˜ì„¸ìš”</option>
          <option value="ìˆ˜í˜¸ì„±">ìˆ˜í˜¸ì„±</option>
          <option value="ê²€ì„±">ê²€ì„±</option>
          <option value="ê¶ì„±">ê¶ì„±</option>
          <option value="ë§ˆë„ì„±">ë§ˆë„ì„±</option>
          <option value="ì¹˜ìœ ì„±">ì¹˜ìœ ì„±</option>
          <option value="í˜¸ë²•ì„±">í˜¸ë²•ì„±</option>
          <option value="ì‚´ì„±">ì‚´ì„±</option>
          <option value="ì •ë ¹ì„±">ì •ë ¹ì„±</option>
        </select>
      </div>

      <div class="form-group">
        <label>ë„¤ì„ë“œ</label>
        <select id="named">
          <option value="">ì„ íƒí•˜ì„¸ìš”</option>
          <option value="1ë„´">1ë„´</option>
          <option value="2ë„´">2ë„´</option>
        </select>
      </div>

      <div class="form-group">
        <label>ì‹œì‘ ê°€ëŠ¥ ì‹œê°„</label>
        <select id="startTime">
          <option value="ìƒê´€ì—†ìŒ">ìƒê´€ì—†ìŒ</option>
          <option value="PM 6">PM 6 (18ì‹œ)</option>
          <option value="PM 7">PM 7 (19ì‹œ)</option>
          <option value="PM 8">PM 8 (20ì‹œ)</option>
          <option value="PM 9">PM 9 (21ì‹œ)</option>
          <option value="PM 10">PM 10 (22ì‹œ)</option>
          <option value="PM 11">PM 11 (23ì‹œ)</option>
          <option value="AM 12">AM 12 (24ì‹œ)</option>
          <option value="AM 1">AM 1 (01ì‹œ)</option>
          <option value="AM 2">AM 2 (02ì‹œ)</option>
        </select>
      </div>

      <div class="form-group">
        <label>ì¢…ë£Œ ê°€ëŠ¥ ì‹œê°„</label>
        <select id="endTime">
          <option value="ìƒê´€ì—†ìŒ">ìƒê´€ì—†ìŒ</option>
          <option value="PM 6">PM 6 (18ì‹œ)</option>
          <option value="PM 7">PM 7 (19ì‹œ)</option>
          <option value="PM 8">PM 8 (20ì‹œ)</option>
          <option value="PM 9">PM 9 (21ì‹œ)</option>
          <option value="PM 10">PM 10 (22ì‹œ)</option>
          <option value="PM 11">PM 11 (23ì‹œ)</option>
          <option value="AM 12">AM 12 (24ì‹œ)</option>
          <option value="AM 1">AM 1 (01ì‹œ)</option>
          <option value="AM 2">AM 2 (02ì‹œ)</option>
        </select>
      </div>

      <div class="form-group">
        <label>ë ˆì´ë“œ ì¢…ë¥˜</label>
        <select id="raidType">
          <option value="íŠ¸ë¼ì´íŒŸ">íŠ¸ë¼ì´íŒŸ</option>
          <option value="í´ë¦¬ì–´íŒŸ">í´ë¦¬ì–´íŒŸ</option>
        </select>
      </div>

      <div class="form-group">
        <label>ëª»í•˜ëŠ” ìš”ì¼ (í´ë¦­í•´ì„œ ì„ íƒ)</label>
        <div class="day-buttons">
          <button type="button" class="day-btn" data-day="ì›”">ì›”</button>
          <button type="button" class="day-btn" data-day="í™”">í™”</button>
          <button type="button" class="day-btn" data-day="ìˆ˜">ìˆ˜</button>
          <button type="button" class="day-btn" data-day="ëª©">ëª©</button>
          <button type="button" class="day-btn" data-day="ê¸ˆ">ê¸ˆ</button>
          <button type="button" class="day-btn" data-day="í† ">í† </button>
          <button type="button" class="day-btn" data-day="ì¼">ì¼</button>
        </div>
      </div>

      <div class="form-group">
        <label>ì°¸ê³ ì‚¬í•­</label>
        <input type="text" id="note" placeholder="ì˜ˆ: ê¸ˆí† ë§Œ ê°€ëŠ¥, 24ì‹œ ì´ì „ ì„ í˜¸">
      </div>

      <button class="submit-btn" onclick="submitForm()">ì €ì¥í•˜ê¸°</button>
    </div>
  </div>
</div>

<script>
const WEBHOOK_URL = 'https://n8n-production-f0a7.up.railway.app/webhook/raid';
const DAYS = ['ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† ', 'ì¼'];
const TIME_ORDER = ['PM 6', 'PM 7', 'PM 8', 'PM 9', 'PM 10', 'PM 11', 'AM 12', 'AM 1', 'AM 2'];
const TIME_LABELS = ['18ì‹œ', '19ì‹œ', '20ì‹œ', '21ì‹œ', '22ì‹œ', '23ì‹œ', 'ìµì¼ 00ì‹œ', 'ìµì¼ 01ì‹œ', 'ìµì¼ 02ì‹œ'];

const JOB_MAP = {
  'ìˆ˜í˜¸ì„±': { class: 'job-tank', icon: 'ğŸ›¡' },
  'ê²€ì„±': { class: 'job-melee', icon: 'âš”ï¸' },
  'ê¶ì„±': { class: 'job-ranged', icon: 'ğŸ¹' },
  'ë§ˆë„ì„±': { class: 'job-magic', icon: 'â—†' },
  'ì¹˜ìœ ì„±': { class: 'job-healer', icon: 'âœš' },
  'í˜¸ë²•ì„±': { class: 'job-support', icon: 'â—ˆ' },
  'ì‚´ì„±': { class: 'job-assassin', icon: 'ğŸ—¡' },
  'ì •ë ¹ì„±': { class: 'job-summoner', icon: 'ğŸ”®' },
};

let allPlayers = [];
let currentDay = 'ê¸ˆ';
let currentRaidType = 'íŠ¸ë¼ì´íŒŸ';
let viewMode = 'block'; // 'block' or 'table'

// ë©”ì¸ íƒ­ ì „í™˜
function showMainTab(tabName) {
  document.querySelectorAll('.main-tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
  
  const tabIndex = tabName === 'view' ? 0 : 1;
  document.querySelectorAll('.main-tab')[tabIndex].classList.add('active');
  document.getElementById(`${tabName}-panel`).classList.add('active');
  
  if (tabName === 'view') {
    loadPlayerList();
  }
}

// ë ˆì´ë“œ íƒ€ì… ì„ íƒ
function selectRaidType(type) {
  currentRaidType = type;
  document.querySelectorAll('.raid-tab').forEach(t => {
    t.classList.toggle('active', t.dataset.raid === type);
  });
  renderDayTabs();
  renderSchedule();
}

// ë·° ëª¨ë“œ ë³€ê²½
function setViewMode(mode) {
  viewMode = mode;
  document.querySelectorAll('.view-toggle-btn').forEach(btn => {
    btn.classList.toggle('active', btn.textContent.includes(mode === 'block' ? 'ë¸”ë¡' : 'ì‹œê°„ë³„'));
  });
  renderSchedule();
}

// ìš”ì¼ ì„ íƒ
function selectDay(day) {
  currentDay = day;
  document.querySelectorAll('.day-tab').forEach(t => {
    t.classList.toggle('active', t.dataset.day === day);
  });
  renderSchedule();
}

// ì§ì—… ì •ë³´ ê°€ì ¸ì˜¤ê¸°
function getJobInfo(job) {
  return JOB_MAP[job] || { class: 'job-support', icon: 'â—' };
}

// ì‹œê°„ ì¸ë±ìŠ¤ ê°€ì ¸ì˜¤ê¸°
function getTimeIndex(timeStr) {
  if (!timeStr || timeStr === 'ìƒê´€ì—†ìŒ') return -1;
  return TIME_ORDER.indexOf(timeStr);
}

// ì‹œê°„ ë²”ìœ„ ê³„ì‚°
function getTimeRange(startTime, endTime) {
  let startIdx = getTimeIndex(startTime);
  let endIdx = getTimeIndex(endTime);
  
  if (startIdx === -1) startIdx = 0;
  if (endIdx === -1) endIdx = TIME_ORDER.length - 1;
  if (endIdx < startIdx) endIdx = startIdx;
  
  return { startIdx, endIdx };
}

// ì‹œê°„ ë¼ë²¨ ê°€ì ¸ì˜¤ê¸°
function getTimeLabel(idx) {
  return TIME_LABELS[idx] || '';
}

// í”Œë ˆì´ì–´ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
async function loadPlayerList() {
  const container = document.getElementById('schedule-view');
  container.innerHTML = `
    <div class="loading">
      <div class="spinner">ğŸŒ™</div>
      <p style="margin-top: 16px;">ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
    </div>
  `;

  try {
    const response = await fetch(WEBHOOK_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ action: 'list' })
    });
    const result = await response.json();
    
    if (result.success && result.data) {
      allPlayers = result.data.map(player => {
        const props = player.properties || player;
        return {
          ë‹‰ë„¤ì„: props.ë‹‰ë„¤ì„?.title?.[0]?.text?.content || props.ë‹‰ë„¤ì„ || '???',
          ì§ì—…: props.ì§ì—…?.select?.name || props.ì§ì—… || '',
          ë„¤ì„ë“œ: props.ë„¤ì„ë“œ?.select?.name || props.ë„¤ì„ë“œ || '',
          ì‹œì‘ì‹œê°„: props.ì‹œì‘ì‹œê°„?.select?.name || props.ì‹œì‘ì‹œê°„ || 'ìƒê´€ì—†ìŒ',
          ì¢…ë£Œì‹œê°„: props.ì¢…ë£Œì‹œê°„?.select?.name || props.ì¢…ë£Œì‹œê°„ || 'ìƒê´€ì—†ìŒ',
          ëª»í•˜ëŠ”ìš”ì¼: props.ëª»í•˜ëŠ”ìš”ì¼?.multi_select?.map(m => m.name) || props.ëª»í•˜ëŠ”ìš”ì¼ || [],
          ë ˆì´ë“œì¢…ë¥˜: props.ë ˆì´ë“œì¢…ë¥˜?.select?.name || props.ë ˆì´ë“œì¢…ë¥˜ || 'íŠ¸ë¼ì´íŒŸ',
          ì°¸ê³ ì‚¬í•­: props.ì°¸ê³ ì‚¬í•­?.rich_text?.[0]?.text?.content || props.ì°¸ê³ ì‚¬í•­ || ''
        };
      });
      
      document.getElementById('update-time').textContent = new Date().toLocaleString('ko-KR');
      renderDayTabs();
      renderSchedule();
      renderNotes();
    } else {
      container.innerHTML = '<div class="loading">ë“±ë¡ëœ ì°¸ê°€ìê°€ ì—†ìŠµë‹ˆë‹¤</div>';
    }
  } catch (error) {
    container.innerHTML = `<div class="loading">âŒ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ${error.message}</div>`;
  }
}

// ìš”ì¼ íƒ­ ë Œë”ë§
function renderDayTabs() {
  const container = document.getElementById('day-tabs');
  
  const counts = {};
  DAYS.forEach(day => {
    counts[day] = allPlayers.filter(p => 
      p.ë ˆì´ë“œì¢…ë¥˜ === currentRaidType && 
      !p.ëª»í•˜ëŠ”ìš”ì¼.includes(day)
    ).length;
  });
  
  container.innerHTML = DAYS.map(day => `
    <div class="day-tab ${day === currentDay ? 'active' : ''}" data-day="${day}" onclick="selectDay('${day}')">
      ${day}
      <span class="count">${counts[day]}</span>
    </div>
  `).join('');
}

// ì¼ì • ë Œë”ë§
function renderSchedule() {
  const container = document.getElementById('schedule-view');
  
  const filtered = allPlayers.filter(p => 
    p.ë ˆì´ë“œì¢…ë¥˜ === currentRaidType && 
    !p.ëª»í•˜ëŠ”ìš”ì¼.includes(currentDay)
  );
  
  const nem1 = filtered.filter(p => p.ë„¤ì„ë“œ === '1ë„´');
  const nem2 = filtered.filter(p => p.ë„¤ì„ë“œ === '2ë„´');
  const nemNone = filtered.filter(p => !p.ë„¤ì„ë“œ);
  
  if (viewMode === 'block') {
    renderBlockView(container, nem1, nem2, nemNone);
  } else {
    renderTableView(container, nem1, nem2);
  }
}

// ë¸”ë¡ ë·° ë Œë”ë§ (ì¸ì›ë³„ ë¸”ë¡)
function renderBlockView(container, nem1, nem2, nemNone) {
  const renderPlayerBlock = (player) => {
    const jobInfo = getJobInfo(player.ì§ì—…);
    const { startIdx, endIdx } = getTimeRange(player.ì‹œì‘ì‹œê°„, player.ì¢…ë£Œì‹œê°„);
    const timeRange = `${getTimeLabel(startIdx)} ~ ${getTimeLabel(endIdx)}`;
    const noTime = player.ì‹œì‘ì‹œê°„ === 'ìƒê´€ì—†ìŒ' && player.ì¢…ë£Œì‹œê°„ === 'ìƒê´€ì—†ìŒ';
    
    return `
      <div class="player-block-card ${jobInfo.class}" title="${player.ì°¸ê³ ì‚¬í•­ || ''}">
        <span class="job-icon">${jobInfo.icon}</span>
        <span class="player-name">${player.ë‹‰ë„¤ì„}</span>
        <span class="player-time">${noTime ? 'ì‹œê°„ ìƒê´€ì—†ìŒ' : timeRange}</span>
      </div>
    `;
  };
  
  container.innerHTML = `
    <div class="block-view">
      <div class="block-column">
        <div class="block-column-header nem1">1ï¸âƒ£ 1ë„´ (${nem1.length}ëª…)</div>
        <div class="block-list">
          ${nem1.length > 0 ? nem1.map(renderPlayerBlock).join('') : '<div class="empty-cell">ë“±ë¡ëœ ì¸ì›ì´ ì—†ìŠµë‹ˆë‹¤</div>'}
        </div>
      </div>
      <div class="block-column">
        <div class="block-column-header nem2">2ï¸âƒ£ 2ë„´ (${nem2.length}ëª…)</div>
        <div class="block-list">
          ${nem2.length > 0 ? nem2.map(renderPlayerBlock).join('') : '<div class="empty-cell">ë“±ë¡ëœ ì¸ì›ì´ ì—†ìŠµë‹ˆë‹¤</div>'}
        </div>
      </div>
    </div>
    ${nemNone.length > 0 ? `
      <div style="margin-top: 20px; padding: 16px; background: #16213e; border-radius: 12px;">
        <div style="color: #888; margin-bottom: 12px; font-weight: 600;">âšª ë„¤ì„ë“œ ë¯¸ì • (${nemNone.length}ëª…)</div>
        <div class="players-wrap">
          ${nemNone.map(p => {
            const jobInfo = getJobInfo(p.ì§ì—…);
            return `<span class="player-chip ${jobInfo.class}"><span class="job-icon">${jobInfo.icon}</span>${p.ë‹‰ë„¤ì„}</span>`;
          }).join('')}
        </div>
      </div>
    ` : ''}
  `;
}

// í…Œì´ë¸” ë·° ë Œë”ë§ (ì‹œê°„ë³„)
function renderTableView(container, nem1, nem2) {
  // ì‹œê°„ë³„ í”Œë ˆì´ì–´ ë¶„ë¥˜
  const getPlayersAtTime = (players, timeIdx) => {
    return players.filter(p => {
      const { startIdx, endIdx } = getTimeRange(p.ì‹œì‘ì‹œê°„, p.ì¢…ë£Œì‹œê°„);
      return timeIdx >= startIdx && timeIdx <= endIdx;
    });
  };
  
  const renderPlayers = (players) => {
    if (players.length === 0) return '<span class="empty-cell">-</span>';
    return `<div class="players-wrap">${players.map(p => {
      const jobInfo = getJobInfo(p.ì§ì—…);
      const noTime = p.ì‹œì‘ì‹œê°„ === 'ìƒê´€ì—†ìŒ' && p.ì¢…ë£Œì‹œê°„ === 'ìƒê´€ì—†ìŒ';
      const noTimeClass = noTime ? 'no-time' : '';
      return `<span class="player-chip ${jobInfo.class} ${noTimeClass}" title="${p.ì°¸ê³ ì‚¬í•­ || ''}">
        <span class="job-icon">${jobInfo.icon}</span>${p.ë‹‰ë„¤ì„}
      </span>`;
    }).join('')}</div>`;
  };
  
  const rows = TIME_ORDER.map((time, idx) => {
    const nem1Players = getPlayersAtTime(nem1, idx);
    const nem2Players = getPlayersAtTime(nem2, idx);
    const total = nem1Players.length + nem2Players.length;
    
    return `
      <tr>
        <td class="time-cell">${TIME_LABELS[idx]}</td>
        <td class="players-cell">${renderPlayers(nem1Players)}</td>
        <td class="players-cell">${renderPlayers(nem2Players)}</td>
        <td class="total-cell">${total}ëª…</td>
      </tr>
    `;
  }).join('');
  
  container.innerHTML = `
    <table class="schedule-table">
      <thead>
        <tr>
          <th>ì‹œê°„</th>
          <th class="nem1">1ï¸âƒ£ 1ë„´</th>
          <th class="nem2">2ï¸âƒ£ 2ë„´</th>
          <th class="total">í•©ê³„</th>
        </tr>
      </thead>
      <tbody>
        ${rows}
      </tbody>
    </table>
  `;
}

// ì°¸ê³ ì‚¬í•­ ë Œë”ë§
function renderNotes() {
  const notes = allPlayers
    .filter(p => p.ì°¸ê³ ì‚¬í•­ && p.ë ˆì´ë“œì¢…ë¥˜ === currentRaidType)
    .map(p => ({ name: p.ë‹‰ë„¤ì„, note: p.ì°¸ê³ ì‚¬í•­ }));
  
  const container = document.getElementById('notes-section');
  
  if (notes.length > 0) {
    container.innerHTML = `
      <div class="notes">
        <h3>ğŸ“Œ ì°¸ê³  ì‚¬í•­</h3>
        ${notes.map(n => `<div class="note-item"><span class="name">${n.name}</span> â€” ${n.note}</div>`).join('')}
      </div>
    `;
  } else {
    container.innerHTML = '';
  }
}

// === ë“±ë¡ í¼ ê´€ë ¨ ===

// ìš”ì¼ ë²„íŠ¼ í† ê¸€
document.querySelectorAll('.day-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    btn.classList.toggle('selected');
  });
});

// ì„ íƒëœ ëª»í•˜ëŠ” ìš”ì¼ ê°€ì ¸ì˜¤ê¸°
function getSelectedDays() {
  const days = [];
  document.querySelectorAll('.day-btn.selected').forEach(btn => {
    days.push(btn.dataset.day);
  });
  return days;
}

// ë©”ì‹œì§€ í‘œì‹œ
function showMessage(elementId, type, text) {
  const el = document.getElementById(elementId);
  el.innerHTML = `<div class="message ${type}">${text}</div>`;
  setTimeout(() => { el.innerHTML = ''; }, 5000);
}

// ë‚´ ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸°
async function loadMyInfo() {
  const nickname = document.getElementById('nickname').value.trim();
  if (!nickname) {
    showMessage('register-message', 'error', 'ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”');
    return;
  }

  try {
    const response = await fetch(WEBHOOK_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ action: 'get', data: { ë‹‰ë„¤ì„: nickname } })
    });
    const result = await response.json();
    
    if (result.success && result.data) {
      const d = result.data;
      document.getElementById('job').value = d.ì§ì—… || '';
      document.getElementById('named').value = d.ë„¤ì„ë“œ || '';
      document.getElementById('startTime').value = d.ì‹œì‘ì‹œê°„ || 'ìƒê´€ì—†ìŒ';
      document.getElementById('endTime').value = d.ì¢…ë£Œì‹œê°„ || 'ìƒê´€ì—†ìŒ';
      document.getElementById('raidType').value = d.ë ˆì´ë“œì¢…ë¥˜ || 'íŠ¸ë¼ì´íŒŸ';
      document.getElementById('note').value = d.ì°¸ê³ ì‚¬í•­ || '';
      
      document.querySelectorAll('.day-btn').forEach(btn => {
        btn.classList.remove('selected');
        if (d.ëª»í•˜ëŠ”ìš”ì¼ && d.ëª»í•˜ëŠ”ìš”ì¼.includes(btn.dataset.day)) {
          btn.classList.add('selected');
        }
      });
      
      showMessage('register-message', 'success', 'ì •ë³´ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤');
    } else {
      showMessage('register-message', 'info', 'ë“±ë¡ëœ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤. ìƒˆë¡œ ë“±ë¡í•´ì£¼ì„¸ìš”.');
    }
  } catch (error) {
    showMessage('register-message', 'error', 'ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ' + error.message);
  }
}

// í¼ ì œì¶œ
async function submitForm() {
  const nickname = document.getElementById('nickname').value.trim();
  const job = document.getElementById('job').value;
  
  if (!nickname) {
    showMessage('register-message', 'error', 'ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”');
    return;
  }
  if (!job) {
    showMessage('register-message', 'error', 'ì§ì—…ì„ ì„ íƒí•˜ì„¸ìš”');
    return;
  }

  const data = {
    ë‹‰ë„¤ì„: nickname,
    ì§ì—…: job,
    ë„¤ì„ë“œ: document.getElementById('named').value || '',
    ì‹œì‘ì‹œê°„: document.getElementById('startTime').value,
    ì¢…ë£Œì‹œê°„: document.getElementById('endTime').value,
    ëª»í•˜ëŠ”ìš”ì¼: getSelectedDays(),
    ë ˆì´ë“œì¢…ë¥˜: document.getElementById('raidType').value,
    ì°¸ê³ ì‚¬í•­: document.getElementById('note').value || ''
  };

  const btn = document.querySelector('.submit-btn');
  btn.disabled = true;
  btn.textContent = 'ì €ì¥ ì¤‘...';

  try {
    const response = await fetch(WEBHOOK_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ action: 'register', data })
    });
    const result = await response.json();
    
    if (result.success) {
      showMessage('register-message', 'success', 'ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
    } else {
      showMessage('register-message', 'error', 'ì €ì¥ ì‹¤íŒ¨: ' + (result.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
    }
  } catch (error) {
    showMessage('register-message', 'error', 'ì €ì¥ ì‹¤íŒ¨: ' + error.message);
  } finally {
    btn.disabled = false;
    btn.textContent = 'ì €ì¥í•˜ê¸°';
  }
}

// ì´ˆê¸° ë¡œë“œ
loadPlayerList();
</script>

</body>
</html>
